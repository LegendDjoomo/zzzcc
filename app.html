<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zcriptures | Modern Bible App</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https: data:; img-src 'self' data: https:; object-src 'none';">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Favicon: use project logo.jpg so file shows app icon instead of default browser icon -->
    <link rel="icon" href="logo.jpg" type="image/jpeg">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Crimson+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="zcriptures.css">
    <script src="glossary_functions.js"></script>
    <script src="glossary_items.js"></script>
    <script src="bible_cap_items.js"></script>
    <script src="bible_cap_functions.js"></script>
    <script src="prayer_content.js"></script>
    <script src="bible_books.js"></script>
    <script src="bible_study.js"></script>
    <script src="genz_stories.js"></script>
    <script src="Fun_Facts_items.js"></script>
    <script src="daily_power.js"></script>
    <script src="daily_fact.js"></script> 
</head>
<body>
    <!-- SPLASH SCREEN -->
    <div id="splash-screen" class="splash-screen">
        <div class="splash-content">
            <img src="logo.jpg" alt="Zcriptures Logo" class="splash-logo" style="width: 150px; height: auto; margin-bottom: 1rem;">
<h1 class="splash-title">Zcriptures</h1>
            
            <div class="splash-text-container">
                <div class="splash-text" id="splash-text-1"></div>
                <div class="splash-text" id="splash-text-2"></div>
                <div class="splash-text" id="splash-text-3"></div>
                <div class="splash-text" id="splash-text-4"></div>
                <div class="splash-text" id="splash-text-5"></div>
                <div class="splash-text" id="splash-text-6"></div>
            </div>
            
            <div class="splash-loader" id="splash-loader">
                <div class="loader-bar" id="loader-bar"></div>
            </div>
        </div>
    </div>

    <!-- HEADER -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                  <img src="logo.jpg" alt="Zcriptures" style="width: 48px; height: auto; border-radius: 8px;">
<h1 class="logo-text">Zcriptures</h1>
                </div>
                <div class="header-actions">
                    <!-- Profile avatar button (click to open profile) placed next to settings -->
                    <button id="header-avatar-btn" class="btn btn-icon" onclick="showUserProfile()" title="Profile" aria-label="Open profile" style="display:flex; align-items:center; justify-content:center;">
                        <img id="header-avatar-img" src="" alt="Profile" style="width:36px; height:36px; border-radius:50%; object-fit:cover; display:block;">
                        <span id="header-avatar-fallback" style="display:none; font-size:1.1rem;">üë§</span>
                    </button>
                    <button class="btn btn-icon" onclick="showSettings()" title="Settings">‚öôÔ∏è</button>
                </div>
            </div>
        </div>
        
    </header>
<!-- Floating Highlights Button -->

    <main class="container">
        <!-- HOME SECTION -->
        <section id="home-section" class="section active">
            <!-- Greeting -->
            <div class="greeting-card">
                <h2 class="greeting-text" id="greeting-text">
                    Welcome back, <span class="user-name" id="user-name">Friend</span>! 
                </h2>
            </div>

            <!-- Daily Verse -->
            <div class="daily-verse">
                <div class="verse-reference" id="daily-verse-reference">John 3:16</div>
                <blockquote class="verse-text" id="daily-verse-text">
                    "For God so loved the world that he gave his one and only Son..."
                </blockquote>
                <div class="gen-z-translation">
                    <div class="gen-z-label">Gen Z Translation</div>
                    <div class="gen-z-text" id="daily-verse-genz">
                        God loved us so much He sent His Son - no cap, eternal life unlocked.
                    </div>
                </div>
            </div>

            <!-- Daily Power -->
            <div class="daily-power-card">
                <div class="daily-power-emoji">‚ö°</div>
                <div class="daily-power-text" id="daily-power-text">
                    God got your back, don't back down.
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="grid-2">
                <div class="card">
                    <h3 class="card-title">Daily Streak</h3>
                    <p class="card-description" style="font-size: 2rem; color: var(--accent-gold); margin: 8px 0; font-weight: 700;">
                        <span id="streak-count">0</span> days
                    </p>
                    <p class="text-muted" style="font-size: 0.875rem;">Keep it going!</p>
                </div>
                
                <div class="card">
                    <h3 class="card-title">Current Level</h3>
                    <p class="card-description" style="font-size: 2rem; color: var(--accent-gold); margin: 8px 0; font-weight: 700;">
                        Level <span id="home-level">1</span>
                    </p>
                    <button class="btn btn-secondary" onclick="showProgress()" style="font-size: 0.75rem; width: 100%; margin-top: 8px;">
                        View Progress
                    </button>
                </div>
            </div>

            <!-- Challenge Card -->
            <div class="card" id="challenge-card">
                <h3 class="card-title">Today's Challenge</h3>
                <p class="card-description">Share an encouraging Bible verse with someone who needs it today.</p>
                <button class="btn btn-primary" id="challenge-btn" onclick="completeChallenge()">
                    Start Challenge
                </button>
                <div id="challenge-complete" class="hidden">
                    <h3 class="text-accent">Congratulations, <span id="challenge-user-name"></span>! üéâ</h3>
                    <p>"Keep on leveling up, God got the receipts".</p>
                </div>
            </div>

            <!-- Did You Know Card -->
            <div class="did-you-know-card">
                <div class="did-you-know-label">DID YOU KNOW?</div>
                <div class="did-you-know-emoji" id="dyk-emoji">üìñ</div>
                <h3 class="did-you-know-title" id="dyk-title">Fun Fact</h3>
                <p class="did-you-know-content" id="dyk-content">
                    The Bible was written over approximately 1500 years by 40 different authors from various backgrounds!
                </p>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <h3 class="card-title">Bible Study</h3>
                <div style="display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));">
                    <button class="btn btn-secondary"  onclick="showBibleStudy()">Start Study ‚Üí</button>
                </div>
            </div>
                <!-- Original Words (daily) -->
                <div class="card2" id="original-words-card">
                    <h3 class="card-title">Original Words üó£Ô∏è</h3>
                    <p class="card-description" id="original-word-language">Loading‚Ä¶</p>
                    <div style="margin-top:8px;">
                        <div id="original-word-word" style="font-size:1.55rem; font-weight:700; line-height:1.1; direction:auto; text-align:center;">‚Äî</div>
                        <div id="original-word-translit" style="font-size:1rem; color:var(--text-muted); text-align:center; margin-top:6px;">‚Äî</div>
                        <p class="card-description" id="original-word-meaning" style="margin-top:10px;">Loading meaning‚Ä¶</p>
                        <div id="original-word-ref" style="font-size:0.85rem; color:var(--text-muted); margin-top:6px;"></div>
                    </div>
                </div>
        </section>

        <!-- ACTIVITIES SECTION -->
        <section id="activities-section" class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg); flex-wrap: wrap; gap: var(--space-sm);">
                <h2>Activities üéØ</h2>
            </div>

            <div style="display: grid; gap: var(--space-md); grid-template-columns: repeat(2, 1fr);">
                <!-- Row 1: Prayer & Guide -->
                <div class="card2">
                    <h3 class="card-title">Prayer Topics üôè</h3>
                    <p class="card-description">Start a focused prayer session or choose a prayer topic.</p>
                    <button class="btn btn-primary mt-lg" onclick="showSection('prayer-section')">Open Prayer ‚Üí</button>
                </div>

                <div class="card2">
                    <h3 class="card-title">Bible Guide üß≠</h3>
                    <p class="card-description">Curated guides to help you find verses and study plans.</p>
                    <button class="btn btn-primary mt-lg" onclick="showSection('bible-guide-section')">Open Guide ‚Üí</button>
                </div>

                <!-- Row 2: Bible Study & Gen Z Stories -->
                <div class="card2">
                    <h3 class="card-title">Bible Study üìñ</h3>
                    <p class="card-description">Short and sweet study topics to grow your understanding.</p>
                    <button class="btn btn-primary mt-lg" onclick="showBibleStudy()">Start Study ‚Üí</button>
                </div>
                <div class="card2">
                    <h3 class="card-title">Gen Z Stories üìö</h3>
                    <p class="card-description">Accessible paraphrases and stories in Gen Z voice.</p>
                    <button class="btn btn-primary mt-lg" onclick="showBibleStoriesModal()">Open Stories ‚Üí</button>
                </div>
                
                <div class="card2">
                    <h3 class="card-title">Notes üìù</h3>
                    <p class="card-description">Keep track of your spiritual insights and reflections.</p>
                    <button class="btn btn-primary mt-lg" onclick="showSection('notes-section')">Open Notes ‚Üí</button>
                </div>
                <div class="card2">
    <h3 class="card-title">Bible Games üéÆ</h3>
    <p class="card-description">Play fun Bible games and earn points for the leaderboard!</p>
    <button class="btn btn-primary mt-lg" onclick="showSection('games-section')">Play Games ‚Üí</button>
</div>
<div class="card2">
    <h3 class="card-title">Bible Fun Facts üéØ</h3>
    <p class="card-description">Discover amazing and surprising facts about the Bible!</p>
    <button class="btn btn-primary mt-lg" onclick="showFunFacts()">Explore Facts ‚Üí</button>
</div>
<div class="card2">
    <h3 class="card-title">Bible Glossary üìö</h3>
    <p class="card-description">Look up Bible terms, people, places, and concepts with definitions and references.</p>
    <button class="btn btn-primary mt-lg" onclick="showGlossary()">Open Glossary ‚Üí</button>
</div>
                </div>
        </section>
    
    
        <!-- NOTES SECTION (Integrated Notes App) -->
        <section id="notes-section" class="section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:var(--space-lg); flex-wrap:wrap; gap:var(--space-sm);">
                <h2>My Notes üìù</h2>
                <div style="display:flex; gap:var(--space-sm);">
                    <button class="btn btn-primary" id="notes-new-btn">+ New Note</button>
                    <button class="btn btn-secondary" onclick="showSection('activities-section')">‚Üê Back</button>
                </div>
            </div>


            <div id="notes-grid" class="notes-grid" aria-live="polite">
                <!-- notes will render here -->
            </div>

            <!-- Editor panel -->
            <div id="note-editor" class="note-editor-modal" role="dialog" aria-hidden="true">
                <div class="note-editor-header">
                    <div style="display:flex; gap:12px; align-items:center;">
                        <div style="font-weight:800; font-size:1.1rem;">Note</div>
                        <div class="autosave-indicator" id="notes-autosave">Saved</div>
                    </div>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <button class="btn btn-secondary" id="notes-delete-btn">Delete</button>
                        <button class="btn btn-secondary" id="notes-close-btn">Close</button>
                        <button class="btn btn-secondary" id="notes-exit-x" title="Close editor">‚úï</button>
                    </div>
                </div>
                <div class="note-editor-body">
                    <input id="note-title" placeholder="Title" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border); font-weight:700; margin-bottom:12px; font-size:1.1rem;" />
                    <div class="editor-toolbar">
                        <button class="btn btn-secondary" data-cmd="bold">B</button>
                        <button class="btn btn-secondary" data-cmd="italic">I</button>
                        <!-- five solid highlight color swatches -->
                        <div style="display:flex; gap:6px; margin-left:8px; align-items:center;">
                            <button type="button" class="highlight-swatch" data-color="#f6d55c" title="Sun" style="background:#f6d55c;"></button>
                            <button type="button" class="highlight-swatch" data-color="#ffa94d" title="Amber" style="background:#ffa94d;"></button>
                            <button type="button" class="highlight-swatch" data-color="#66bb6a" title="Green" style="background:#66bb6a;"></button>
                            <button type="button" class="highlight-swatch" data-color="#42a5f5" title="Blue" style="background:#42a5f5;"></button>
                            <button type="button" class="highlight-swatch" data-color="#c57ed6" title="Lavender" style="background:#c57ed6;"></button>
                        </div>
                        <div style="margin-left:auto; font-size:0.85rem; color:var(--text-muted);">Attach up to 3 verses</div>
                    </div>

                    <div id="note-content" class="editor-content" contenteditable="true" placeholder="Write your note..."></div>

                    <div class="verse-input">
                        <input id="verse-input-field" placeholder="Add verse (e.g. John 3:16)" style="flex:1; padding:8px; border-radius:8px; border:1px solid var(--border);" />
                        <button class="btn btn-primary" id="add-verse-btn">Add</button>
                    </div>

                    <div id="verse-chips" class="verse-chips" aria-live="polite"></div>

                    <!-- New: Close Editor button placed below verse controls for clarity -->
                    <div style="margin-top:12px;">
                        <button class="btn btn-danger" id="notes-close-editor-btn">Close Editor</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- LEADERBOARD SECTION (Full Page) -->
        <section id="leaderboard-section" class="section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:var(--space-lg);">
                <h2>Community Leaderboard</h2>
            </div>
            <div class="card" style="margin-top:12px;">
                <div id="leaderboard-page-container">
                    <!-- Leaderboard entries rendered here -->
                </div>
            </div>
        </section>

<!-- GAMES SECTION -->
<section id="games-section" class="section">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:var(--space-lg); flex-wrap:wrap; gap:var(--space-sm);">
        <h2>Bible Games üéÆ</h2>
        <button class="btn btn-secondary" onclick="showSection('activities-section')">‚Üê Back</button>
    </div>

    <div class="text-center mb-lg">
        <p>Play games and earn points to rise on the leaderboard! üî•</p>
        <div style="background: var(--surface); padding: 12px; border-radius: 12px; display: inline-block; margin-top: 8px;">
            <strong>Your Points:</strong> <span id="user-points-display">0</span> üèÜ
        </div>
    </div>

    <div style="display: grid; gap: var(--space-md); grid-template-columns: repeat(2, 1fr);">
        <!-- Bible Quiz -->
        <div class="card">
            <h3 class="card-title">Bible Quiz ‚ùì</h3>
            <p class="card-description">Test your Bible knowledge with multiple choice questions.</p>
            <div style="background: rgba(167, 181, 161, 0.28); border-left: 4px solid var(--accent-sage); padding: var(--space-sm); border-radius: 8px; margin: 12px 0;">
                <div style="color: var(--accent-sage); font-weight: 700; font-size: 0.875rem; margin-bottom: 4px;">High Score</div>
                <div style="font-weight: 600;" id="quiz-highscore">0 points</div>
            </div>
            <button class="btn btn-primary" onclick="startBibleQuiz()">Start Quiz ‚Üí</button>
        </div>

        <!-- Bible or Cap -->
        <div class="card">
            <h3 class="card-title">Bible or Cap? üîç</h3>
            <p class="card-description">Is it real Scripture or cap? Swipe to find out!</p>
            <div style="background: rgba(167, 181, 161, 0.28); border-left: 4px solid var(--accent-sage); padding: var(--space-sm); border-radius: 8px; margin: 12px 0;">
                <div style="color: var(--accent-sage); font-weight: 700; font-size: 0.875rem; margin-bottom: 4px;">Best Streak</div>
                <div style="font-weight: 600;" id="cap-streak">0 correct</div>
            </div>
            <button class="btn btn-primary" onclick="startBibleOrCap()">Start Game ‚Üí</button>
        </div>

        <!-- Verse Match -->
        <div class="card">
            <h3 class="card-title">Verse Match üß©</h3>
            <p class="card-description">Match Bible verses with their Gen Z translations.</p>
            <div style="background: rgba(167, 181, 161, 0.28); border-left: 4px solid var(--accent-sage); padding: var(--space-sm); border-radius: 8px; margin: 12px 0;">
                <div style="color: var(--accent-sage); font-weight: 700; font-size: 0.875rem; margin-bottom: 4px;">High Score</div>
                <div style="font-weight: 600;" id="match-highscore">0 points</div>
            </div>
            <button class="btn btn-primary" onclick="startVerseMatch()">Start Matching ‚Üí</button>
        </div>

        <!-- Bible Riddles -->
        <div class="card">
            <h3 class="card-title">Bible Riddles üé≠</h3>
            <p class="card-description">"Who am I?" Guess the Bible character from clues.</p>
            <div style="background: rgba(167, 181, 161, 0.28); border-left: 4px solid var(--accent-sage); padding: var(--space-sm); border-radius: 8px; margin: 12px 0;">
                <div style="color: var(--accent-sage); font-weight: 700; font-size: 0.875rem; margin-bottom: 4px;">Solved</div>
                <div style="font-weight: 600;" id="riddles-solved">0 riddles</div>
            </div>
            <button class="btn btn-primary" onclick="startBibleRiddles()">Solve Riddles ‚Üí</button>
        </div>
    </div>
</section>

    <!-- BIBLE SECTION -->
<section id="bible-section" class="section">
    <div id="bible-content">
        <div id="verses-container">
            <!-- John 1 will load here by default -->
        </div>
    </div>

    <!-- Floating Navigation Button -->
    <div id="bible-nav-button" class="bible-floating-nav">
        <button class="bible-nav-btn" onclick="toggleBibleSelector()">
            <span id="current-chapter-display">John 1</span>
            <span class="nav-arrow">‚ñº</span>
        </button>
    </div>
<div class="fab-container">
    <button class="fab" onclick="showHighlights()" title="My Highlights">
        <span style="font-size: 1.5rem;">‚≠ê</span>
    </button>
</div>
 <!-- Selector Overlay -->
    <div id="bible-selector-overlay" class="bible-selector-overlay hidden">
        <div class="selector-content">
            <div class="selector-header">
                <h3 id="selector-title">Select Book</h3>
                <button class="close-selector" onclick="closeBibleSelector()">‚úï</button>
            </div>
            
            <!-- Books List -->
            <div id="selector-books-list" class="selector-list">
                <!-- Books will be populated here -->
            </div>
            
            <!-- Chapters Grid -->
            <div id="selector-chapters-grid" class="selector-chapters hidden">
                <!-- Chapters will be populated here -->
            </div>
        </div>
    </div>
</section>


        <!-- PRAYER SECTION -->
        <section id="prayer-section" class="section">
            <h2 class="mb-lg">Prayer Topics üôè</h2>
            
            <div class="card">
                <h3 class="card-title">Gratitude</h3>
                <p class="card-description">Thank God for His blessings and faithfulness in your life.</p>
                <button class="btn btn-primary" onclick="startPrayer('gratitude')">Start Prayer</button>
            </div>

            <div class="card">
                <h3 class="card-title">Guidance</h3>
                <p class="card-description">Ask God for wisdom and direction in your decisions.</p>
                <button class="btn btn-primary" onclick="startPrayer('guidance')">Start Prayer</button>
            </div>

            <div class="card">
                <h3 class="card-title">Healing</h3>
                <p class="card-description">Pray for physical, emotional, or spiritual healing.</p>
                <button class="btn btn-primary" onclick="startPrayer('healing')">Start Prayer</button>
            </div>

            <div class="card">
                <h3 class="card-title">Strength</h3>
                <p class="card-description">Ask God for strength to face challenges and overcome obstacles.</p>
                <button class="btn btn-primary" onclick="startPrayer('strength')">Start Prayer</button>
            </div>

            <div class="card">
                <h3 class="card-title">Peace</h3>
                <p class="card-description">Seek God's peace in your life.</p>
                <button class="btn btn-primary" onclick="startPrayer('peace')">Start Prayer</button>
            </div>
        </section>

      
       <!-- BIBLE GUIDE SECTION -->
<section id="bible-guide-section" class="section">
    <h2 class="mb-lg">Bible Guide üß≠</h2>
    
    <div class="card">
        <h3 class="card-title">Finding Peace</h3>
        <p class="card-description">Verses to help you find peace in difficult times.</p>
        <div class="gen-z-translation">
            <div class="gen-z-label">References</div>
            <p>Philippians 4:6-7, John 14:27, Isaiah 26:3, Psalm 29:11</p>
        </div>
    </div>

    <div class="card">
        <h3 class="card-title">Overcoming Fear</h3>
        <p class="card-description">Scriptures to combat fear and anxiety.</p>
        <div class="gen-z-translation">
            <div class="gen-z-label">References</div>
            <p>2 Timothy 1:7, Psalm 34:4, Isaiah 41:10, 1 John 4:18</p>
        </div>
    </div>

    <div class="card">
        <h3 class="card-title">Finding Purpose</h3>
        <p class="card-description">Discover God's plan for your life.</p>
        <div class="gen-z-translation">
            <div class="gen-z-label">References</div>
            <p>Jeremiah 29:11, Proverbs 19:21, Ephesians 2:10, Romans 8:28</p>
        </div>
    </div>
    <div class="card">
        <h3 class="card-title">Strength in Weakness</h3>
        <p class="card-description">When you feel inadequate and need God's strength.</p>
        <div class="gen-z-translation">
            <div class="gen-z-label">References</div>
            <p>2 Corinthians 12:9-10, Isaiah 40:29-31, Philippians 4:13, Psalm 73:26</p>
        </div>
    </div>
    <div class="card">
        <h3 class="card-title">Dealing with Worry</h3>
        <p class="card-description">When anxiety keeps you up at night.</p>
        <div class="gen-z-translation">
            <div class="gen-z-label">References</div>
            <p>Matthew 6:25-34, 1 Peter 5:7, Psalm 55:22, Proverbs 3:5-6</p>
        </div>
    </div>
    <div class="card">
        <h3 class="card-title">Forgiveness & Healing</h3>
        <p class="card-description">For when you need to forgive or receive forgiveness.</p>
        <div class="gen-z-translation">
            <div class="gen-z-label">References</div>
            <p>Colossians 3:13, Matthew 6:14-15, Ephesians 4:31-32, 1 John 1:9</p>
        </div>
    </div>
    <div class="card">
        <h3 class="card-title">Financial Wisdom</h3>
        <p class="card-description">Biblical principles for money and stewardship.</p>
        <div class="gen-z-translation">
            <div class="gen-z-label">References</div>
            <p>Proverbs 3:9-10, Matthew 6:19-21, 1 Timothy 6:10, Malachi 3:10</p>
        </div>
    </div>
    <div class="card">
        <h3 class="card-title">Relationships & Love</h3>
        <p class="card-description">Guidance for healthy relationships and God's love.</p>
        <div class="gen-z-translation">
            <div class="gen-z-label">References</div>
            <p>1 Corinthians 13:4-7, 1 John 4:7-8, Ephesians 5:25, Proverbs 17:17</p>
        </div>
    </div>

    <div class="card">
        <h3 class="card-title">Spiritual Warfare</h3>
        <p class="card-description">Armor up for spiritual battles and protection.</p>
        <div class="gen-z-translation">
            <div class="gen-z-label">References</div>
            <p>Ephesians 6:10-18, James 4:7, 1 Peter 5:8-9, 2 Corinthians 10:4</p>
        </div>
    </div>

    <div class="card">
        <h3 class="card-title">Hope in Depression</h3>
        <p class="card-description">Light for dark times and emotional struggles.</p>
        <div class="gen-z-translation">
            <div class="gen-z-label">References</div>
            <p>Psalm 34:17-18, Psalm 42:11, 2 Corinthians 1:3-4, Romans 15:13</p>
        </div>
    </div>
    <div class="card">
        <h3 class="card-title">Wisdom & Decision Making</h3>
        <p class="card-description">Seeking God's guidance for important choices.</p>
        <div class="gen-z-translation">
            <div class="gen-z-label">References</div>
            <p>James 1:5, Proverbs 3:5-6, Psalm 32:8, Proverbs 16:3</p>
        </div>
    </div>
    <div class="card">
        <h3 class="card-title">Healing & Comfort</h3>
        <p class="card-description">For physical, emotional, and spiritual healing.</p>
        <div class="gen-z-translation">
            <div class="gen-z-label">References</div>
            <p>Jeremiah 17:14, Psalm 147:3, James 5:14-15, Isaiah 53:5</p>
        </div>
    </div>
    <div class="card">
        <h3 class="card-title">Faith & Doubt</h3>
        <p class="card-description">When your faith feels weak and questions arise.</p>
        <div class="gen-z-translation">
            <div class="gen-z-label">References</div>
            <p>Mark 9:24, Hebrews 11:1, 2 Corinthians 5:7, Romans 10:17</p>
        </div>
    </div>
    <div class="card">
        <h3 class="card-title">Parenting & Family</h3>
        <p class="card-description">Biblical wisdom for raising children and family life.</p>
        <div class="gen-z-translation">
            <div class="gen-z-label">References</div>
            <p>Proverbs 22:6, Deuteronomy 6:6-7, Ephesians 6:4, Psalm 127:3</p>
        </div>
    </div>
    <div class="card">
        <h3 class="card-title">Work & Vocation</h3>
        <p class="card-description">Finding purpose in your daily work and calling.</p>
        <div class="gen-z-translation">
            <div class="gen-z-label">References</div>
            <p>Colossians 3:23-24, Proverbs 16:3, Ecclesiastes 9:10, 1 Corinthians 10:31</p>
        </div>
    </div>
    <div class="card">
        <h3 class="card-title">Grief & Loss</h3>
        <p class="card-description">Comfort for times of mourning and sadness.</p>
        <div class="gen-z-translation">
            <div class="gen-z-label">References</div>
            <p>Matthew 5:4, Revelation 21:4, Psalm 34:18, 1 Thessalonians 4:13-14</p>
        </div>
    </div>

    <div class="card">
        <h3 class="card-title">Temptation & Purity</h3>
        <p class="card-description">Strength to resist temptation and live purely.</p>
        <div class="gen-z-translation">
            <div class="gen-z-label">References</div>
            <p>1 Corinthians 10:13, James 1:12-15, Matthew 26:41, 1 John 2:16</p>
        </div>
    </div>

    <div class="card">
        <h3 class="card-title">Thankfulness & Gratitude</h3>
        <p class="card-description">Cultivating a heart of gratitude in all circumstances.</p>
        <div class="gen-z-translation">
            <div class="gen-z-label">References</div>
            <p>1 Thessalonians 5:18, Psalm 100:4, Colossians 3:15-17, Philippians 4:6</p>
        </div>
    </div>

    <div class="card">
        <h3 class="card-title">Evangelism & Witness</h3>
        <p class="card-description">Sharing your faith with others effectively.</p>
        <div class="gen-z-translation">
            <div class="gen-z-label">References</div>
            <p>Matthew 28:19-20, 1 Peter 3:15, Romans 1:16, Acts 1:8</p>
        </div>
    </div>

    <div class="card">
        <h3 class="card-title">Prayer Life</h3>
        <p class="card-description">Deepening your communication with God.</p>
        <div class="gen-z-translation">
            <div class="gen-z-label">References</div>
            <p>Philippians 4:6, 1 Thessalonians 5:17, Matthew 6:9-13, Jeremiah 29:12</p>
        </div>
    </div>

    <div class="card">
        <h3 class="card-title">Waiting on God</h3>
        <p class="card-description">Trusting God's timing when answers seem delayed.</p>
        <div class="gen-z-translation">
            <div class="gen-z-label">References</div>
            <p>Isaiah 40:31, Psalm 27:14, Habakkuk 2:3, Lamentations 3:25-26</p>
        </div>
    </div>
</section>
        <!-- HIGHLIGHTS SECTION -->
        <section id="highlights-section" class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg); flex-wrap: wrap; gap: var(--space-sm);">
                <h2>Your Highlighted Verses</h2>
                <button class="btn btn-primary" onclick="showSection('bible-section')">‚Üê Back</button>
            </div>
            
            <div id="highlights-container">
                <!-- Highlighted verses will be populated here -->
            </div>
            
            <div id="no-highlights" class="card text-center hidden">
                <h3 class="card-title">No highlights yet</h3>
                <p class="card-description">Start highlighting verses as you read the Bible!</p>
                <button class="btn btn-primary" onclick="showSection('bible-section')">Read Bible</button>
            </div>
        </section>

        <!-- HISTORY HUB SECTION -->
        <section id="history-hub-section" class="section">
            <h2 class="mb-lg">History Hub üìú</h2>
            
            <p class="card-description mb-lg">Explore the rich history of our faith from biblical times through history.</p>
            
            <div class="grid-2">
                <div class="card" onclick="showSection('biblical-history-section')" style="cursor: pointer;">
                    <div style="font-size: 3rem; text-align: center; margin-bottom: var(--space-md);">üìñ</div>
                    <h3 class="card-title">Biblical History</h3>
                    <p class="card-description">From Creation to the early Church - God's story through time</p>
                    <div class="text-accent" style="margin-top: var(--space-md); font-weight: 600;">Explore ‚Üí</div>
                </div>
                
                <div class="card" onclick="showSection('church-history-section')" style="cursor: pointer;">
                    <div style="font-size: 3rem; text-align: center; margin-bottom: var(--space-md);">‚õ™</div>
                    <h3 class="card-title">Church History</h3>
                    <p class="card-description">How the Jesus movement transformed the world</p>
                    <div class="text-accent" style="margin-top: var(--space-md); font-weight: 600;">Explore ‚Üí</div>
                </div>
            <div class="card" onclick="showSection('world-history-section')" style="cursor: pointer;">
                  <div style="font-size: 3rem; text-align: center; margin-bottom: var(--space-md);">üåç</div>
                        <h3 class="card-title">World History</h3>
                        <p class="card-description">Civilizations and empires in biblical context</p>
                    <div class="text-accent" style="margin-top: var(--space-md); font-weight: 600;">Explore ‚Üí</div>
                </div>
                
                <div class="card" onclick="showSection('jesus-genealogy-section')" style="cursor: pointer;">
                   <div style="font-size: 3rem; text-align: center; margin-bottom: var(--space-md);">üå≥</div>
                        <h3 class="card-title">Jesus' Genealogy</h3>
                        <p class="card-description">The family tree of the Messiah</p>
                    <div class="text-accent" style="margin-top: var(--space-md); font-weight: 600;">Explore ‚Üí</div>
                </div>
                                <div class="card" onclick="showSection('ancient-history-section')" style="cursor: pointer;">
                   <div style="font-size: 3rem; text-align: center; margin-bottom: var(--space-md);">üåç</div>
                        <h3 class="card-title">Ancient Near East History</h3>
                        <p class="card-description">The major empires and cultures that surrounded and interacted with Israel</p>
                    <div class="text-accent" style="margin-top: var(--space-md); font-weight: 600;">Explore ‚Üí</div>
                </div>
                               <div class="card" onclick="showSection('intertestamental-period-section')" style="cursor: pointer;">
                   <div style="font-size: 3rem; text-align: center; margin-bottom: var(--space-md);">‚è≥</div>
                        <h3 class="card-title">The Intertestamental Period </h3>
                        <p class="card-description">The history between the last writings of the Old Testament (Malachi) and the events of the New Testament (the Gospels)</p>
                    <div class="text-accent" style="margin-top: var(--space-md); font-weight: 600;">Explore ‚Üí</div>
                </div>
                <div class="card" onclick="showSection('second-temple-history-section')" style="cursor: pointer;">
                   <div style="font-size: 3rem; text-align: center; margin-bottom: var(--space-md);">üèõÔ∏è</div>
                        <h3 class="card-title">The History of the Second Temple </h3>
                        <p class="card-description">A focused timeline of the Temple in Jerusalem from its rebuilding after the exile (c. 516 BC) to its destruction by the Romans in 70 AD.</p>
                    <div class="text-accent" style="margin-top: var(--space-md); font-weight: 600;">Explore ‚Üí</div>
                </div>
              <div class="card" onclick="showSection('roman-world-section')" style="cursor: pointer;">
                   <div style="font-size: 3rem; text-align: center; margin-bottom: var(--space-md);">‚è≥</div>
                        <h3 class="card-title">The Roman World of the New Testament </h3>
                        <p class="card-description">The Roman World of the New Testament encompassed Rome‚Äôs political, social, and cultural dominance, providing context for Jesus‚Äô ministry and the apostles‚Äô activities.</p>
                    <div class="text-accent" style="margin-top: var(--space-md); font-weight: 600;">Explore ‚Üí</div>
                </div>
            </div>
        </section>

<section id="roman-world-section" class="section"> 
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg); flex-wrap: wrap; gap: var(--space-sm);"> 
        <h2>The Roman World of the New Testament üèõÔ∏è</h2> 
        <button class="btn btn-secondary" onclick="showSection('history-hub-section')">‚Üê Back</button> </div>
        <div class="card">
    <div class="timeline-period">27 BC ‚Äì 14 AD</div>
    <h3 class="card-title">Augustus & the Pax Romana</h3>
    <p class="card-description">
        Caesar Augustus establishes the Roman Empire, ending the civil wars and beginning the "Pax Romana" (Roman Peace). 
        This period of stability enables safe travel across the Mediterranean world. The census ordered by Augustus brings 
        Joseph and Mary to Bethlehem, fulfilling prophecy about Jesus' birthplace.
    </p>
    <div class="scripture-reference">Luke 2:1-7, Daniel 9:25</div>
</div>

<div class="card">
    <div class="timeline-period">14‚Äì37 AD</div>
    <h3 class="card-title">Tiberius & Jesus' Ministry</h3>
    <p class="card-description">
        Tiberius rules during Jesus' adult ministry and crucifixion. Pontius Pilate serves as prefect of Judea (26-36 AD), 
        known for his harsh rule and insensitivity to Jewish customs. The Roman military presence is evident throughout 
        the Gospels, with centurions representing Roman authority and occasionally showing remarkable faith.
    </p>
    <div class="scripture-reference">Luke 3:1, Matthew 27:11-26, Luke 7:1-10</div>
</div>

<div class="card">
    <div class="timeline-period">Roman Administration</div>
    <h3 class="card-title">Provinces & Governance</h3>
    <p class="card-description">
        The empire is divided into senatorial and imperial provinces. Judea is an imperial province governed by prefects/procurators 
        appointed by the emperor. Client kings like Herod Antipas rule Galilee and Perea. Roman law, taxes, and military control 
        shape daily life, while local authorities handle religious matters and minor disputes.
    </p>
    <div class="scripture-reference">Matthew 22:15-22, John 18:28-32</div>
</div>

<div class="card">
    <div class="timeline-period">Military Presence</div>
    <h3 class="card-title">Roman Legions & Occupation</h3>
    <p class="card-description">
        Roman legions and auxiliary forces maintain order throughout the empire. In Judea, cohorts are stationed in Jerusalem 
        at the Fortress Antonia overlooking the Temple. Centurions lead 80-100 soldiers and represent the professional military 
        class. Roman citizenship offers legal protections and status, as seen with Paul's appeals to his rights.
    </p>
    <div class="scripture-reference">Acts 10:1, 22:25-29, 27:1-3</div>
</div>

<div class="card">
    <div class="timeline-period">Infrastructure</div>
    <h3 class="card-title">Roads & Sea Travel</h3>
    <p class="card-description">
        Rome's extensive road network enables unprecedented travel and communication. Well-maintained roads connect major cities, 
        while sea lanes cross the Mediterranean. This infrastructure allows for the rapid spread of the gospel as Paul and other 
        missionaries travel thousands of miles planting churches throughout the empire.
    </p>
    <div class="scripture-reference">Acts 13-28, Romans 15:19</div>
</div>

<div class="card">
    <div class="timeline-period">Legal System</div>
    <h3 class="card-title">Roman Law & Citizenship</h3>
    <p class="card-description">
        Roman law provides structure and order across diverse cultures. Citizens like Paul have rights to fair treatment and appeal 
        to Caesar. Trials follow specific procedures, and Roman officials often try to avoid involvement in local religious disputes. 
        The legal system both persecutes and protects early Christians at different times.
    </p>
    <div class="scripture-reference">Acts 16:35-39, 22:25-29, 25:10-12</div>
</div>

<div class="card">
    <div class="timeline-period">Social Structure</div>
    <h3 class="card-title">Class & Slavery</h3>
    <p class="card-description">
        Roman society is highly stratified with emperors, senators, equestrians, citizens, freedmen, and slaves. Slavery is widespread 
        but not always permanent. The gospel crosses social boundaries, reaching slaves, soldiers, merchants, and officials. Early 
        churches include people from all social levels worshipping together.
    </p>
    <div class="scripture-reference">Philemon, 1 Corinthians 1:26-29, Colossians 3:22-4:1</div>
</div>

<div class="card">
    <div class="timeline-period">54‚Äì68 AD</div>
    <h3 class="card-title">Nero & Christian Persecution</h3>
    <p class="card-description">
        Nero's reign sees the first imperial persecution of Christians after the Great Fire of Rome in 64 AD. Christians are scapegoated 
        and executed brutally. Both Peter and Paul are traditionally believed martyred under Nero. This persecution foreshadows future 
conflicts between the empire and the growing Christian movement.
    </p>
    <div class="scripture-reference">1 Peter 4:12-16, 2 Timothy 4:6-8</div>
</div>

<div class="card">
    <div class="timeline-period">70 AD</div>
    <h3 class="card-title">Destruction of Jerusalem</h3>
    <p class="card-description">
        After the Jewish revolt, future emperor Titus leads four legions to crush the rebellion. Jerusalem is besieged and destroyed, 
        including the Second Temple. This catastrophic event fulfills Jesus' prophecy and dramatically alters both Judaism and early 
        Christianity, scattering believers throughout the empire and ending Temple-based worship.
    </p>
    <div class="scripture-reference">Matthew 24:1-2, Luke 21:20-24</div>
</div>

<div class="card">
    <div class="timeline-period">Cultural Context</div>
    <h3 class="card-title">Greco-Roman Religion & Philosophy</h3>
    <p class="card-description">
        The Roman world blends Greek philosophy with Roman practicality and emperor worship. Stoicism and Epicureanism influence educated 
        classes. Mystery religions promise salvation, and emperor cults demand political loyalty. The gospel enters this world as a 
        radical alternative‚Äîa crucified Messiah challenging all other loyalties and offering resurrection hope.
    </p>
    <div class="scripture-reference">Acts 17:16-34, 1 Corinthians 1:18-25</div>
</div>
</section>


        <!-- SECOND TEMPLE HISTORY SECTION -->
        <section id="second-temple-history-section" class="section"> 
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg); flex-wrap: wrap; gap: var(--space-sm);"> 
                <h2>The History of the Second Temple üèõÔ∏è</h2> 
                <button class="btn btn-secondary" onclick="showSection('history-hub-section')">‚Üê Back</button> </div>
                <div class="card">
    <div class="timeline-period">538‚Äì515 BC</div>
    <h3 class="card-title">The Return & Foundation</h3>
    <p class="card-description">
        After Cyrus the Great's decree allowing Jewish exiles to return, Zerubbabel leads the first group back to Jerusalem. 
        Despite opposition from local Samaritans and economic challenges, the foundation of the Second Temple is laid. 
        The project stalls for years until prophets Haggai and Zechariah inspire its completion in 515 BC.
    </p>
    <div class="scripture-reference">Ezra 1-6, Haggai 1-2, Zechariah 4</div>
</div>
<div class="card">
    <div class="timeline-period">515‚Äì332 BC</div>
    <h3 class="card-title">Persian Period Temple</h3>
    <p class="card-description">
        The Second Temple serves as the religious center under Persian rule, though it is modest compared to Solomon's Temple. 
        The High Priest becomes the primary Jewish leader. Ezra the scribe reforms Jewish religious life, establishing Torah 
        reading as central to worship. Nehemiah rebuilds Jerusalem's walls, securing the city around the Temple.
    </p>
    <div class="scripture-reference">Ezra 7-10, Nehemiah 8-13</div>
</div>

<div class="card">
    <div class="timeline-period">332‚Äì167 BC</div>
    <h3 class="card-title">Hellenistic Influence</h3>
    <p class="card-description">
        Under Greek rule, the Temple faces cultural challenges as Hellenism spreads. The Septuagint translation begins in Alexandria. 
        While some Jews embrace Greek culture, traditionalists resist. The Temple remains the center of Jewish identity, but tension 
        grows between Hellenized Jews and those committed to traditional practices.
    </p>
    <div class="scripture-reference">1 Maccabees 1:11-15</div>
</div>

<div class="card">
    <div class="timeline-period">167‚Äì164 BC</div>
    <h3 class="card-title">Desecration & Rededication</h3>
    <p class="card-description">
        Seleucid king Antiochus IV Epiphanes desecrates the Temple, erecting an altar to Zeus and sacrificing swine. 
        This "Abomination of Desolation" sparks the Maccabean Revolt. After three years of fighting, Judas Maccabeus 
        recaptures Jerusalem and rededicates the Temple, establishing the festival of Hanukkah.
    </p>
    <div class="scripture-reference">1 Maccabees 4:36-59, Daniel 11:31</div>
</div>

<div class="card">
    <div class="timeline-period">164‚Äì63 BC</div>
    <h3 class="card-title">Hasmonean Temple</h3>
    <p class="card-description">
        Under Hasmonean rule, the Temple becomes the center of an independent Jewish state. The Hasmonean kings serve as both 
        political rulers and high priests, though this combination is controversial. Temple rituals are restored and expanded, 
        but political corruption and internal conflicts weaken the institution's spiritual authority.
    </p>
    <div class="scripture-reference">1 Maccabees 10:18-21, 14:41-49</div>
</div>

<div class="card">
    <div class="timeline-period">20 BC ‚Äì 64 AD</div>
    <h3 class="card-title">Herod's Renovation</h3>
    <p class="card-description">
        Herod the Great launches a massive expansion and renovation of the Temple, creating one of the ancient world's most magnificent structures. 
        The Temple Mount platform is dramatically enlarged using massive stones. Construction continues for decades, providing work for thousands 
        and creating the Temple Jesus knew during his ministry.
    </p>
    <div class="scripture-reference">John 2:20, Matthew 24:1-2</div>
</div>

<div class="card">
    <div class="timeline-period">1st Century AD</div>
    <h3 class="card-title">Jesus & the Temple</h3>
    <p class="card-description">
        The Temple is central to Jesus' life and ministry‚Äîpresented there as an infant, teaching in its courts, and cleansing it of merchants. 
        He predicts its destruction and describes himself as greater than the Temple. The veil tearing at his crucifixion symbolizes access to 
        God no longer limited to the Temple structure.
    </p>
    <div class="scripture-reference">Luke 2:22-38, Matthew 21:12-13, John 2:19-21</div>
</div>

<div class="card">
    <div class="timeline-period">66‚Äì70 AD</div>
    <h3 class="card-title">The Great Revolt & Destruction</h3>
    <p class="card-description">
        Jewish rebellion against Rome leads to the devastating First Jewish-Roman War. After a brutal siege of Jerusalem, 
        Roman legions under Titus breach the city walls and destroy the Temple in 70 AD. The burning of the Temple and 
        destruction of Jerusalem marks the end of sacrificial worship and begins the Jewish diaspora.
    </p>
    <div class="scripture-reference">Matthew 24:1-2, Luke 19:41-44</div>
</div>

<div class="card">
    <div class="timeline-period">Aftermath</div>
    <h3 class="card-title">Legacy & Influence</h3>
    <p class="card-description">
        The Temple's destruction transforms Judaism, shifting focus from sacrifice to prayer, Torah study, and synagogue worship. 
        Early Christianity interprets the destruction as divine judgment and fulfillment of Jesus' prophecy. The Temple's memory 
        remains central to Jewish identity and eschatological hope for restoration.
    </p>
    <div class="scripture-reference">Hebrews 8-10, Revelation 21:22</div>
</div>
        </section>

<!-- INTERTESTAMENTAL PERIOD SECTION -->
        <section id="intertestamental-period-section" class="section"> 
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg); flex-wrap: wrap; gap: var(--space-sm);"> 
            <h2>The Intertestamental Period ‚è≥</h2> 
        <button class="btn btn-secondary" onclick="showSection('history-hub-section')">‚Üê Back</button> </div>
        <div class="card">
    <div class="timeline-period">539‚Äì332 BC</div>
    <h3 class="card-title">Persian Rule & Return from Exile</h3>
    <p class="card-description">
        After Cyrus the Great's decree, Jewish exiles return to Jerusalem and rebuild the Temple. 
        The Persian Empire allows relative religious freedom. Jewish leadership is divided between 
        the High Priest and governor. The Torah becomes central to Jewish identity, and synagogues 
        begin to emerge as local centers of worship.
    </p>
    <div class="scripture-reference">Ezra, Nehemiah, Esther</div>
</div>

<div class="card">
    <div class="timeline-period">332‚Äì167 BC</div>
    <h3 class="card-title">Hellenistic Period & Greek Influence</h3>
    <p class="card-description">
        Alexander the Great conquers the Persian Empire, spreading Greek culture (Hellenism) 
        throughout the known world. After his death, Judea falls under Ptolemaic then Seleucid 
        control. Greek becomes the common language, cities are Hellenized, and Jewish literature 
        like the Septuagint (Greek translation of Hebrew Scriptures) is produced.
    </p>
    <div class="scripture-reference">1 Maccabees, Josephus</div>
</div>

<div class="card">
    <div class="timeline-period">167‚Äì160 BC</div>
    <h3 class="card-title">The Maccabean Revolt</h3>
    <p class="card-description">
        Seleucid king Antiochus IV Epiphanes desecrates the Temple and outlaws Jewish practices, 
        sparking the Maccabean Revolt led by Judas Maccabeus and his family. After successful 
        guerrilla warfare, the Jews recapture and rededicate the Temple, establishing the 
        Hasmonean dynasty and achieving brief political independence.
    </p>
    <div class="scripture-reference">1 Maccabees, 2 Maccabees</div>
</div>

<div class="card">
    <div class="timeline-period">160‚Äì63 BC</div>
    <h3 class="card-title">Hasmonean Dynasty</h3>
    <p class="card-description">
        The Jewish Hasmonean family rules an independent Judea, expanding territory and combining 
        the roles of king and high priest. Internal conflicts emerge between religious parties 
        (Pharisees, Sadducees, Essenes). Greek cultural influence continues despite political 
        independence, creating tension between Hellenizers and traditionalists.
    </p>
    <div class="scripture-reference">1 Maccabees, Josephus' Antiquities</div>
</div>

<div class="card">
    <div class="timeline-period">63‚Äì37 BC</div>
    <h3 class="card-title">Roman Conquest & Herod's Rise</h3>
    <p class="card-description">
        Pompey conquers Jerusalem, ending Jewish independence and making Judea a client state of Rome. 
        Political instability and civil war follow as various Hasmonean claimants compete for power. 
        Herod the Great, an Idumean, gains Roman favor and is appointed King of Judea, beginning his 
        ruthless consolidation of power.
    </p>
    <div class="scripture-reference">Josephus' Jewish War</div>
</div>

<div class="card">
    <div class="timeline-period">37‚Äì4 BC</div>
    <h3 class="card-title">Herod the Great's Reign</h3>
    <p class="card-description">
        Herod rules as a client king under Roman authority, known for massive building projects 
        including the expansion of the Second Temple. Though politically effective, he is despised 
        by many Jews for his cruelty and foreign origins. His reign creates the political and 
        religious landscape into which Jesus would be born.
    </p>
    <div class="scripture-reference">Matthew 2, Luke 1:5, Josephus</div>
</div>

<div class="card">
    <div class="timeline-period">4 BC ‚Äì 6 AD</div>
    <h3 class="card-title">Herod's Successors & Roman Prefects</h3>
    <p class="card-description">
        After Herod's death, his kingdom is divided among his sons (Archelaus, Antipas, Philip). 
        Poor rulership leads to Roman intervention and the establishment of direct Roman rule 
        through prefects in Judea. Growing messianic expectations and resistance movements 
        develop in response to foreign domination.
    </p>
    <div class="scripture-reference">Matthew 2:22, Luke 3:1</div>
</div>

<div class="card">
    <div class="timeline-period">Key Developments</div>
    <h3 class="card-title">Religious & Cultural Changes</h3>
    <p class="card-description">
        This period sees the rise of synagogues as local worship centers, development of Jewish 
        parties (Pharisees emphasizing oral law, Sadducees controlling Temple, Essenes awaiting 
        apocalypse), composition of apocalyptic literature, and the concept of resurrection 
        gaining prominence. Greek becomes the common language of the Eastern Mediterranean.
    </p>
    <div class="scripture-reference">Dead Sea Scrolls, Apocrypha</div>
</div>
        </section>


      <!-- ANCIENT NEAR EAST HISTORY SECTION -->
        <section id="ancient-history-section" class="section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg); flex-wrap: wrap; gap: var(--space-sm);">
        <h2>Ancient Near East History üåç</h2>
        <button class="btn btn-secondary" onclick="showSection('history-hub-section')">‚Üê Back</button>
    </div>        

    <div class="card">
        <div class="timeline-period">3500‚Äì2334 BC</div>
        <h3 class="card-title">Early Mesopotamia</h3>
        <p class="card-description">
            City-states like Uruk and Ur emerge in Sumer, introducing writing (cuneiform), advanced irrigation, and monumental architecture. Kings rule as intermediaries between gods and people.
            Polytheism dominates, and trade expands across the Fertile Crescent, laying foundations for later empires.
        </p>
        <div class="scripture-reference">Archaeological Records, Sumerian King List</div>
    </div>

    <div class="card">
        <div class="timeline-period">2334‚Äì2154 BC</div>
        <h3 class="card-title">Akkadian Empire</h3>
        <p class="card-description">
            Sargon of Akkad unites Sumer and Akkad, creating one of the first empires in history. Military conquest spreads Akkadian language and culture.
            Trade flourishes, but overextension and invasions eventually lead to collapse, giving way to city-state revival.
        </p>
        <div class="scripture-reference">Sumerian and Akkadian Inscriptions</div>
    </div>

    <div class="card">
        <div class="timeline-period">2100‚Äì1600 BC</div>
        <h3 class="card-title">Old Babylonian Period</h3>
        <p class="card-description">
            Babylon rises under Hammurabi, who codifies laws emphasizing justice and social order. Agriculture, trade, and literature thrive.
            Amorite influence spreads, and regional kingdoms compete for dominance, setting the stage for later Mesopotamian empires.
        </p>
        <div class="scripture-reference">Hammurabi‚Äôs Code, Babylonian Chronicles</div>
    </div>

    <div class="card">
        <div class="timeline-period">1600‚Äì1200 BC</div>
        <h3 class="card-title">Late Bronze Age ‚Äì Egypt and Hittites</h3>
        <p class="card-description">
            Egypt reaches its New Kingdom peak under pharaohs like Thutmose III and Ramses II, while the Hittites dominate Anatolia.
            Trade and diplomacy flourish; conflicts like the Battle of Kadesh showcase early international relations.
            Writing, religion, and monumental architecture leave lasting legacies.
        </p>
        <div class="scripture-reference">Egyptian Hieroglyphs, Hittite Records</div>
    </div>

    <div class="card">
        <div class="timeline-period">1200‚Äì900 BC</div>
        <h3 class="card-title">Iron Age and Sea Peoples</h3>
        <p class="card-description">
            Collapse of Bronze Age civilizations occurs due to invasions and internal turmoil. Sea Peoples disrupt Mediterranean trade networks.
            New kingdoms rise in Assyria and Israel. Iron technology spreads, reshaping warfare and economy.
            Cultural continuity survives through city-states and traditions despite chaos.
        </p>
        <div class="scripture-reference">Assyrian Annals, Biblical References</div>
    </div>

    <div class="card">
        <div class="timeline-period">900‚Äì612 BC</div>
        <h3 class="card-title">Neo-Assyrian Empire</h3>
        <p class="card-description">
            Assyria conquers the Near East with brutal efficiency, centralizing power and infrastructure. Capital cities like Nineveh flourish.
            Deportations and military dominance maintain control, but internal strife and coalitions eventually topple the empire.
            Mesopotamian culture, literature, and administration influence neighboring regions.
        </p>
        <div class="scripture-reference">Assyrian Royal Inscriptions, Biblical Accounts</div>
    </div>

    <div class="card">
        <div class="timeline-period">612‚Äì539 BC</div>
        <h3 class="card-title">Neo-Babylonian Empire</h3>
        <p class="card-description">
            Babylon rises again under Nebuchadnezzar II, expanding power and building iconic structures like the Hanging Gardens.
            The empire dominates Judah, leading to the Babylonian exile. Astronomical and mathematical advancements mark this period.
        </p>
        <div class="scripture-reference">Babylonian Chronicles, Biblical Prophecies</div>
    </div>

    <div class="card">
        <div class="timeline-period">539‚Äì331 BC</div>
        <h3 class="card-title">Persian Empire</h3>
        <p class="card-description">
            Cyrus the Great conquers Babylon, founding the Achaemenid Empire. Policies of tolerance allow local cultures and religions to flourish.
            Infrastructure, administration, and trade networks unite vast territories. Zoroastrianism and Persian governance influence the region for centuries.
        </p>
        <div class="scripture-reference">Persian Inscriptions, Biblical Accounts</div>
    </div>

    <div class="card">
        <div class="timeline-period">331‚Äì63 BC</div>
        <h3 class="card-title">Hellenistic Period</h3>
        <p class="card-description">
            Alexander the Great defeats Persia, spreading Greek culture and language across the Near East.
            Successor kingdoms (Seleucid, Ptolemaic) control the region, blending Hellenistic and local traditions.
            Science, philosophy, and urban development flourish, creating a culturally diverse landscape.
        </p>
        <div class="scripture-reference">Hellenistic Histories, Archaeological Records</div>
    </div>

    <div class="card">
        <div class="timeline-period">63 BC ‚Äì 1 AD</div>
        <h3 class="card-title">Roman Influence</h3>
        <p class="card-description">
            Rome asserts control over the Levant, incorporating client kings and provinces. Political structures stabilize trade and security.
            Jewish kingdoms experience tensions under Roman oversight, setting the stage for the emergence of Christianity.
            Cultural and religious diversity thrives under imperial administration.
        </p>
        <div class="scripture-reference">Roman Records, Biblical Accounts</div>
    </div>
</section>

        <!-- BIBLICAL HISTORY SECTION -->
        <section id="biblical-history-section" class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg); flex-wrap: wrap; gap: var(--space-sm);">
                <h2>Biblical History üìñ</h2>
                <button class="btn btn-secondary" onclick="showSection('history-hub-section')">‚Üê Back</button>
            </div>        
            <div class="card">
  <div class="timeline-period">Creation ‚Äì 1800 BC</div>
  <h3 class="card-title">Creation to Patriarchs</h3>
  <p class="card-description">
    God creates the heavens and the earth, forming humanity in His image. The fall of man through Adam and Eve introduces sin and death into the world.
    Humanity spirals into wickedness leading to the Flood, after which Noah‚Äôs descendants repopulate the earth. The Tower of Babel results in the confusion of languages and dispersion of nations.
    God‚Äôs redemptive plan begins to unfold as He calls Abram to be the father of a chosen people.
  </p>
  <div class="scripture-reference">Genesis 1‚Äì11</div>
</div>

<div class="card">
  <div class="timeline-period">1800‚Äì1400 BC</div>
  <h3 class="card-title">Patriarchs and Egypt</h3>
  <p class="card-description">
    God establishes His covenant with Abraham, promising descendants, land, and blessing to all nations through his seed.
    Isaac and Jacob (Israel) continue the covenant line, and Joseph‚Äôs rise in Egypt preserves the family during famine.
    The Hebrew people grow into a large nation within Egypt, setting the stage for deliverance.
  </p>
  <div class="scripture-reference">Genesis 12‚Äì50</div>
</div>

<div class="card">
  <div class="timeline-period">1400‚Äì1380 BC</div>
  <h3 class="card-title">Exodus and Law</h3>
  <p class="card-description">
    God raises Moses to deliver Israel from slavery through mighty acts of judgment on Egypt.
    At Mount Sinai, God gives Israel the Law, forming them into a covenant nation. Despite rebellion, God sustains them for 40 years in the wilderness and prepares them for the Promised Land.
  </p>
  <div class="scripture-reference">Exodus, Leviticus, Numbers, Deuteronomy</div>
</div>

<div class="card">
  <div class="timeline-period">1380‚Äì1050 BC</div>
  <h3 class="card-title">Conquest and Judges</h3>
  <p class="card-description">
    Under Joshua, Israel conquers and settles Canaan. After his death, the nation falls into cycles of sin, oppression, repentance, and deliverance during the time of the Judges.
    Figures like Deborah, Gideon, and Samson show God‚Äôs mercy despite Israel‚Äôs repeated failures.
  </p>
  <div class="scripture-reference">Joshua, Judges, Ruth</div>
</div>

<div class="card">
  <div class="timeline-period">1050‚Äì930 BC</div>
  <h3 class="card-title">United Kingdom</h3>
  <p class="card-description">
    Israel transitions from tribal rule to monarchy. Saul becomes the first king but fails spiritually.
    David rises as a man after God‚Äôs heart, establishing Jerusalem as the capital and uniting the nation.
    Solomon builds the temple and brings prosperity but later falls into idolatry, sowing division for the future.
  </p>
  <div class="scripture-reference">1 & 2 Samuel, 1 Kings 1‚Äì11, 1 Chronicles, 2 Chronicles 1‚Äì9</div>
</div>

<div class="card">
  <div class="timeline-period">930‚Äì538 BC</div>
  <h3 class="card-title">Divided Kingdom and Exile</h3>
  <p class="card-description">
    After Solomon, the kingdom splits into Israel (north) and Judah (south). Both fall into idolatry and injustice.
    Prophets like Elijah, Isaiah, Jeremiah, and Amos call for repentance. Assyria conquers Israel (722 BC), and Babylon exiles Judah (586 BC).
    The temple is destroyed, marking one of Israel‚Äôs darkest eras.
  </p>
  <div class="scripture-reference">1 Kings 12‚Äì22, 2 Kings, 2 Chronicles 10‚Äì36, Major & Minor Prophets</div>
</div>

<div class="card">
  <div class="timeline-period">538‚Äì400 BC</div>
  <h3 class="card-title">Return and Restoration</h3>
  <p class="card-description">
    After 70 years of exile, Persia allows the Jews to return. Under Zerubbabel, Ezra, and Nehemiah, they rebuild the temple and Jerusalem‚Äôs walls.
    Prophets Haggai, Zechariah, and Malachi encourage faithfulness. The Old Testament closes with anticipation of the coming Messiah.
  </p>
  <div class="scripture-reference">Ezra, Nehemiah, Esther, Haggai, Zechariah, Malachi</div>
</div>

<div class="card">
  <div class="timeline-period">6 BC ‚Äì 30 AD</div>
  <h3 class="card-title">Life of Jesus</h3>
  <p class="card-description">
    The promised Messiah is born in Bethlehem. Jesus of Nazareth fulfills prophecy through His sinless life, miracles, and teachings.
    He is crucified under Roman rule, bearing the sins of humanity, and rises on the third day, conquering death.
    His resurrection marks the turning point of history.
  </p>
  <div class="scripture-reference">Matthew, Mark, Luke, John</div>
</div>

<div class="card">
  <div class="timeline-period">30‚Äì100 AD</div>
  <h3 class="card-title">Early Church</h3>
  <p class="card-description">
    The Holy Spirit descends at Pentecost, empowering the apostles to spread the gospel across the Roman Empire.
    Paul‚Äôs missionary journeys expand the church among Gentiles. Persecution intensifies, yet Christianity grows rapidly.
    The New Testament writings are completed, sealing God‚Äôs revelation for the church.
  </p>
  <div class="scripture-reference">Acts, Epistles, Revelation</div>
</div>
        </section>

        <!-- CHURCH HISTORY SECTION -->
        <section id="church-history-section" class="section">
               <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg); flex-wrap: wrap; gap: var(--space-sm);">
                <h2>Church History ‚õ™</h2>
                <button class="btn btn-secondary" onclick="showSection('history-hub-section')">‚Üê Back</button>
            </div>        
            
<div class="card">
  <div class="timeline-period">33 ‚Äì 313 AD</div>
  <h3 class="card-title">The Underground Revolution</h3>
  <p class="card-description">
    Christianity began in Jerusalem with a small, Spirit-filled community (Acts 2). 
    Empowered by Pentecost, they spread the gospel across the Roman Empire, despite being outlawed.  
    Believers met in secret, often in catacombs, preaching resurrection in a world of Caesar worship.  
    Persecution under emperors like Nero, Domitian, and Diocletian turned many believers into martyrs ‚Äî 
    but their blood became the seed of the Church.  
    Despite torture, imprisonment, and execution, the message of Christ kept spreading through love, courage, and miracles.  
    By 300 AD, Christianity had reached every major city in the empire ‚Äî proving that no empire can silence the truth of the resurrection.
  </p>
  <div class="scripture-reference">Acts 2:42‚Äì47; Acts 4:32‚Äì35</div>
</div>

<div class="card">
  <div class="timeline-period">313 ‚Äì 500 AD</div>
  <h3 class="card-title">Truth or Consequences</h3>
  <p class="card-description">
    With Emperor Constantine‚Äôs Edict of Milan (313 AD), Christianity became legal ‚Äî a radical shift from persecution to protection.  
    The Church moved from hiding to influencing, shaping laws, art, and philosophy.  
    But new challenges arose: heresies like Arianism and Gnosticism threatened the faith‚Äôs core truths.  
    The Church responded with ecumenical councils ‚Äî Nicaea (325), Constantinople (381), and Chalcedon (451) ‚Äî 
    defining doctrines like the Trinity and the full divinity and humanity of Christ.  
    Christianity became the empire‚Äôs official religion under Theodosius (380 AD), 
    transforming the Roman world forever.  
    The Church learned that freedom without truth is chaos, but truth with courage builds kingdoms.
  </p>
</div>

<div class="card">
  <div class="timeline-period">500 ‚Äì 1500 AD</div>
  <h3 class="card-title">Light in the Darkness</h3>
  <p class="card-description">
    After Rome‚Äôs fall, Europe plunged into instability ‚Äî but the Church became the anchor.  
    Monks and nuns preserved Scripture and classical knowledge in monasteries, copying manuscripts by candlelight.  
    Missionaries like Patrick, Boniface, and Augustine of Canterbury carried the gospel into pagan Europe.  
    The Eastern Church thrived in Byzantium, while Western Christendom faced corruption, political entanglement, and moral decay.  
    Crusades and inquisitions marked the Church‚Äôs struggle between faith and power.  
    Yet even through the darkest centuries, light broke through ‚Äî in reform movements, mystical writings, and quiet acts of devotion.  
    God‚Äôs truth stayed alive through ordinary people who refused to let the flame die.
  </p>
</div>

<div class="card">
  <div class="timeline-period">1500 ‚Äì 1650 AD</div>
  <h3 class="card-title">The Great Reformation</h3>
  <p class="card-description">
    After centuries of spiritual compromise, a spark ignited in Wittenberg.  
    In 1517, Martin Luther‚Äôs 95 Theses called out the corruption of indulgences and returned the Church to Scripture‚Äôs authority.  
    Reformers like Calvin, Zwingli, and Tyndale championed salvation by grace through faith ‚Äî not works or hierarchy.  
    The Protestant Reformation reshaped Europe, birthing new denominations and reviving biblical preaching.  
    The Catholic Church responded with the Counter-Reformation, reforms from within, and global missionary expansion.  
    The printing press spread Bibles in local languages, empowering believers to read the Word for themselves.  
    This was more than a movement ‚Äî it was a spiritual revolution that redefined the meaning of ‚Äúchurch‚Äù for generations.
  </p>
</div>

<div class="card">
  <div class="timeline-period">1650 ‚Äì Present</div>
  <h3 class="card-title">Global Fire</h3>
  <p class="card-description">
    Out of Europe‚Äôs wars and reform came a new age of global Christianity.  
    Missionary societies rose in England, America, and beyond, spreading the gospel to Africa, Asia, and the Americas.  
    Revivals like the Great Awakening (18th century) and Azusa Street (20th century) reignited passion and spiritual gifts.  
    Through colonization, resistance, and liberation, Christianity took root across continents ‚Äî 
    today thriving most in the Global South, where faith burns bright in Nigeria, Brazil, and Korea.  
    Modern believers face digital distraction, moral confusion, and persecution ‚Äî yet the Church remains unstoppable.  
    The message of Matthew 28:19‚Äì20 still drives the movement:  
    ‚ÄúGo and make disciples of all nations.‚Äù  
    The revolution that began in an upper room still hasn‚Äôt ended.
  </p>
  <div class="scripture-reference">Matthew 28:19‚Äì20</div>
</div>
        </section>

        <!-- WORLD HISTORY SECTION -->
        <section id="world-history-section" class="section">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg); flex-wrap: wrap; gap: var(--space-sm);">
                <h2>World History üåç</h2>
                <button class="btn btn-secondary" onclick="showSection('history-hub-section')">‚Üê Back</button>
            </div>        
            
            <div class="card">
  <div class="timeline-period">3500‚Äì500 BC</div>
  <h3 class="card-title">Ancient Near East</h3>
  <p class="card-description">
    Mesopotamia, Egypt, Assyria, Babylon, and Persia ‚Äî these empires were the stage where God‚Äôs story unfolded. 
    From Abraham leaving Ur, to Moses facing Pharaoh, to Daniel thriving under Persian kings, 
    the Old Testament played out in a world full of idols, kingdoms, and covenants.  
    Every empire thought they ran history ‚Äî but God was quietly writing His own.
  </p>
</div>

<div class="card">
  <div class="timeline-period">800 BC ‚Äì 500 AD</div>
  <h3 class="card-title">Classical Civilizations</h3>
  <p class="card-description">
    Greece brought philosophy, art, and logic. Rome brought power, roads, and law. 
    Together they created the perfect setup for the arrival of Christ and the rapid spread of the gospel.  
    When Jesus entered history, He didn‚Äôt just change religion ‚Äî He flipped the entire Greco-Roman world order, 
    turning crosses into symbols of victory and slaves into saints.
  </p>
</div>

<div class="card">
  <div class="timeline-period">300 ‚Äì 1900 AD</div>
  <h3 class="card-title">African Civilizations</h3>
  <p class="card-description">
    Long before colonialism, Africa was already part of God‚Äôs kingdom story.  
    From the Ethiopian eunuch in Acts to ancient Christian centers like Alexandria, Nubia, and Axum ‚Äî 
    faith in Christ was thriving.  
    Kingdoms like Kongo and Ethiopia built churches, wrote theology, and kept the gospel alive while Europe warred.  
    Africa wasn‚Äôt late to the story ‚Äî it helped write it.
  </p>
</div>

<div class="card">
  <div class="timeline-period">500 ‚Äì 1500 AD</div>
  <h3 class="card-title">Medieval Period</h3>
  <p class="card-description">
    After Rome fell, new powers rose ‚Äî the Islamic caliphates, Charlemagne‚Äôs empire, and later the Crusades.  
    The Church faced corruption and reform, while monks preserved Scripture in hidden monasteries.  
    Even through war and chaos, God kept the flame alive ‚Äî from Europe‚Äôs cathedrals to Asia‚Äôs trade routes.  
    This era proved that faith survives even when kingdoms collapse.
  </p>
</div>

<div class="card">
  <div class="timeline-period">1400 ‚Äì 1800 AD</div>
  <h3 class="card-title">Age of Exploration</h3>
  <p class="card-description">
    As Europe explored the globe, Christianity went global too ‚Äî not always perfectly, but powerfully.  
    Missionaries carried the gospel across oceans, translating Bibles, building schools, and planting churches.  
    Even in the middle of colonization and chaos, God used broken vessels to bring light to new lands.  
    The Great Commission began turning into a global movement.
  </p>
</div>

<div class="card">
  <div class="timeline-period">1700 ‚Äì Present</div>
  <h3 class="card-title">Modern Era</h3>
  <p class="card-description">
    The Enlightenment challenged faith, revolutions reshaped nations, and wars tested hope ‚Äî but the gospel didn‚Äôt flinch.  
    From revival movements to the digital pulpit, Christianity adapted and expanded.  
    Today, the faith is more global than ever ‚Äî from underground churches in Asia to megachurches in Africa.  
    The story continues ‚Äî same message, new generation, same unshakable God.
  </p>
</div>
        </section>

        <!-- JESUS GENEALOGY SECTION -->
        <section id="jesus-genealogy-section" class="section">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg); flex-wrap: wrap; gap: var(--space-sm);">
                <h2>Jesus' History üå≥</h2>
                <button class="btn btn-secondary" onclick="showSection('history-hub-section')">‚Üê Back</button>
            </div>        
            
            <div class="card">
  <h3 class="card-title">The Two Genealogies</h3>
  <p class="card-description">
    Matthew and Luke both trace Jesus‚Äô lineage, but they do it from two angles. 
    <strong>Matthew</strong> goes through Joseph ‚Äî proving Jesus‚Äô <em>legal right</em> to David‚Äôs throne as the royal heir. 
    <strong>Luke</strong> traces through Mary ‚Äî showing Jesus‚Äô <em>biological connection</em> to David‚Äôs bloodline.  
    Together, they prove that both legally and genetically, Jesus fulfills the qualifications of the Messiah.
  </p>
  <div class="scripture-reference">Matthew 1:1‚Äì17; Luke 3:23‚Äì38</div>
</div>

<div class="card">
  <h3 class="card-title">The Abrahamic Line</h3>
  <p class="card-description">
    God told Abraham, ‚ÄúThrough your seed, all nations will be blessed.‚Äù 
    Jesus is that <em>seed</em> ‚Äî the global blessing that turned a family covenant into a worldwide salvation plan. 
    His genealogy connects Him directly to Abraham, showing that the promise made in Genesis was never broken ‚Äî only waiting for fulfillment in Christ.
  </p>
  <div class="scripture-reference">Genesis 12:3; Galatians 3:16</div>
</div>

<div class="card">
  <h3 class="card-title">The Davidic Covenant</h3>
  <p class="card-description">
    God promised David that his throne would last forever. Every king after David failed to live up to that promise ‚Äî 
    until Jesus showed up as the true and eternal King. 
    His rule isn‚Äôt limited by time or politics; it‚Äôs a kingdom that‚Äôs built on righteousness, peace, and divine authority that never fades.  
    Jesus isn‚Äôt just David‚Äôs descendant ‚Äî He‚Äôs the fulfillment of David‚Äôs <em>eternal dynasty.</em>
  </p>
  <div class="scripture-reference">2 Samuel 7:12‚Äì16; Isaiah 9:6‚Äì7</div>
</div>

<div class="card">
  <h3 class="card-title">The Women in the Genealogy</h3>
  <p class="card-description">
    Most genealogies in ancient times listed only men ‚Äî but Matthew breaks the pattern by including <strong>Tamar</strong>, <strong>Rahab</strong>, <strong>Ruth</strong>, and <strong>Bathsheba</strong>.  
    These women carried stories of scandal, struggle, and redemption. 
    God intentionally wove them in to show that His grace isn‚Äôt limited by race, reputation, or past mistakes.  
    It‚Äôs His subtle way of saying: ‚ÄúI use the unexpected to accomplish the unstoppable.‚Äù
  </p>
  <div class="scripture-reference">Matthew 1:3, 5‚Äì6</div>
</div>

<div class="card">
  <h3 class="card-title">The Exile and Return</h3>
  <p class="card-description">
    The genealogy also moves through dark chapters ‚Äî especially the Babylonian exile. 
    It‚Äôs a reminder that even when God‚Äôs people were under judgment, He was still preserving the line that would bring redemption.  
    The return from exile symbolizes restoration and new beginnings ‚Äî a foreshadow of Jesus bringing humanity back from spiritual exile into reconciliation with the Father.
  </p>
  <div class="scripture-reference">Matthew 1:11‚Äì12, 17</div>
</div>

<div class="card">
  <h3 class="card-title">Prophetic Fulfillment</h3>
  <p class="card-description">
    Every detail in Jesus‚Äô ancestry ties into ancient prophecy ‚Äî from being born in Bethlehem (Micah 5:2) to coming from Jesse‚Äôs family tree (Isaiah 11:1).  
    The genealogy isn‚Äôt just a family list ‚Äî it‚Äôs a prophecy tracker that shows how God has been orchestrating the Messiah‚Äôs arrival across generations.  
    It proves that history was never random ‚Äî it was a divine setup for salvation.
  </p>
  <div class="scripture-reference">Micah 5:2; Isaiah 11:1</div>
</div>
        </section>
    </main>

    <!-- Full-page activity sections (replacing modal UX for Activities) -->

    <!-- BIBLE STUDY SECTION (Full page alternative to bible-study-modal) -->
    <section id="bible-study-section" class="section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:var(--space-lg);">
            <h2>Bible Study üìñ</h2>
            <button class="btn btn-secondary" onclick="showSection('activities-section')">‚Üê Back</button>
        </div>

        <p class="text-center mb-lg text-muted">Short and sweet notes for when you're on the go.</p>
        <div class="topics-grid" id="topics-grid"></div>
        <div id="topic-detail" class="hidden"></div>
    </section>

    <!-- GEN Z STORIES SECTION -->
    <section id="genz-stories-section" class="section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:var(--space-lg);">
            <h2>Gen Z Stories üìö</h2>
            <button class="btn btn-secondary" onclick="showSection('activities-section')">‚Üê Back</button>
        </div>

        <div id="genz-stories-list" class="stories-container">
            <!-- Story buttons will be rendered here (populated by showBibleStoriesModal) -->
        </div>
    </section>

    <!-- FUN FACTS SECTION -->
    <section id="fun-facts-section" class="section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:var(--space-lg);">
            <h2>Bible Fun Facts üéØ</h2>
            <button class="btn btn-secondary" onclick="showSection('activities-section')">‚Üê Back</button>
        </div>

        <div class="card" style="text-align: center; min-height: 300px; display: flex; flex-direction: column; justify-content: center;">
            <div style="font-size: 3rem; margin-bottom: 20px;" id="fact-emoji">üìñ</div>

            <h3 id="fun-fact-title" class="card-title">Loading Fact...</h3>
            <div id="fun-fact-content" style="line-height: 1.6; margin: 20px 0;"> <!-- Fact content will go here --> </div>
            <div id="fun-fact-reference" style="font-style: italic; margin-top: 15px;"> <!-- reference --> </div>
        </div>

        <div style="display: grid; gap: 10px; margin-top: 20px;">
            <button class="btn btn-primary" onclick="showRandomFact()">Show Another Fact üîÑ</button>
            <button class="btn btn-secondary" onclick="showSection('activities-section')">Back to Activities</button>
        </div>
    </section>

    <!-- GLOSSARY SECTION -->
    <section id="glossary-section" class="section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:var(--space-lg);">
            <h2>Bible Glossary üìö</h2>
            <button class="btn btn-secondary" onclick="showSection('activities-section')">‚Üê Back</button>
        </div>

        <div style="margin-bottom: 20px;">
            <input type="text" id="glossary-search" placeholder="Search for Bible terms, people, places..." style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border);" onkeyup="searchGlossary()">
            <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 8px;"><span id="glossary-count">0</span> terms available</div>
        </div>

        <div class="alphabet-filter" style="margin-bottom: 20px;">
            <div style="display: flex; flex-wrap: wrap; gap: 5px; justify-content: center;">
                <button class="alphabet-btn active" onclick="filterGlossaryByLetter('all')">All</button>
                <button class="alphabet-btn" onclick="filterGlossaryByLetter('A')">A</button>
                <button class="alphabet-btn" onclick="filterGlossaryByLetter('B')">B</button>
                <button class="alphabet-btn" onclick="filterGlossaryByLetter('C')">C</button>
                <button class="alphabet-btn" onclick="filterGlossaryByLetter('D')">D</button>
                <button class="alphabet-btn" onclick="filterGlossaryByLetter('E')">E</button>
                <button class="alphabet-btn" onclick="filterGlossaryByLetter('F')">F</button>
                <button class="alphabet-btn" onclick="filterGlossaryByLetter('G')">G</button>
                <button class="alphabet-btn" onclick="filterGlossaryByLetter('H')">H</button>
                <button class="alphabet-btn" onclick="filterGlossaryByLetter('I')">I</button>
                <button class="alphabet-btn" onclick="filterGlossaryByLetter('J')">J</button>
                <button class="alphabet-btn" onclick="filterGlossaryByLetter('K')">K</button>
                <button class="alphabet-btn" onclick="filterGlossaryByLetter('L')">L</button>
                <button class="alphabet-btn" onclick="filterGlossaryByLetter('M')">M</button>
                <button class="alphabet-btn" onclick="filterGlossaryByLetter('N')">N</button>
                <button class="alphabet-btn" onclick="filterGlossaryByLetter('O')">O</button>
                <button class="alphabet-btn" onclick="filterGlossaryByLetter('P')">P</button>
                <button class="alphabet-btn" onclick="filterGlossaryByLetter('Q')">Q</button>
                <button class="alphabet-btn" onclick="filterGlossaryByLetter('R')">R</button>
                <button class="alphabet-btn" onclick="filterGlossaryByLetter('S')">S</button>
                <button class="alphabet-btn" onclick="filterGlossaryByLetter('T')">T</button>
                <button class="alphabet-btn" onclick="filterGlossaryByLetter('U')">U</button>
                <button class="alphabet-btn" onclick="filterGlossaryByLetter('V')">V</button>
                <button class="alphabet-btn" onclick="filterGlossaryByLetter('W')">W</button>
                <button class="alphabet-btn" onclick="filterGlossaryByLetter('X')">X</button>
                <button class="alphabet-btn" onclick="filterGlossaryByLetter('Y')">Y</button>
                <button class="alphabet-btn" onclick="filterGlossaryByLetter('Z')">Z</button>
            </div>
        </div>

        <div id="glossary-list" class="glossary-list"><!-- glossary items render here --></div>
    </section>

    <!-- MODALS -->
    <!-- BIBLE QUIZ MODAL -->
<div id="bible-quiz-modal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2>Bible Quiz ‚ùì</h2>
            <button class="close-btn" onclick="hideBibleQuiz()">√ó</button>
        </div>
        <div class="modal-body">
            <!-- Quiz Start Screen -->
            <div id="quiz-start-screen">
                <div class="text-center">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üìñ</div>
                    <h3>Test Your Bible Knowledge!</h3>
                    <p>Answer multiple choice questions. Earn 10 points per correct answer!</p>
                    <div style="background: var(--surface); padding: 15px; border-radius: 12px; margin: 20px 0;">
                        <strong>Rules:</strong>
                        <ul style="text-align: left; margin: 10px 0; padding-left: 20px;">
                            <li>10 questions per game</li>
                            <li>60 seconds to complete</li>
                            <li>+10 points per correct answer</li>
                            <li>Bonus points for speed!</li>
                        </ul>
                    </div>
                    <button class="btn btn-primary" onclick="startQuizGame()">Start Quiz üöÄ</button>
                </div>
            </div>
            

            <!-- Quiz Game Screen -->
            <div id="quiz-game-screen" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="font-weight: 700;">Question <span id="quiz-current">1</span>/10</div>
                    <div style="background: var(--accent-gold); color: white; padding: 5px 10px; border-radius: 20px; font-weight: 700;">
                        Time: <span id="quiz-timer">60</span>s
                    </div>
                </div>

                <div class="card" style="margin-bottom: 20px;">
                    <h3 id="quiz-question" class="card-title">Loading question...</h3>
                </div>

                <div id="quiz-options" style="display: grid; gap: 10px;">
                    <!-- Options will be populated by JavaScript -->
                </div>

                <div id="quiz-feedback" class="hidden" style="margin-top: 15px; padding: 15px; border-radius: 12px;"></div>
            </div>

            <!-- Quiz Results Screen -->
            <div id="quiz-results-screen" class="hidden">
                <div class="text-center">
                    <div style="font-size: 4rem; margin-bottom: 20px;">üéâ</div>
                    <h3>Quiz Complete!</h3>
                    
                    <div style="background: var(--surface); padding: 20px; border-radius: 12px; margin: 20px 0;">
                        <div style="font-size: 2rem; font-weight: 800; color: var(--accent-gold); margin-bottom: 10px;">
                            <span id="quiz-final-score">0</span> points
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>Correct Answers:</strong> <span id="quiz-correct-answers">0</span>/10
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>Time Left:</strong> <span id="quiz-time-bonus">0</span>s bonus
                        </div>
                        <div style="color: var(--accent-gold); font-weight: 700;">
                            +<span id="quiz-total-points">0</span> leaderboard points!
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="restartBibleQuiz()">Play Again üîÑ</button>
                    <button class="btn btn-secondary" onclick="hideBibleQuiz()">Back to Games</button>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- BIBLE OR CAP MODAL -->
<div id="bible-cap-modal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2>Bible or Cap? üìç</h2>
            <button class="close-btn" onclick="hideCapGame()">√ó</button>
        </div>
        <div class="modal-body">
            <!-- Start Screen -->
            <div id="cap-start-screen">
                <div class="text-center">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üìñ‚ùì</div>
                    <h3>Is it Scripture or Cap?</h3>
                    <p>Read the statement and swipe to guess if it's real Bible or made up!</p>
                    <div style="background: var(--surface); padding: 15px; border-radius: 12px; margin: 20px 0;">
                        <strong>How to Play:</strong>
                        <ul style="text-align: left; margin: 10px 0; padding-left: 20px;">
                            <li>Swipe RIGHT or tap ‚úÖ if it's REAL Bible</li>
                            <li>Swipe LEFT or tap ‚ùå if it's CAP (fake)</li>
                            <li>Get as many correct in a row!</li>
                            <li>One wrong answer = game over</li>
                        </ul>
                    </div>
                    <button class="btn btn-primary" onclick="startCapGame()">Start Game üöÄ</button>
                </div>
            </div>

            <!-- Game Screen -->
            <div id="cap-game-screen" class="hidden">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-weight: 700; font-size: 1.2rem; color: var(--accent-gold);">
                        Streak: <span id="cap-streak-count">0</span> üî•
                    </div>
                </div>

                <div id="cap-card-container" style="position: relative; height: 400px; touch-action: pan-y;">
                    <div class="cap-card" id="cap-card" style="position: absolute; width: 100%; background: var(--surface); border: 2px solid var(--border); border-radius: 16px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); transition: transform 0.3s ease, opacity 0.3s ease;">
                        <div style="font-size: 1.1rem; line-height: 1.8; color: var(--text-primary); min-height: 200px; display: flex; align-items: center; justify-content: center; text-align: center;" id="cap-statement">
                            Loading...
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 20px; justify-content: center; margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="guessAnswer(false)" style="font-size: 2rem; padding: 15px 30px;">
                        ‚ùå Cap
                    </button>
                    <button class="btn btn-primary" onclick="guessAnswer(true)" style="font-size: 2rem; padding: 15px 30px;">
                        ‚úÖ Real
                    </button>
                </div>

                <div id="cap-feedback" class="hidden" style="margin-top: 20px; padding: 15px; border-radius: 12px; text-align: center;"></div>
            </div>

            <!-- Results Screen -->
            <div id="cap-results-screen" class="hidden">
                <div class="text-center">
                    <div style="font-size: 4rem; margin-bottom: 20px;">üéØ</div>
                    <h3>Game Over!</h3>
                    
                    <div style="background: var(--surface); padding: 20px; border-radius: 12px; margin: 20px 0;">
                        <div style="font-size: 2rem; font-weight: 800; color: var(--accent-gold); margin-bottom: 10px;">
                            <span id="cap-final-streak">0</span> Correct! üî•
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>Points Earned:</strong> <span id="cap-points-earned">0</span>
                        </div>
                        <div id="cap-new-record" class="hidden" style="color: var(--accent-gold); font-weight: 700; margin-top: 10px;">
                            üéâ NEW RECORD! üéâ
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="restartCapGame()">Play Again üîÑ</button>
                    <button class="btn btn-secondary" onclick="hideCapGame()">Back to Games</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- VERSE MATCH MODAL -->
<div id="verse-match-modal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2>Verse Match üß©</h2>
            <button class="close-btn" onclick="hideVerseMatch()">√ó</button>
        </div>
        <div class="modal-body">
            <!-- Start Screen -->
            <div id="match-start-screen">
                <div class="text-center">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üß©</div>
                    <h3>Match the Verse!</h3>
                    <p>Connect Bible verses with their Gen Z translations.</p>
                   <div style="background: var(--surface); padding: 15px; border-radius: 12px; margin: 20px 0;">
                        <strong>How to Play:</strong>
                        <ul style="text-align: left; margin: 10px 0; padding-left: 20px;">
                            <li>Match the original verse with its Gen Z translation</li>
                            <li>+10 points for every correct match</li>
                            <li>One wrong answer = game over!</li>
                            <li>See how long you can keep your streak going</li>
                            <li>20+ different verse pairs to match</li>
                        </ul>
                    </div>
                    <button class="btn btn-primary" onclick="startMatchGame()">Start Matching üöÄ</button>
                </div>
            </div>

           <!-- Game Screen -->
            <div id="match-game-screen" class="hidden">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-weight: 700; font-size: 1.2rem; color: var(--accent-gold);">
                        Streak: <span id="match-score">0</span> üî•
                    </div>
                    <div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 5px;">
                        Get one wrong and it's game over!
                    </div>
                </div>

                <div class="card" style="margin-bottom: 20px; min-height: 120px; display: flex; align-items: center; justify-content: center;">
                    <div 
                    style="font-size: 1.1rem; line-height: 1.6; text-align: center; padding: 20px;" id="original-verse">
                        Loading verse...
                    </div>
                </div>

                <div id="match-options" style="display: grid; gap: 10px;">
                    <!-- Options will be populated here -->
                </div>

                <div id="match-feedback" class="hidden" style="margin-top: 15px; padding: 15px; border-radius: 12px; text-align: center;"></div>
            </div>

            <!-- Results Screen -->
            <div id="match-results-screen" class="hidden">
                <div class="text-center">
                    <div style="font-size: 4rem; margin-bottom: 20px;">üéØ</div>
                    <h3>Game Over!</h3>
                    
                    <div style="background: var(--surface); padding: 20px; border-radius: 12px; margin: 20px 0;">
                        <div style="font-size: 2rem; font-weight: 800; color: var(--accent-gold); margin-bottom: 10px;">
                            <span id="match-streak-count">0</span> Correct! üî•
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>Points Earned:</strong> <span id="match-final-score">0</span>
                        </div>
                        <div id="match-new-record" class="hidden" style="color: var(--accent-gold); font-weight: 700; margin-top: 10px;">
                            üéâ NEW RECORD! üéâ
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="restartMatchGame()">Play Again üîÑ</button>
                    <button class="btn btn-secondary" onclick="hideVerseMatch()">Back to Games</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- BIBLE RIDDLES MODAL -->
<div id="bible-riddles-modal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2>Bible Riddles üé≠</h2>
            <button class="close-btn" onclick="hideBibleRiddles()">√ó</button>
        </div>
        <div class="modal-body">
            <!-- Start Screen -->
            <div id="riddles-start-screen">
                <div class="text-center">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üé≠</div>
                    <h3>Who Am I? Bible Riddles</h3>
                    <p>Guess the Bible character from clues! Use fewer clues for more points.</p>
                    <div style="background: var(--surface); padding: 15px; border-radius: 12px; margin: 20px 0;">
                        <strong>How to Play:</strong>
                        <ul style="text-align: left; margin: 10px 0; padding-left: 20px;">
                            <li>Read the "Who am I?" question</li>
                            <li>Type your answer in the box</li>
                            <li>Use clues if you get stuck (-2 points per clue)</li>
                            <li>+10 points for correct answers</li>
                            <li>One wrong answer = game over!</li>
                            <li>Skip a riddle (-3 points) if you're really stuck</li>
                        </ul>
                    </div>
                    <button class="btn btn-primary" onclick="startRiddlesGame()">Start Solving üöÄ</button>
                </div>
            </div>

            <!-- Game Screen -->
            <div id="riddles-game-screen" class="hidden">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-weight: 700; color: var(--accent-gold);">
                            Score: <span id="riddles-score">0</span> üèÜ
                        </div>
                        <div style="font-weight: 700; color: var(--accent-sage);">
                            Solved: <span id="riddles-solved-count">0</span> ‚úÖ
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 20px;">
                    <h3 id="riddle-question" class="card-title" style="text-align: center;">
                        Loading riddle...
                    </h3>
                </div>

                <div id="riddle-clues" class="clues-container" style="margin-bottom: 20px;">
                    <!-- Clues will appear here -->
                </div>

                <div style="display: grid; gap: 10px; margin-bottom: 15px;">
                    <input 
                        type="text" 
                        id="riddle-answer-input" 
                        placeholder="Type your answer here..." 
                        style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border);"
                        onkeypress="handleRiddleKeyPress(event)"
                    >
                    <button class="btn btn-primary" id="riddle-submit-btn" onclick="submitRiddleAnswer()">
                        Submit Answer ‚úÖ
                    </button>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <button class="btn btn-secondary" id="riddle-clue-btn" onclick="showNextClue()">
                        Get Clue (0/0 used)
                    </button>
                    <button class="btn btn-secondary" id="riddle-skip-btn" onclick="skipRiddle()">
                        Skip Riddle ‚è≠Ô∏è
                    </button>
                </div>

                <div id="riddle-feedback" class="hidden" style="margin-top: 15px; padding: 15px; border-radius: 12px; text-align: center;"></div>
            </div>

            <!-- Results Screen -->
            <div id="riddles-results-screen" class="hidden">
                <div class="text-center">
                    <div style="font-size: 4rem; margin-bottom: 20px;">üéØ</div>
                    <h3>Game Over!</h3>
                    
                    <div style="background: var(--surface); padding: 20px; border-radius: 12px; margin: 20px 0;">
                        <div style="font-size: 2rem; font-weight: 800; color: var(--accent-gold); margin-bottom: 10px;">
                            <span id="riddles-final-score">0</span> Points üèÜ
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>Riddles Solved:</strong> <span id="riddles-total-solved">0</span>
                        </div>
                        <div style="color: var(--accent-gold); font-weight: 700;">
                            +<span id="riddles-points-earned">0</span> leaderboard points!
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="restartRiddlesGame()">Play Again üîÑ</button>
                    <button class="btn btn-secondary" onclick="hideBibleRiddles()">Back to Games</button>
                </div>
            </div>
        </div>
    </div>
</div>
    <!-- Bible Study Modal -->
    <div id="bible-study-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Bible Study Topics</h2>
                <button class="close-btn" onclick="hideBibleStudy()">√ó</button>
            </div>
            <div class="modal-body">
                <p class="text-center mb-lg text-muted">Short and sweet notes for when you're on the go.</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: var(--space-md);" id="topics-grid">
                    <!-- Topics will be populated by JavaScript -->
                </div>
                <div id="topic-detail" class="hidden">
                    <!-- Topic details will be shown here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div id="progress-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Your Progress</h2>
                <button class="close-btn" onclick="hideProgress()">√ó</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: var(--space-lg);">
                    <div style="font-size: 3rem; font-weight: 800; background: linear-gradient(135deg, var(--accent-gold), var(--accent-burgundy)); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: var(--space-md);" id="level-display">
                        Level 1
                    </div>
                    <div style="font-size: 1.5rem; color: var(--accent-gold); margin-bottom: var(--space-lg);" id="streak-display">
                        7 Day Streak
                    </div>
                   <!-- Progress Bar Container -->
<div class="progress-bar-container">
    <div class="progress-bar-fill" id="progress-fill"></div>
</div>
                    <p class="text-muted" id="next-level-text">3 more days until Level 2</p>
                    <p class="text-muted">Keep your streak going to level up!</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- User Profile Modal -->
    <div id="user-profile-modal" class="modal">
        <div class="modal-content">
            <div style="text-align: center; padding: var(--space-xl); background: linear-gradient(135deg, var(--accent-gold), var(--accent-burgundy)); border-radius: var(--radius-lg) var(--radius-lg) 0 0; color: var(--primary); margin: calc(-1 * var(--space-lg)); margin-bottom: var(--space-lg); position: relative;">
                <div style="width: 110px; height: 110px; background: var(--surface); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 3rem; margin: 0 auto var(--space-md); overflow:hidden; color:var(--accent-gold); border: 4px solid rgba(255,255,255,0.25); flex-shrink: 0; animation: none;" id="profile-avatar">
                    <!-- Avatar image or initial will be injected here -->
                    üë§
                </div>
                <div style="font-size: 1.85rem; font-weight: 900; margin-bottom: 12px; letter-spacing: 0.8px; color: var(--accent-gold); text-shadow: 0 2px 4px rgba(0,0,0,0.2); line-height: 1.2;" id="profile-name">
                    Friend
                </div>
                <div style="font-size: 1.05rem; font-weight: 700; letter-spacing: 0.6px; color: rgba(255,255,255,0.95); text-shadow: 0 1px 3px rgba(0,0,0,0.25); background: rgba(0,0,0,0.15); padding: 10px 18px; border-radius: 20px; display: inline-block;" id="profile-title">
                    Scripture Explorer
                </div>
                <button class="close-btn" onclick="hideUserProfile()" style="position: absolute; top: 15px; right: 15px; background: rgba(26, 21, 17, 0.3); border-color: transparent;">√ó</button>
            </div>
            
            <div class="modal-body">
                <div class="grid-2" style="margin: var(--space-lg) 0; gap: 12px;">
                    <div style="background: linear-gradient(135deg, rgba(255,215,0,0.15), rgba(255,215,0,0.08)); border: 2px solid var(--accent-gold); border-radius: 12px; padding: 18px; text-align: center;">
                        <div style="font-size: 2.2rem; font-weight: 900; color: var(--accent-gold); margin-bottom: 6px;" id="profile-streak">0</div>
                        <div style="font-size: 0.85rem; color: var(--text-primary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">üî• Day Streak</div>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(255,215,0,0.15), rgba(255,215,0,0.08)); border: 2px solid var(--accent-gold); border-radius: 12px; padding: 18px; text-align: center;">
                        <div style="font-size: 2.2rem; font-weight: 900; color: var(--accent-gold); margin-bottom: 6px;" id="profile-highlights">0</div>
                        <div style="font-size: 0.85rem; color: var(--text-primary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">‚≠ê Highlights</div>
                    </div>
                </div>
                <!-- PROFILE ACTIONS: Change avatar / edit bio -->
                <div style="display:flex; gap:8px; margin-bottom:var(--space-md); flex-wrap:wrap;">
                    <button class="btn btn-primary" style="flex:1; min-width:120px;" onclick="openAvatarPicker()">üì∑ Change Picture</button>
                    <button class="btn btn-secondary" style="flex:1; min-width:120px;" id="edit-bio-btn" onclick="toggleEditBio()">‚úèÔ∏è Edit Bio</button>
                </div>
                <div style="margin-top: var(--space-md);">
                    <div class="card" style="padding:12px;">
                        <div style="font-weight:700; font-size:0.95rem; color:var(--text-muted);">Bio</div>
                        <div id="profile-bio" style="margin-top:8px; color:var(--text-primary);">You don't have a bio yet. Add one!</div>
                        <textarea id="profile-bio-textarea" style="width:100%; margin-top:8px; display:none; min-height:80px; padding:8px; border-radius:8px; border:1px solid var(--border);"></textarea>
                        <div id="profile-bio-actions" style="display:none; margin-top:8px; gap:8px;">
                            <button class="btn btn-primary" onclick="saveBio()">Save Bio</button>
                            <button class="btn btn-secondary" onclick="cancelEditBio()">Cancel</button>
                        </div>
                    </div>
                </div>
                <!-- Level & Community Rank (updated by scripts) -->
                <div style="margin-top: var(--space-lg); padding-top: var(--space-md); border-top: 1px solid var(--border);">
                    <div style="margin-bottom: var(--space-md);">
                        <div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:10px;">
                            <div style="font-weight:600; font-size:0.9rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.3px;">Current Level</div>
                            <div id="profile-level" style="font-weight:800; font-size:1.5rem; color:var(--accent-gold);">Level 1</div>
                        </div>
                        <div class="progress-bar-container" style="background:var(--surface); border-radius:8px; height:8px; width:100%; overflow:hidden;">
                            <div id="profile-level-fill" style="background:linear-gradient(90deg, var(--accent-gold), var(--accent-burgundy)); height:100%; width:0%; border-radius:8px; transition: width 0.3s ease;"></div>
                        </div>
                        <div id="profile-next-level" style="font-size:0.75rem; color:var(--text-muted); margin-top:8px; text-align:right; font-weight:500;">3 more days until Level 2</div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="hideUserProfile()" style="width: 100%; margin-top: var(--space-lg);">
                    Keep Going! 
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden file input for avatar upload -->
    <input type="file" id="avatar-file-input" accept="image/*" style="display:none;" />

    <!-- Prayer Modal -->
    <div id="prayer-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="prayer-title">Prayer</h2>
                <button class="close-btn" onclick="hidePrayer()">√ó</button>
            </div>
            <div class="modal-body">
                <div id="prayer-content">
                    <!-- Prayer content will be shown here -->
                </div>
            </div>
        </div>
    </div>

     <!-- SETTINGS SECTION -->
<section id="settings-section" class="section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg); flex-wrap: wrap; gap: var(--space-sm);">
        <h2>Settings ‚öôÔ∏è</h2>
    </div>

    <div class="card">
        <h3 class="card-title">Appearance</h3>
        <div style="padding: 15px 0; border-bottom: 1px solid var(--border);">
            <label class="flex items-center justify-between">
                <span>Dark Mode</span>
                <input type="checkbox" id="dark-mode-toggle" onchange="toggleDarkMode()">
            </label>
        </div>
        <div style="padding: 15px 0;">
            <label class="flex items-center justify-between">
                <span>Show Original Text</span>
                <input type="checkbox" id="show-original-toggle" onchange="toggleShowOriginal()">
            </label>
            <p class="text-sm text-muted" style="margin-top: 8px;">
                When enabled, shows traditional Bible text alongside Gen Z translation
            </p>
        </div>
    </div>

    <div class="card">
        <h3 class="card-title">Notifications</h3>
        <div style="padding: 15px 0; border-bottom: 1px solid var(--border);">
            <label class="flex items-center justify-between">
                <span>Daily Reminders</span>
                <input type="checkbox" id="notifications-toggle" onchange="toggleNotifications()">
            </label>
        </div>
        <div style="padding: 15px 0;">
            <label class="flex items-center justify-between">
                <span>Verse of the Day</span>
                <input type="checkbox" id="verse-reminder-toggle" onchange="toggleVerseReminder()">
            </label>
        </div>
    </div>

    <div class="card">
        <h3 class="card-title">Data</h3>
        <div style="padding: 15px 0;">
            <button class="btn btn-accent" onclick="resetData()" style="width: 100%;">Reset All Data</button>
        </div>
    </div>

    <div class="card" style="cursor: pointer;" onclick="showAboutPage()">
        <h3 class="card-title">About</h3>
        <p class="card-description">Learn more about Zcriptures</p>
        <div style="color: var(--accent-gold); font-weight: 600; margin-top: 8px;">View Details ‚Üí</div>
    </div>
</section>

<!-- ABOUT PAGE SECTION -->
<section id="about-section" class="section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
        <h2>About Zcriptures</h2>
        <button class="btn btn-secondary" onclick="showSection('settings-section')">‚Üê Back</button>
    </div>

    <div class="card">
        <div style="text-align: center; margin-bottom: var(--space-lg);">
            <img src="logo.jpg" alt="Zcriptures Logo" style="width: 120px; height: auto; border-radius: 16px; margin-bottom: 1rem; box-shadow: var(--shadow);">
            <h3 class="card-title" style="font-size: 1.75rem;">Zcriptures</h3>
            <p class="text-muted">Modern Bible App for Gen Z</p>
            <p class="text-muted" style="font-size: 0.875rem; margin-top: 4px;">Version 1.0.0</p>
        </div>
    </div>

    <div class="card">
        <h3 class="card-title">Mission</h3>
        <p class="card-description">
            Zcriptures bridges the gap between timeless Scripture and modern language, 
            making the Bible accessible and relatable to today's generation. We believe 
            God's Word is alive and relevant for everyone, regardless of how they speak.
        </p>
    </div>

    <div class="card">
        <h3 class="card-title">Features</h3>
        <ul style="list-style: none; padding: 0;">
            <li style="padding: 8px 0; border-bottom: 1px solid var(--border);">
                üìñ <strong>Gen Z Translations</strong> - Bible verses in modern language
            </li>
            <li style="padding: 8px 0; border-bottom: 1px solid var(--border);">
                ‚≠ê <strong>Highlights & Notes</strong> - Save and organize your favorite verses
            </li>
            <li style="padding: 8px 0; border-bottom: 1px solid var(--border);">
                üéØ <strong>Daily Challenges</strong> - Grow your faith with daily tasks
            </li>
            <li style="padding: 8px 0; border-bottom: 1px solid var(--border);">
                üéÆ <strong>Bible Games</strong> - Learn through interactive quizzes
            </li>
            <li style="padding: 8px 0; border-bottom: 1px solid var(--border);">
                üî• <strong>Streak Tracking</strong> - Stay consistent in your journey
            </li>
            <li style="padding: 8px 0;">
                üìö <strong>Bible Study Tools</strong> - Guided topics and devotionals
            </li>
        </ul>
    </div>

    <div class="card">
        <h3 class="card-title">Disclaimer</h3>
        <div class="about-disclaimer">
            <p class="text-sm" style="margin-bottom: 12px;">
                Zcriptures is not affiliated with any religious organization. Bible content 
                is from public domain translations (King James Version).
            </p>
            <p class="text-sm" style="margin-bottom: 12px;">
                <strong>Gen Z translations are paraphrases for understanding, not doctrinal 
                interpretations.</strong> They are meant to make Scripture relatable and should 
                be used alongside traditional translations for study.
            </p>
            <p class="text-sm">
                Always consult with spiritual leaders and traditional translations when seeking 
                theological guidance.
            </p>
        </div>
    </div>

    <div class="card">
        <h3 class="card-title">Credits</h3>
        <p class="card-description">
            <strong>Developed by:</strong> Legend Inc<br>
            <strong>Scripture Source:</strong> King James Version (Public Domain)<br>
            <strong>Icons & Design:</strong> Custom UI with modern aesthetic<br>
            <strong>Special Thanks:</strong> To everyone making faith accessible
        </p>
    </div>

    <div class="card">
        <h3 class="card-title">Contact & Support</h3>
        <p class="card-description">
            Have feedback or found a bug? Want to suggest a feature?
        </p>
        <div style="margin-top: 12px;">
            <p class="text-muted" style="font-size: 0.875rem;">
                Visit <strong>support.zcriptures.app</strong> for help
            </p>
        </div>
    </div>
    </section>

    <!-- Username Modal -->
    <div id="username-modal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>Welcome to Zcriptures! üëã</h2>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: var(--space-md);">What's your name?</p>
                <input type="text" id="username-input" placeholder="Enter your name" 
                       style="width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border); 
                              background: var(--surface); color: var(--text-primary); margin: 15px 0; font-family: var(--font-sans); font-size: 1rem;">
                <button class="btn btn-primary" onclick="saveUsername()" style="width: 100%;">
                    Let's Go! üöÄ
                </button>
            </div>
        </div>
    </div>

    <!-- BOTTOM NAVIGATION -->
    <nav class="bottom-nav visible" id="bottom-nav">
        <div class="nav-container">
            <div class="nav-item active" data-target="home-section">
                <div class="nav-icon">üè†</div>
                <span>Home</span>
            </div>
            <div class="nav-item" data-target="bible-section">
                <div class="nav-icon">üìñ</div>
                <span>Bible</span>
            </div>
            <div class="nav-item" data-target="activities-section">
                <div class="nav-icon">üéØ</div>
                <span>Activities</span>
            </div>
            <div class="nav-item" id="nav-leaderboard" data-target="leaderboard-section" title="Leaderboard">
                <div class="nav-icon">üèÜ</div>
                <span>Leaderboard</span>
            </div>
            <div class="nav-item" data-target="history-hub-section">
                <div class="nav-icon">üìú</div>
                <span>History</span>
            </div>
        </div>
    </nav>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="toast">
        <span id="toast-message"></span>
    </div>

    <!-- LEADERBOARD MODAL -->
    <div id="leaderboard-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Offline Leaderboard</h2>
                <button class="close-btn" onclick="hideLeaderboard()">√ó</button>
            </div>
            <div class="modal-body">
                <div id="leaderboard-top">
                    <!-- Profile card will be injected here -->
                </div>

                <div id="leaderboard-container">
                    <!-- Leaderboard will render here -->
                </div>
            </div>
        </div>
    </div>



    <script>

let bibleDataKJV = {}; // (legacy) book-level cache ‚Äî not required for lazy-loading
let bibleDataGenZ = {}; 

// chapter-level caches to keep only requested chapters in memory
const bibleChapterCache = {
    kjv: {},
    genZ: {}
};

// Load only the requested chapter from a book file and cache it by book+chapter
async function loadBibleChapter(bookName, chapterNumber) {
    try {
        const fileName = bookName.replace(/ /g, '');

        // Fetch KJV if not cached for this chapter
        if (!bibleChapterCache.kjv[bookName] || !bibleChapterCache.kjv[bookName][chapterNumber]) {
            const responseKJV = await fetch(`zcriptures-kjv/${fileName}.json`);
            if (responseKJV.ok) {
                const kjvData = await responseKJV.json();
                // find the chapter
                const ch = kjvData.chapters ? kjvData.chapters.find(c => c.chapter === String(chapterNumber)) : null;
                bibleChapterCache.kjv[bookName] = bibleChapterCache.kjv[bookName] || {};
                bibleChapterCache.kjv[bookName][chapterNumber] = ch || { verses: [] };
            } else {
                bibleChapterCache.kjv[bookName] = bibleChapterCache.kjv[bookName] || {};
                bibleChapterCache.kjv[bookName][chapterNumber] = { verses: [] };
            }
        }

        // Fetch Gen Z if not cached for this chapter
        if (!bibleChapterCache.genZ[bookName] || !bibleChapterCache.genZ[bookName][chapterNumber]) {
            const responseGenZ = await fetch(`zcriptures-genz/${fileName}.json`);
            if (responseGenZ.ok) {
                const genZData = await responseGenZ.json();
                const ch = genZData.chapters ? genZData.chapters.find(c => c.chapter === String(chapterNumber)) : null;
                bibleChapterCache.genZ[bookName] = bibleChapterCache.genZ[bookName] || {};
                bibleChapterCache.genZ[bookName][chapterNumber] = ch || { verses: [] };
            } else {
                bibleChapterCache.genZ[bookName] = bibleChapterCache.genZ[bookName] || {};
                bibleChapterCache.genZ[bookName][chapterNumber] = { verses: [] };
            }
        }

        return {
            kjv: bibleChapterCache.kjv[bookName][chapterNumber],
            genZ: bibleChapterCache.genZ[bookName][chapterNumber]
        };
    } catch (error) {
        console.error('Error loading chapter:', error);
        return { kjv: { verses: [] }, genZ: { verses: [] } };
    }
}

// Build verses for a single chapter using the chapter caches (lazy-loaded)
function getChapterVerses(bookName, chapter) {
    const kjvChapter = bibleChapterCache.kjv[bookName] ? bibleChapterCache.kjv[bookName][chapter] : null;
    const genZChapter = bibleChapterCache.genZ[bookName] ? bibleChapterCache.genZ[bookName][chapter] : null;

    // Fallback to the older book-level cache if present
    const kjvFromBook = bibleDataKJV[bookName] ? (bibleDataKJV[bookName].chapters || []).find(ch => ch.chapter === String(chapter)) : null;
    const genZFromBook = bibleDataGenZ[bookName] ? (bibleDataGenZ[bookName].chapters || []).find(ch => ch.chapter === String(chapter)) : null;

    const kjv = kjvChapter || kjvFromBook;
    const genZ = genZChapter || genZFromBook;

    if (!kjv && !genZ) {
        console.warn(`Chapter not loaded for ${bookName} ${chapter}`);
        return [];
    }

    const kjvVerses = kjv ? kjv.verses : [];
    const genZVerses = genZ ? genZ.verses : [];

    const combined = [];
    const max = Math.max(kjvVerses.length, genZVerses.length);
    for (let i = 0; i < max; i++) {
        combined.push({
            verse: kjvVerses[i]?.verse || genZVerses[i]?.verse,
            kjvText: kjvVerses[i]?.text || '',
            genZText: genZVerses[i]?.text || ''
        });
    }

    return combined;
}

// Optionally preload the first chapter of a few common books (keeps network smaller)
async function preloadCommonBooks() {
    const commonBooks = ['Genesis', 'Psalms', 'John', 'Matthew', 'Romans'];
    for (const bookName of commonBooks) {
        await loadBibleChapter(bookName, 1).catch(() => {});
        console.log(`üîÅ Preloaded chapter 1 for ${bookName}`);
    }
}
       
      
      
       

        // === STATE MANAGEMENT ===
        let currentView = 'books';
        let currentBook = null;
        let currentChapter = null;
        let userData = {
    name: '',
    streak: 0,
    lastLogin: null,
    highlights: [],
    challengeCompleted: false,
    showOriginalText: false,
    prayerCount: 0,
    sharesCount: 0,
    booksRead: 0,
    motivationVisits: 0,
    historyVisits: 0,
    studyTopics: 0,
       gamePoints: 0,
    quizHighScore: 0,
    capBestStreak: 0,
    matchHighScore: 0,
    riddlesSolved: 0
};
// In-memory set of currently selected verses (for multi-select highlighting)
let selectedVerses = new Set();

// ===== IndexedDB WRAPPER =====
// Initialize IndexedDB for persistent storage
let db = null;
const DB_NAME = 'ZcripturesDB';
const DB_VERSION = 2; // bumped to add achievements store

// Initialize database
async function initDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
            db = request.result;
            console.log('‚úÖ IndexedDB initialized');
            resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
            db = event.target.result;
            
            // Create object stores
            if (!db.objectStoreNames.contains('userData')) {
                db.createObjectStore('userData', { keyPath: 'id' });
            }
            if (!db.objectStoreNames.contains('notes')) {
                db.createObjectStore('notes', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('discoveredFacts')) {
                db.createObjectStore('discoveredFacts', { keyPath: 'id' });
            }
            if (!db.objectStoreNames.contains('settings')) {
                db.createObjectStore('settings', { keyPath: 'key' });
            }
            if (!db.objectStoreNames.contains('leaderboard')) {
                db.createObjectStore('leaderboard', { keyPath: 'id' });
            }
            // Achievements store (persistent earned achievements)
            if (!db.objectStoreNames.contains('achievements')) {
                db.createObjectStore('achievements', { keyPath: 'id' });
            }
            
            console.log('‚úÖ IndexedDB schema created');
        };
    });
}

// Get a value from IndexedDB
async function dbGet(storeName, key) {
    if (!db) await initDB();
    return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, 'readonly');
        const store = tx.objectStore(storeName);
        const request = store.get(key);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);
    });
}

// Set a value in IndexedDB
async function dbSet(storeName, value) {
    if (!db) await initDB();
    return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, 'readwrite');
        const store = tx.objectStore(storeName);
        const request = store.put(value);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);
    });
}

// Delete a value from IndexedDB
async function dbDelete(storeName, key) {
    if (!db) await initDB();
    return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, 'readwrite');
        const store = tx.objectStore(storeName);
        const request = store.delete(key);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);
    });
}

// Clear an entire object store
async function dbClear(storeName) {
    if (!db) await initDB();
    return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, 'readwrite');
        const store = tx.objectStore(storeName);
        const request = store.clear();
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve();
    });
}

// Helper: convert hex to rgba with alpha
function hexToRgba(hex, alpha) {
    if (!hex) return null;
    // Expand shorthand (#abc)
    const h = hex.replace('#','');
    const hexFull = h.length === 3 ? h.split('').map(c=>c+c).join('') : h;
    const r = parseInt(hexFull.substring(0,2),16);
    const g = parseInt(hexFull.substring(2,4),16);
    const b = parseInt(hexFull.substring(4,6),16);
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

// Apply a color to all currently selected verses (or single verse if none selected)
function applyHighlightToSelected(color) {
    if (selectedVerses.size === 0) {
        // nothing selected
        return;
    }

    selectedVerses.forEach(v => {
        // v is a number
        applyHighlightColor(v, color, {suppressReload: true});
    });

    // clear selection and reload once
    document.querySelectorAll('.verse-selected').forEach(el => el.classList.remove('verse-selected'));
    selectedVerses.clear();
    saveUserData();
    const p = document.getElementById('highlight-palette'); if (p) p.remove();
    loadVerses(currentBook.id, currentChapter);
}

// Remove highlight(s) for selected verses (or single verse if none selected)
function removeHighlightFromSelected() {
    if (selectedVerses.size === 0) return;
    selectedVerses.forEach(v => {
        applyHighlightColor(v, null, {suppressReload: true});
    });
    document.querySelectorAll('.verse-selected').forEach(el => el.classList.remove('verse-selected'));
    selectedVerses.clear();
    saveUserData();
    const p = document.getElementById('highlight-palette'); if (p) p.remove();
    loadVerses(currentBook.id, currentChapter);
}

// Remove a highlight by book/chapter/verse (used in Highlights list)
function removeHighlightByKey(book, chapter, verse) {
    const idx = userData.highlights.findIndex(h => h.book === book && h.chapter === chapter && h.verse === verse);
    if (idx >= 0) {
        userData.highlights.splice(idx,1);
        saveUserData();
        showHighlights();
        if (currentBook && currentBook.id === book && currentChapter === chapter) {
            loadVerses(book, chapter);
        }
        showToast('Highlight removed');
    }
}
// Update points display
function updateGamePointsDisplay() {
    const pointsDisplay = document.getElementById('user-points-display');
    if (pointsDisplay) pointsDisplay.textContent = userData.gamePoints || 0;
    
    // Update high scores on game cards
    document.getElementById('quiz-highscore').textContent = (userData.quizHighScore || 0) + ' points';
    document.getElementById('cap-streak').textContent = (userData.capBestStreak || 0) + ' correct';
    document.getElementById('match-highscore').textContent = (userData.matchHighScore || 0) + ' points';
    document.getElementById('riddles-solved').textContent = (userData.riddlesSolved || 0) + ' riddles';
}

// Add points to user score
function addGamePoints(points, gameType) {
    userData.gamePoints = (userData.gamePoints || 0) + points;
    
    // Update specific game stats
    if (gameType === 'quiz' && points > (userData.quizHighScore || 0)) {
        userData.quizHighScore = points;
    }
    if (gameType === 'cap' && points > (userData.capBestStreak || 0)) {
        userData.capBestStreak = points;
    }
    if (gameType === 'match' && points > (userData.matchHighScore || 0)) {
        userData.matchHighScore = points;
    }
    if (gameType === 'riddles') {
        userData.riddlesSolved = (userData.riddlesSolved || 0) + points;
    }
    
    saveUserData();
    updateGamePointsDisplay();
    showToast(`+${points} points! üéâ`);
}

// Game starter functions (we'll build these next)
function startBibleQuiz() {
    showToast('Bible Quiz coming soon! üöÄ');
    // We'll build this game next
}




function startVerseMatch() {
    showToast('Verse Match coming soon! üß©');
}

function startBibleRiddles() {
    showToast('Bible Riddles coming soon! üé≠');
}
        
// === INITIALIZATION ===
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await initializeApp();
                if (typeof initializeOriginalWords === 'function') await initializeOriginalWords();

                // Fallback bindings: ensure leaderboard nav always triggers the leaderboard
                try {
                    const bindLeaderboardClick = (el) => {
                        if (!el) return;
                        // avoid duplicate binding
                        if (el.__lbBound) return;
                        el.addEventListener('click', (ev) => {
                            ev.preventDefault();
                            // Use showSection to keep navigation behavior consistent
                            showSection('leaderboard-section');
                        });
                        el.__lbBound = true;
                    };

                    // Primary nav item
                    bindLeaderboardClick(document.getElementById('nav-leaderboard'));

                    // Any element that targets leaderboard-section via data-target
                    document.querySelectorAll('[data-target="leaderboard-section"]').forEach(bindLeaderboardClick);
                } catch (bindErr) {
                    console.warn('Leaderboard fallback binding failed', bindErr);
                }

            } catch (err) {
                console.error('Error during initialization:', err);
            }
        });
    // Clear verse selection when clicking/tapping outside verses or the palette
    document.addEventListener('click', (ev) => {
        const isVerse = !!ev.target.closest('.verse-inline');
        const isPalette = !!ev.target.closest('#highlight-palette');
        if (!isVerse && !isPalette) {
            // remove visual markers
            document.querySelectorAll('.verse-selected').forEach(el => el.classList.remove('verse-selected'));
            selectedVerses.clear();
            // also remove any open palette
            const p = document.getElementById('highlight-palette'); if (p) p.remove();
        }
    });
function toggleShowOriginal() {
    const showOriginal = document.getElementById('show-original-toggle').checked;
    userData.showOriginalText = showOriginal;
    saveUserData();
    
    // Update all displays
    updateAllDisplays();
    
    // Show notification
    showToast(showOriginal ? 'Now showing original text too!' : 'Showing Gen Z translation only');
}
      
function updateAllDisplays() {
    // Update daily verse
    updateDailyVerseDisplay();
    
    // Update Bible reading if active
    if (currentBook && currentChapter) {
        loadVerses(currentBook.id, currentChapter);
    }
    
}
function updateMotivationDisplay() {
    const originalTexts = document.querySelectorAll('#motivation-section .original-text');
    
    originalTexts.forEach(text => {
        if (userData.showOriginalText) {
            text.style.display = 'block';
        } else {
            text.style.display = 'none';
        }
    });
}
function updateDailyVerseDisplay() {
    const originalTextElement = document.getElementById('daily-verse-text');
    
    if (userData.showOriginalText) {
        // Show both original and Gen Z (like current setup)
        originalTextElement.style.display = 'block';
    } else {
        // Hide original text, show only Gen Z
        originalTextElement.style.display = 'none';
    }
}

async function initializeApp() {
    loadUserData();
    initializeNavigation();
    showBottomNav();
    updateUI();
    setDailyVerse();
    loadSettings();
    updateGamePointsDisplay();
    initializeBibleSection(); // This will load John 1 directly
    
    // Preload common Bible books...
    console.log('üîÑ Preloading common Bible books...');
    preloadCommonBooks().then(() => {
        console.log('‚úÖ Common Bible books loaded successfully');
    }).catch(error => {
        console.error('‚ùå Failed to load Bible books:', error);
    });

    // Ensure leaderboard avatars are cleaned up (replace emoji or invalid avatar values)
    (async function cleanAvatarsOnStart(){
        try {
            if (!db) await initDB();
            const lb = await dbGet('leaderboard','scores');
            if (lb && Array.isArray(lb.users)) {
                let changed = false;
                lb.users.forEach(u => {
                    // Do not assign a random avatar to the real user, only to fake leaderboard entries.
                    if (u.name === userData.name) return;
                    
                    // if avatar is missing or not an image path/object, assign one
                    if (!u.avatar || (typeof u.avatar === 'string' && !/\.(jpe?g|png|gif|webp|svg)$/i.test(u.avatar))) {
                        assignAvatarToUser(u);
                        changed = true;
                    } else if (typeof u.avatar === 'object' && !u.avatar.url && !u.avatar.dataURL) {
                        assignAvatarToUser(u);
                        changed = true;
                    }
                });
                if (changed) await dbSet('leaderboard', { id: 'scores', users: lb.users, lastUpdated: new Date().toISOString() });
            }
        } catch(e) { console.warn('cleanAvatarsOnStart failed', e); }
    })();

    // Update leaderboard scores every 24 hours to keep things fresh
    try {
        setInterval(() => {
            updateLeaderboardScores().catch(err => console.warn('updateLeaderboardScores failed', err));
        }, 24 * 60 * 60 * 1000); // 24 hours
    } catch (e) { console.warn('Could not schedule leaderboard update', e); }
}

function setDailyVerse() {
    const dailyVerse = getDailyVerse();
    
    if (dailyVerse) {
        document.getElementById('daily-verse-reference').textContent = dailyVerse.reference;
        document.getElementById('daily-verse-text').textContent = `"${dailyVerse.text}"`;
        document.getElementById('daily-verse-genz').textContent = dailyVerse.genZ;
    }
    
    // Apply user preference
    updateDailyVerseDisplay();
}

    
const dailyChallenges = [
    "Share an encouraging Bible verse with someone who needs it today.",
    "Pray for 5 minutes without distractions.",
    "Read one chapter of Proverbs corresponding to today's date.",
    "Memorize John 3:16 and say it out loud.",
    "Send a text to encourage a friend with scripture.",
    "Thank God for 3 specific blessings in your life.",
    "Fast from social media for 2 hours and spend that time with God.",
    "Listen to worship music during your commute/workout.",
    "Forgive someone who hurt you and pray for them.",
    "Share your testimony with someone this week.",
    "Volunteer to help someone in need today.",
    "Write down 5 things you're grateful for.",
    "Pray for your national leaders and government.",
    "Read Psalms 23 and meditate on it.",
    "Compliment 3 people genuinely today.",
    "Donate(sacrifice) to a cause that helps others.",
    "Avoid complaining for 24 hours.",
    "Pray for the salvation of 3 people you know.",
    "Read the story of the Good Samaritan (Luke 10:25-37).",
    "Send an appreciation message to your pastor/church leader.",
    "Fast from one meal and pray during that time.",
    "Write a prayer journal entry.",
    "Pray for peace in conflict areas around the world.",
    "Compliment a family member you often take for granted.",
    "Read about the fruit of the Spirit in Galatians 5:22-23.",
    "Apologize to someone you've wronged.",
    "Pray for the homeless and less fortunate.",
    "Share a Bible verse on your social media.",
    "Invite someone to church this weekend."
];

// REPLACE your entire loadUserData function with this:
async function loadUserData() {
    try {
        if (!db) await initDB();
        const savedData = await dbGet('userData', 'main');
        
        if (savedData) {
            userData = savedData;
            showRandomGreeting();
            setDailyChallenge();
        } else {
            // First time user - show modal
            document.getElementById('username-modal').classList.add('active');
            userData = { 
                id: 'main',
                name: "Friend", 
                streak: 0, 
                lastLogin: null, 
                highlights: [], 
                challengeCompleted: false,
                currentChallenge: "",
                lastChallengeDate: "",
                gamePoints: 0,
                quizHighScore: 0,
                capBestStreak: 0,
                matchHighScore: 0,
                riddlesSolved: 0,
                prayerCount: 0,
                sharesCount: 0,
                booksRead: 0,
                motivationVisits: 0,
                historyVisits: 0,
                studyTopics: 0,
                showOriginalText: false
            };
        }
    } catch (error) {
        console.error('Error loading user data:', error);
    }
    
    // Check if user logged in today
    checkStreak();
}

// ADD THIS NEW function (put it after loadUserData):
function setDailyChallenge() {
    const today = new Date().toDateString();
    
    // If it's a new day, reset challenge and pick new one
    if (userData.lastChallengeDate !== today) {
        userData.challengeCompleted = false;
        userData.lastChallengeDate = today;
        
        // Get challenge based on day of month
        const dayOfMonth = new Date().getDate();
        const challengeIndex = (dayOfMonth - 1) % dailyChallenges.length;
        userData.currentChallenge = dailyChallenges[challengeIndex];
        
        saveUserData();
    }
    
    // Update UI with today's challenge
    if (userData.currentChallenge) {
        document.querySelector('#challenge-card .card-description').textContent = userData.currentChallenge;
    }
}

const verseOfTheDayList = [
    { "reference": "Matthew 6:33", "text": "But seek ye first the kingdom of God, and his righteousness; and all these things shall be added unto you.", "genZ": "Chase God's kingdom first, and stay right with Him‚Äîeverything else? It'll pull up on time." },
    { "reference": "Proverbs 3:5", "text": "Trust in the Lord with all thine heart; and lean not unto thine own understanding.", "genZ": "Put your full trust in God‚Äîdon't vibe off your own logic." },
    { "reference": "Isaiah 40:31", "text": "But they that wait upon the Lord shall renew their strength; they shall mount up with wings as eagles; they shall run, and not be weary; and they shall walk, and not faint.", "genZ": "Those who stay locked on God get recharged‚Äîthey'll rise like eagles, run with no burnout, walk with no flop." },
    { "reference": "Romans 12:2", "text": "And be not conformed to this world: but be ye transformed by the renewing of your mind, that ye may prove what is that good, and acceptable, and perfect, will of God.", "genZ": "Don't copy the world's vibe‚Äîlet God reset your mindset so you can flex His perfect plan." },
    { "reference": "Psalm 23:1", "text": "The Lord is my shepherd; I shall not want.", "genZ": "God's my guide‚ÄîI'm set, no lacking." },
    { "reference": "Philippians 4:13", "text": "I can do all things through Christ which strengtheneth me.", "genZ": "I can handle anything‚ÄîChrist powers me up." },
    { "reference": "James 1:5", "text": "If any of you lack wisdom, let him ask of God, that giveth to all men liberally, and upbraideth not; and it shall be given him.", "genZ": "If you're low on wisdom, ask God‚ÄîHe drops it freely, no shade, no gatekeeping." },
    { "reference": "2 Timothy 1:7", "text": "For God hath not given us the spirit of fear; but of power, and of love, and of a sound mind.", "genZ": "God didn't hand us fear‚ÄîHe gave us power, love, and clear-headed focus." },
    { "reference": "Psalm 119:105", "text": "Thy word is a lamp unto my feet, and a light unto my path.", "genZ": "Your word's my flashlight‚Äîit keeps my steps lit and my path clear." },
    { "reference": "Galatians 6:9", "text": "And let us not be weary in well doing: for in due season we shall reap, if we faint not.", "genZ": "Don't tap out while doing good‚Äîharvest hits in God's time if you don't quit." },
    { "reference": "John 14:6", "text": "Jesus saith unto him, I am the way, the truth, and the life: no man cometh unto the Father, but by me.", "genZ": "Jesus said, I'm the route, the real, and the life‚Äîno one gets to God without Me." },
    { "reference": "1 Peter 5:7", "text": "Casting all your care upon him; for he careth for you.", "genZ": "Drop all your stress on Him‚ÄîHe actually cares, fr." },
    { "reference": "Hebrews 11:1", "text": "Now faith is the substance of things hoped for, the evidence of things not seen.", "genZ": "Faith is the real grip on what you're hoping for‚Äîit's proof of what you can't see yet." },
    { "reference": "Psalm 46:1", "text": "God is our refuge and strength, a very present help in trouble.", "genZ": "God's our safe zone and power-up‚Äîalways right there when life hits hard." },
    { "reference": "Matthew 11:28", "text": "Come unto me, all ye that labour and are heavy laden, and I will give you rest.", "genZ": "If you're tired and carrying too much, pull up on Me‚ÄîI'll give you real rest." },
    { "reference": "Joshua 1:9", "text": "Have not I commanded thee? Be strong and of a good courage; be not afraid, neither be thou dismayed: for the Lord thy God is with thee whithersoever thou goest.", "genZ": "Didn't I tell you? Stay bold, stay brave‚Äîno fear, no panic. God's rolling with you everywhere." },
    { "reference": "Colossians 3:23", "text": "And whatsoever ye do, do it heartily, as to the Lord, and not unto men;", "genZ": "Whatever you're on, go all in‚Äîdo it for God, not for clout." },
    { "reference": "Psalm 34:18", "text": "The Lord is nigh unto them that are of a broken heart; and saveth such as be of a contrite spirit.", "genZ": "God's close to the ones with shattered hearts‚ÄîHe saves those who stay humble and real." },
    { "reference": "Ephesians 6:11", "text": "Put on the whole armour of God, that ye may be able to stand against the wiles of the devil.", "genZ": "Suit up in God's full armor‚Äîso you can stand firm when the enemy tries to play you." },
    { "reference": "Proverbs 18:10", "text": "The name of the Lord is a strong tower: the righteous runneth into it, and is safe.", "genZ": "God's name is a safe tower‚Äîreal ones run to it and stay protected." },
    { "reference": "Romans 8:28", "text": "And we know that all things work together for good to them that love God, to them who are the called according to his purpose.", "genZ": "We know everything syncs for good‚Äîfor those who love God and are locked into His purpose." },
    { "reference": "Micah 6:8", "text": "He hath shewed thee, O man, what is good; and what doth the Lord require of thee, but to do justly, and to love mercy, and to walk humbly with thy God?", "genZ": "God already showed you what's good‚Äîdo right, show mercy, and walk lowkey with Him." },
    { "reference": "Matthew 5:16", "text": "Let your light so shine before men, that they may see your good works, and glorify your Father which is in heaven.", "genZ": "Let your light hit different‚Äîso people catch your good moves and shout out God for it." },
    { "reference": "1 Corinthians 10:13", "text": "There hath no temptation taken you but such as is common to man: but God is faithful, who will not suffer you to be tempted above that ye are able; but will with the temptation also make a way to escape, that ye may be able to bear it.", "genZ": "No temptation hits you that ain't human-level‚Äîbut God's loyal. He won't let it go past your limit, and He always drops an exit route so you can handle it." },
    { "reference": "Psalm 37:4", "text": "Delight thyself also in the Lord: and he shall give thee the desires of thine heart.", "genZ": "Lock in with God and vibe with Him‚ÄîHe'll drop the real desires of your heart." },
    { "reference": "Jeremiah 29:11", "text": "For I know the thoughts that I think toward you, saith the Lord, thoughts of peace, and not of evil, to give you an expected end.", "genZ": "God says, I know the plans I've got for you‚Äîpeace-filled, not toxic. I'm setting you up for a solid future." },
    { "reference": "1 John 4:4", "text": "Ye are of God, little children, and have overcome them: because greater is he that is in you, than he that is in the world.", "genZ": "You're God's crew, and you've already beat the noise‚Äî'cause the One in you is way bigger than the world's hype." },
    { "reference": "Psalm 121:1-2", "text": "I will lift up mine eyes unto the hills, from whence cometh my help. My help cometh from the Lord, which made heaven and earth.", "genZ": "I look up to the hills‚Äîwhere my help drops from. My help's from God, the Creator of everything." },
    { "reference": "Isaiah 41:10", "text": "Fear thou not; for I am with thee: be not dismayed; for I am thy God: I will strengthen thee; yea, I will help thee; yea, I will uphold thee with the right hand of my righteousness.", "genZ": "Don't stress‚ÄîI'm with you. Don't freak‚ÄîI'm your God. I'll boost you, help you, and hold you steady with My righteous grip." },
    { "reference": "John 10:10", "text": "The thief cometh not, but for to steal, and to kill, and to destroy: I am come that they might have life, and that they might have it more abundantly.", "genZ": "The enemy only pulls up to steal, wreck, and delete‚Äîbut I came so you can live full, and live loud." },
    { "reference": "Genesis 50:20", "text": "But as for you, ye thought evil against me; but God meant it unto good, to bring to pass, as it is this day, to save much people alive.", "genZ": "You tried to play me, but God flipped it for good‚Äîto save lives, just like now." },
    { "reference": "Psalm 27:1", "text": "The Lord is my light and my salvation; whom shall I fear? the Lord is the strength of my life; of whom shall I be afraid?", "genZ": "God's my light and rescue‚Äîwho am I supposed to fear? He's my strength, I'm not scared of anyone." },
    { "reference": "Romans 5:8", "text": "But God commendeth his love toward us, in that, while we were yet sinners, Christ died for us.", "genZ": "God showed love heavy‚ÄîChrist died for us while we were still wildin'." },
    { "reference": "1 Thessalonians 5:16-18", "text": "Rejoice evermore. Pray without ceasing. In every thing give thanks: for this is the will of God in Christ Jesus concerning you.", "genZ": "Keep the joy on. Stay praying nonstop. Be thankful in everything‚Äîthis is God's vibe for you in Christ." },
    { "reference": "Isaiah 26:3", "text": "Thou wilt keep him in perfect peace, whose mind is stayed on thee: because he trusteth in thee.", "genZ": "You'll keep in full peace the one who stays locked on You‚Äî'cause they trust You." },
    { "reference": "James 4:7", "text": "Submit yourselves therefore to God. Resist the devil, and he will flee from you.", "genZ": "Lock in with God. Push back on the enemy‚Äîand he'll dip fast." },
    { "reference": "Psalm 19:14", "text": "Let the words of my mouth, and the meditation of my heart, be acceptable in thy sight, O Lord, my strength, and my redeemer.", "genZ": "Let my words and heart vibes be cool with You, Lord‚Äîmy strength and my rescue." },
    { "reference": "Luke 1:37", "text": "For with God nothing shall be impossible.", "genZ": "With God, impossible doesn't exist." },
    { "reference": "1 Corinthians 16:13", "text": "Watch ye, stand fast in the faith, quit you like men, be strong.", "genZ": "Stay woke, stand firm in faith, move bold, stay strong." },
    { "reference": "Psalm 91:1", "text": "He that dwelleth in the secret place of the most High shall abide under the shadow of the Almighty.", "genZ": "Whoever chills in God's secret zone stays covered under His power." },
    { "reference": "Psalm 121:7-8", "text": "The Lord shall preserve thee from all evil: he shall preserve thy soul. The Lord shall preserve thy going out and thy coming in from this time forth, and even for evermore.", "genZ": "God's got you covered from all evil‚ÄîHe's guarding your soul. He's watching your moves in and out, now and forever." },
    { "reference": "Romans 12:21", "text": "Be not overcome of evil, but overcome evil with good.", "genZ": "Don't let evil win‚Äîbeat it with good." },
    { "reference": "Proverbs 3:6", "text": "In all thy ways acknowledge him, and he shall direct thy paths.", "genZ": "In everything you do, shout Him out‚ÄîHe'll guide your steps." },
    { "reference": "Isaiah 43:2", "text": "When thou passest through the waters, I will be with thee; and through the rivers, they shall not overflow thee: when thou walkest through the fire, thou shalt not be burned; neither shall the flame kindle upon thee.", "genZ": "When you're deep in it, I'm with you. Floods won't drown you. Fire won't burn you. Flames won't touch you." },
    { "reference": "Matthew 6:34", "text": "Take therefore no thought for the morrow: for the morrow shall take thought for the things of itself. Sufficient unto the day is the evil thereof.", "genZ": "Don't stress tomorrow‚Äîtomorrow's got its own stuff. Today's got enough to handle." },
    { "reference": "Psalm 37:5", "text": "Commit thy way unto the Lord; trust also in him; and he shall bring it to pass.", "genZ": "Drop your plans on God, trust Him‚ÄîHe'll make it happen." },
    { "reference": "John 15:5", "text": "I am the vine, ye are the branches: He that abideth in me, and I in him, the same bringeth forth much fruit: for without me ye can do nothing.", "genZ": "I'm the vine, you're the branches. Stay connected‚Äîyou'll bear fruit. Without Me, you're offline." },
    { "reference": "Proverbs 16:3", "text": "Commit thy works unto the Lord, and thy thoughts shall be established.", "genZ": "Hand your grind to God‚ÄîHe'll lock in your mindset." },
    { "reference": "1 John 1:9", "text": "If we confess our sins, he is faithful and just to forgive us our sins, and to cleanse us from all unrighteousness.", "genZ": "If we own our sins, He's loyal and fair to forgive and clean us up." },
    { "reference": "Psalm 56:3", "text": "What time I am afraid, I will trust in thee.", "genZ": "Whenever fear hits, I'm trusting You." },
    { "reference": "Galatians 5:22-23", "text": "But the fruit of the Spirit is love, joy, peace, longsuffering, gentleness, goodness, faith, Meekness, temperance: against such there is no law.", "genZ": "The Spirit's fruit? Love, joy, peace, patience, kindness, goodness, faith, Humility, self-control‚Äîno rules block these." },
    { "reference": "Psalm 46:10", "text": "Be still, and know that I am God: I will be exalted among the heathen, I will be exalted in the earth.", "genZ": "Pause and know I'm God‚ÄîI'll be lifted up everywhere." },
    { "reference": "Ephesians 2:10", "text": "For we are his workmanship, created in Christ Jesus unto good works, which God hath before ordained that we should walk in them.", "genZ": "We're God's craft‚Äîmade in Christ to do good. He set it up before we even stepped in." },
    { "reference": "Colossians 2:6-7", "text": "As ye have therefore received Christ Jesus the Lord, so walk ye in him: Rooted and built up in him, and stablished in the faith, as ye have been taught, abounding therein with thanksgiving.", "genZ": "Since you've received Christ, walk in Him. Stay rooted, built up, locked in faith, overflowing with thanks." },
    { "reference": "Psalm 119:11", "text": "Thy word have I hid in mine heart, that I might not sin against thee.", "genZ": "I've stashed Your word in my heart‚Äîso I don't mess up against You." },
    { "reference": "2 Corinthians 12:9", "text": "And he said unto me, My grace is sufficient for thee: for my strength is made perfect in weakness. Most gladly therefore will I rather glory in my infirmities, that the power of Christ may rest upon me.", "genZ": "He told me, My grace is enough‚ÄîMy power hits hardest when you're weak. So I'll flex in my flaws, so Christ's power can rest on me." },
    { "reference": "Matthew 5:9", "text": "Blessed are the peacemakers: for they shall be called the children of God.", "genZ": "Shoutout to the peacemakers‚Äîthey're God's kids." },
    { "reference": "Psalm 84:11", "text": "For the Lord God is a sun and shield: the Lord will give grace and glory: no good thing will he withhold from them that walk uprightly.", "genZ": "God's our light and shield‚ÄîHe gives grace and glory. He won't hold back good from those who walk right." },
    { "reference": "1 Corinthians 1:25", "text": "Because the foolishness of God is wiser than men; and the weakness of God is stronger than men.", "genZ": "Even God's foolish moves are wiser than humans. His weak side? Stronger than all of us." },
    { "reference": "Deuteronomy 31:6", "text": "Be strong and of a good courage, fear not, nor be afraid of them: for the Lord thy God, he it is that doth go with thee; he will not fail thee, nor forsake thee.", "genZ": "Stay bold, don't fold‚ÄîGod's rolling with you. He won't dip or ditch you." },
    { "reference": "Psalm 34:4", "text": "I sought the Lord, and he heard me, and delivered me from all my fears.", "genZ": "I reached out to God‚ÄîHe heard me and cleared all my fear." },
    { "reference": "Romans 10:9", "text": "That if thou shalt confess with thy mouth the Lord Jesus, and shalt believe in thine heart that God hath raised him from the dead, thou shalt be saved.", "genZ": "Say it loud: Jesus is Lord. Believe deep that God raised Him‚Äîand you're saved." },
    { "reference": "Isaiah 40:29", "text": "He giveth power to the faint; and to them that have no might he increaseth strength.", "genZ": "He powers up the weak‚Äîboosts strength when you're running on empty." },
    { "reference": "John 3:16", "text": "For God so loved the world, that he gave his only begotten Son, that whosoever believeth in him should not perish, but have everlasting life.", "genZ": "God loved the world heavy‚ÄîHe gave His only Son. Believe in Him, and you get eternal life." },
    { "reference": "Proverbs 18:21", "text": "Death and life are in the power of the tongue: and they that love it shall eat the fruit thereof.", "genZ": "Your words carry life or death‚Äîspeak wisely, you'll eat the outcome." },
    { "reference": "2 Chronicles 7:14", "text": "If my people, which are called by my name, shall humble themselves, and pray, and seek my face, and turn from their wicked ways; then will I hear from heaven, and will forgive their sin, and will heal their land.", "genZ": "If My crew humble up, pray, chase Me, and drop the wrong stuff‚ÄîI'll hear, forgive, and heal the land." },
    { "reference": "Psalm 91:4", "text": "He shall cover thee with his feathers, and under his wings shalt thou trust: his truth shall be thy shield and buckler.", "genZ": "He'll cover you like wings‚Äîtrust under His shelter. His truth is your shield and armor." },
    { "reference": "Hebrews 13:8", "text": "Jesus Christ the same yesterday, and to day, and for ever.", "genZ": "Jesus stays the same‚Äîyesterday, today, forever. No switch-ups." },
    { "reference": "Matthew 22:37", "text": "Jesus said unto him, Thou shalt love the Lord thy God with all thy heart, and with all thy soul, and with all thy mind.", "genZ": "Jesus said: Love God with all your heart, soul, and mind‚Äîfull send." },
    { "reference": "Psalm 103:2", "text": "Bless the Lord, O my soul, and forget not all his benefits:", "genZ": "Shout praise to God, soul‚Äîdon't sleep on His blessings." },
    { "reference": "1 John 4:18", "text": "There is no fear in love; but perfect love casteth out fear: because fear hath torment. He that feareth is not made perfect in love.", "genZ": "Real love cancels fear‚Äîperfect love kicks it out. Fear brings torment, not love." },
    { "reference": "James 1:12", "text": "Blessed is the man that endureth temptation: for when he is tried, he shall receive the crown of life, which the Lord hath promised to them that love him.", "genZ": "Blessed is the one who holds it down through temptation‚ÄîGod's got a crown of life waiting." },
    { "reference": "Psalm 145:18", "text": "The Lord is nigh unto all them that call upon him, to all that call upon him in truth.", "genZ": "God's close to everyone who calls Him‚Äîespecially when it's real." },
    { "reference": "Ephesians 4:29", "text": "Let no corrupt communication proceed out of your mouth, but that which is good to the use of edifying, that it may minister grace unto the hearers.", "genZ": "Don't let trash talk fly‚Äîspeak what builds up and drops grace on the listeners." },
    { "reference": "Psalm 62:6", "text": "He only is my rock and my salvation: he is my defence; I shall not be moved.", "genZ": "He's my rock, my rescue, my defense‚ÄîI'm unshaken." },
    { "reference": "2 Peter 3:9", "text": "The Lord is not slack concerning his promise, as some men count slackness; but is longsuffering to us-ward, not willing that any should perish, but that all should come to repentance.", "genZ": "God's not slow with His promise‚ÄîHe's just patient, wanting everyone to turn and live." },
    { "reference": "Psalm 119:130", "text": "The entrance of thy words giveth light; it giveth understanding unto the simple.", "genZ": "Your Word brings light‚Äîit gives clarity even to the simple." },
    { "reference": "Matthew 28:20b", "text": "lo, I am with you alway, even unto the end of the world. Amen.", "genZ": "I'm with you always‚Äîtill the world wraps. Amen." },
    { "reference": "Psalm 23:4", "text": "Yea, though I walk through the valley of the shadow of death, I will fear no evil: for thou art with me; thy rod and thy staff they comfort me.", "genZ": "Even when I'm deep in the dark zone, I'm not scared‚ÄîYou're with me. Your tools keep me calm." },
    { "reference": "Romans 6:23", "text": "For the wages of sin is death; but the gift of God is eternal life through Jesus Christ our Lord.", "genZ": "Sin pays in death‚Äîbut God's gift is eternal life through Jesus." },
    { "reference": "Proverbs 1:7", "text": "The fear of the Lord is the beginning of knowledge: but fools despise wisdom and instruction.", "genZ": "Respecting God is where real knowledge starts‚Äîfools hate wisdom and guidance." },
    { "reference": "John 1:5", "text": "And the light shineth in darkness; and the darkness comprehended it not.", "genZ": "Light shines in the dark‚Äîand the dark can't decode it." },
    { "reference": "Isaiah 55:8-9", "text": "For my thoughts are not your thoughts, neither are your ways my ways, saith the Lord. For as the heavens are higher than the earth, so are my ways higher than your ways, and my thoughts than your thoughts.", "genZ": "God says, My thoughts ain't yours, My ways ain't yours. Mine are way higher‚Äîsky-level above yours." },
    { "reference": "Matthew 7:13-14", "text": "Enter ye in at the strait gate: for wide is the gate, and broad is the way, that leadeth to destruction, and many there be which go in thereat: Because strait is the gate, and narrow is the way, which leadeth unto life, and few there be that find it.", "genZ": "Go through the tight gate‚Äî'cause the wide one leads to destruction, and lots go that way. The narrow path leads to life‚Äîbut few even find it." },
    { "reference": "Psalm 51:10", "text": "Create in me a clean heart, O God; and renew a right spirit within me.", "genZ": "God, give me a clean heart‚Äîreset my spirit to be right." },
    { "reference": "1 Corinthians 13:4-5", "text": "Charity suffereth long, and is kind; charity envieth not; charity vaunteth not itself, is not puffed up, Doth not behave itself unseemly, seeketh not her own, is not easily provoked, thinketh no evil;", "genZ": "Love stays patient and kind. No envy, no flexing, no ego. It's not messy, not selfish, not hot-headed, not shady." },
    { "reference": "Philippians 2:3", "text": "Let nothing be done through strife or vainglory; but in lowliness of mind let each esteem other better than themselves.", "genZ": "Don't do stuff for drama or clout‚Äîstay humble and lift others above yourself." },
    { "reference": "Psalm 27:14", "text": "Wait on the Lord: be of good courage, and he shall strengthen thine heart: wait, I say, on the Lord.", "genZ": "Wait on God. Stay brave‚ÄîHe'll boost your heart. Yeah, wait on Him." },
    { "reference": "Galatians 2:20", "text": "I am crucified with Christ: nevertheless I live; yet not I, but Christ liveth in me: and the life which I now live in the flesh I live by the faith of the Son of God, who loved me, and gave himself for me.", "genZ": "I died with Christ‚Äîbut I'm alive. Not me, but Christ lives in me. This life? I live by faith in the One who loved me and gave Himself for me." },
    { "reference": "Proverbs 15:1", "text": "A soft answer turneth away wrath: but grievous words stir up anger.", "genZ": "A chill reply cools down heat‚Äîbut harsh words spark rage." },
    { "reference": "John 14:27", "text": "Peace I leave with you, my peace I give unto you: not as the world giveth, give I unto you. Let not your heart be troubled, neither let it be afraid.", "genZ": "I'm leaving you peace‚ÄîMy kind, not the world's. Don't let your heart stress or fear." },
    { "reference": "Psalm 100:4", "text": "Enter into his gates with thanksgiving, and into his courts with praise: be thankful unto him, and bless his name.", "genZ": "Pull up to His space with thanks, step in with praise‚Äîstay grateful and bless His name." },
    { "reference": "1 Peter 2:9", "text": "But ye are a chosen generation, a royal priesthood, an holy nation, a peculiar people; that ye should shew forth the praises of him who hath called you out of darkness into his marvellous light:", "genZ": "You're chosen‚Äîroyal squad, holy crew, set-apart people. You're here to rep the One who pulled you out of darkness into His wild light." },
    { "reference": "Ecclesiastes 3:1", "text": "To every thing there is a season, and a time to every purpose under the heaven:", "genZ": "Everything's got its season‚Äîevery purpose has its time under heaven." },
    { "reference": "Matthew 5:14", "text": "Ye are the light of the world. A city that is set on an hill cannot be hid.", "genZ": "You're the world's light. A city on a hill? Can't be hidden." },
    { "reference": "Psalm 119:105", "text": "Thy word is a lamp unto my feet, and a light unto my path.", "genZ": "Your Word lights my steps and keeps my path glowing." },
    { "reference": "2 Timothy 2:15", "text": "Study to shew thyself approved unto God, a workman that needeth not to be ashamed, rightly dividing the word of truth.", "genZ": "Study up to show you're solid before God‚Äîa worker with no shame, slicing truth right." }
];
// ADD THIS function
function getDailyVerse() {
    // Get verse based on day of month (consistent daily)
    const dayOfMonth = new Date().getDate();
    const verseIndex = (dayOfMonth - 1) % verseOfTheDayList.length;
    return verseOfTheDayList[verseIndex];
}

// KEEP your saveUserData function as is:
async function saveUserData() {
    try {
        if (!db) await initDB();
        userData.id = 'main'; // Ensure ID is set
        await dbSet('userData', userData);
        console.log('‚úÖ User data saved to IndexedDB');
    } catch (error) {
        console.error('Error saving user data:', error);
    }
}

// UPDATE your completeChallenge function (if you haven't already):
function completeChallenge() {
    userData.challengeCompleted = true;
    saveUserData();
    updateUI();
    showToast('Challenge completed! Way to go! üéâ');
}

        function checkStreak() {
    const today = new Date().toDateString();
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayStr = yesterday.toDateString();
    
    // If first time logging in today
    if (userData.lastLogin !== today) {
        // Check if consecutive day (logged in yesterday)
        if (userData.lastLogin === yesterdayStr) {
            userData.streak++; // Increase streak
            showToast(`üî• Streak increased to ${userData.streak} days!`);
        } else if (userData.lastLogin && userData.lastLogin !== today) {
            // Broken streak - reset to 1
            userData.streak = 1;
            showToast('üî• New streak started!');
        } else {
            // First time ever
            userData.streak = 1;
        }
        
        userData.lastLogin = today;
        saveUserData();
        updateUI();
    }
}
function updateUI() {
    // SAFELY update user name
    const userNameElement = document.getElementById('user-name');
    const challengeUserNameElement = document.getElementById('challenge-user-name');
    if (userNameElement) userNameElement.textContent = userData.name;
    if (challengeUserNameElement) challengeUserNameElement.textContent = userData.name;
    
    // SAFELY update streak count
    const streakCountElement = document.getElementById('streak-count');
    if (streakCountElement) streakCountElement.textContent = userData.streak;
    
    // SAFELY update challenge completion
    const challengeBtn = document.getElementById('challenge-btn');
    const challengeComplete = document.getElementById('challenge-complete');
    if (challengeBtn && challengeComplete) {
        if (userData.challengeCompleted) {
            challengeBtn.classList.add('hidden');
            challengeComplete.classList.remove('hidden');
        } else {
            challengeBtn.classList.remove('hidden');
            challengeComplete.classList.add('hidden');
        }
    }
    
    // SAFELY update challenge text
    const challengeDesc = document.querySelector('#challenge-card .card-description');
    if (challengeDesc && userData.currentChallenge) {
        challengeDesc.textContent = userData.currentChallenge;
    }
}

     
        function showChapters(book) {
            // New selector-based chapter view: open the bible selector and show selector chapters
            try {
                if (!book) return;
                currentBook = book;
                currentView = 'chapters';

                // Prefer the full-page selector UI which uses #selector-chapters-grid
                if (typeof openBibleSelector === 'function' && typeof showSelectorChapters === 'function') {
                    openBibleSelector();
                    // showSelectorChapters expects a book id
                    const id = (book.id) ? book.id : book;
                    showSelectorChapters(id);
                    return;
                }

                // Fallback to older inline chapters UI if selector functions are not present
                // Hide books grid
                const booksView = document.querySelector('.bible-books-view');
                if (booksView) booksView.style.display = 'none';
                // Hide the filter/header area when viewing chapters
                const bibleFilter = document.querySelector('.bible-filter-section');
                if (bibleFilter) bibleFilter.classList.add('hidden');

                // Show chapter selection (legacy)
                const chapterSelection = document.getElementById('chapter-selection');
                if (chapterSelection) chapterSelection.classList.add('active');

                // Set title
                const chapterTitle = document.getElementById('chapter-book-title');
                if (chapterTitle) chapterTitle.textContent = `${book.title} - Select Chapter`;

                // Populate chapters (legacy grid)
                const chaptersGrid = document.getElementById('chapters-grid');
                if (!chaptersGrid) {
                    console.error('chapters-grid not found in DOM');
                    return;
                }

                chaptersGrid.innerHTML = '';

                for (let i = 1; i <= book.chapters; i++) {
                    const chapterBtn = document.createElement('button');
                    chapterBtn.className = 'chapter-btn';
                    chapterBtn.textContent = i;
                    chapterBtn.onclick = () => showChapter(book, i);
                    chaptersGrid.appendChild(chapterBtn);
                }

                // Scroll to grid
                setTimeout(() => {
                    if (chaptersGrid) chaptersGrid.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            } catch (err) {
                console.error('showChapters error', err);
            }
        }

        function showChapter(book, chapterNumber) {
            currentChapter = chapterNumber;
            currentView = 'content';
            
            // Hide chapter selection
            document.getElementById('chapter-selection').classList.remove('active');
            // Hide the filter/header area when viewing chapter content
            const bibleFilter = document.querySelector('.bible-filter-section');
            if (bibleFilter) bibleFilter.classList.add('hidden');
            
            // Show content
            const bibleContent = document.getElementById('bible-content');
            bibleContent.classList.remove('hidden');
            document.getElementById('content-book-title').textContent = book.title;
document.getElementById('content-chapter-title').textContent = `Chapter ${chapterNumber}`;
            
        
            // Load verses
            loadVerses(book.id, chapterNumber);
         
          // Alternative: Scroll to the bible header
document.getElementById('content-book-title').scrollIntoView({ behavior: 'smooth' });}

        
   async function loadVerses(bookId, chapterNumber) {
    const versesContainer = document.getElementById('verses-container');
    
    // Show skeleton loading
    versesContainer.innerHTML = `
        <div class="skeleton" style="width: 100%;"></div>
        <div class="skeleton" style="width: 95%;"></div>
        <div class="skeleton" style="width: 98%;"></div>
        <div class="skeleton" style="width: 90%;"></div>
        <div class="skeleton" style="width: 96%;"></div>
    `;
    

    
    const bookInfo = bibleBooks.find(book => book.id === bookId);
    if (!bookInfo) {
        versesContainer.innerHTML = `<div class="verse-container"><p class="text-center text-muted">Book not found: ${bookId}</p></div>`;
        return;
    }
    
    const bookName = bookInfo.title;
    console.log(`üìÑ Loading: ${bookName} ${chapterNumber}`);
    
    versesContainer.innerHTML = `<div class="verse-container"><p class="text-center text-muted">Loading ${bookName} ${chapterNumber}...</p></div>`;
    
    // Load only the requested chapter (lazy-load). This will populate the chapter cache.
    if ((!bibleChapterCache.kjv[bookName] || !bibleChapterCache.kjv[bookName][chapterNumber]) &&
        (!bibleChapterCache.genZ[bookName] || !bibleChapterCache.genZ[bookName][chapterNumber])) {
        console.log(`üî• Lazy-loading ${bookName} chapter ${chapterNumber}...`);
        const chapterData = await loadBibleChapter(bookName, chapterNumber);
        if (!chapterData || (!chapterData.kjv && !chapterData.genZ)) {
            versesContainer.innerHTML = `<div class="verse-container"><p class="text-center text-muted">Could not load ${bookName} ${chapterNumber}. Please try again.</p></div>`;
            return;
        }
        console.log(`‚úÖ Successfully loaded ${bookName} ${chapterNumber}`);
    }
    
    const verses = getChapterVerses(bookName, chapterNumber);
    console.log(`üìñ Verses found:`, verses.length);
    
    if (!verses || verses.length === 0) {
        versesContainer.innerHTML = `<div class="verse-container"><p class="text-center text-muted">No verses found for ${bookName} ${chapterNumber}</p></div>`;
        return;
    }
    
    // Render verses
    versesContainer.innerHTML = '';
    const flow = document.createElement('div');
    flow.className = 'bible-flow';

verses.forEach(verse => {
    const verseNumber = parseInt(verse.verse);

    // Check if this verse is highlighted
    const highlight = userData.highlights.find(h => 
        h.book === bookId && h.chapter === chapterNumber && h.verse === verseNumber
    );

    // Main verse container
    const span = document.createElement('span');
    span.className = `verse-inline ${userData.showOriginalText ? 'stacked' : ''}`;
    span.dataset.verse = verseNumber;
    span.style.transition = 'background 0.18s ease, box-shadow 0.18s ease';

    // Apply highlight color if exists (use translucent rgba so text remains legible)
    if (highlight && highlight.color) {
        const rgba = hexToRgba(highlight.color, 0.22);
        span.style.background = rgba;
        span.style.borderRadius = '4px';
        span.style.padding = '2px 4px';
    }

    // Verse number
    const num = document.createElement('span');
    num.className = 'verse-number';
    num.innerText = verse.verse;

    // Gen Z text
    const genZTxt = document.createElement('span');
    genZTxt.className = 'verse-text verse-genz';
    genZTxt.innerText = ' ' + verse.genZText + ' ';

    span.appendChild(num);
    span.appendChild(genZTxt);

    // KJV text (show only if toggle is ON)
    if (userData.showOriginalText && verse.kjvText) {
        const kjvTxt = document.createElement('div');
        kjvTxt.className = 'verse-kjv';
        kjvTxt.innerText = verse.kjvText;
        span.appendChild(kjvTxt);
    }

    // Tap to select/deselect verse (multi-select supported)
    span.addEventListener('click', (ev) => {
        ev.stopPropagation();
        const v = parseInt(span.dataset.verse);
        if (selectedVerses.has(v)) {
            selectedVerses.delete(v);
            span.classList.remove('verse-selected');
        } else {
            selectedVerses.add(v);
            span.classList.add('verse-selected');
        }

        // Open palette anchored to this verse (so user can pick color for selected verses)
        openHighlightPalette(ev, v, span);
    });

    flow.appendChild(span);
});

// Add long-press highlight functionality
    let pressTimer;
    flow.addEventListener('touchstart', (e) => {
        const target = e.target.closest('.verse-inline');
        if (!target) return;
        
        pressTimer = setTimeout(() => {
            const verseNum = parseInt(target.dataset.verse);
            openHighlightPalette(e, verseNum, target);
        }, 500); // 500ms = half a second hold
    }, { passive: true });
    
    flow.addEventListener('touchend', () => {
        clearTimeout(pressTimer);
    });
    
    flow.addEventListener('touchmove', () => {
        clearTimeout(pressTimer);
    }, { passive: true });
    versesContainer.appendChild(flow);
    console.log(`‚úÖ Successfully rendered ${verses.length} verses`);
}


    function openHighlightPalette(e, verseNumber, containerSpan) {
    e.stopPropagation();
    
    // Remove any existing palette
    const existing = document.getElementById('highlight-palette');
    if (existing) existing.remove();

    const palette = document.createElement('div');
    palette.id = 'highlight-palette';
    palette.className = 'highlight-palette';
    
    // Color options with names
    const colors = [
        { color: '#ffd700', name: 'Gold' },
        { color: '#ff9f1c', name: 'Amber' },
        { color: '#ff6b9d', name: 'Pink' },
        { color: '#f6d55c', name: 'Sun' },
        { color: '#66bb6a', name: 'Green' },
        { color: '#4ecdc4', name: 'Teal' },
        { color: '#42a5f5', name: 'Blue' },
        { color: '#95e1d3', name: 'Mint' },
        { color: '#f38181', name: 'Coral' },
        { color: '#c57ed6', name: 'Lavender' },
        { color: '#aa96da', name: 'Purple' }
    ];

    // Create color swatches
    colors.forEach(({ color, name }) => {
        const sw = document.createElement('div');
        sw.className = 'color-swatch';
        sw.style.background = color;
        sw.setAttribute('data-color', color);
        sw.setAttribute('title', name);
        sw.onclick = (evt) => { 
            if (selectedVerses.size > 0) {
                applyHighlightToSelected(color);
            } else {
                applyHighlightColor(verseNumber, color);
            }
            evt.stopPropagation(); 
        };
        palette.appendChild(sw);
    });

    // Add a remove button
    const clear = document.createElement('div');
    clear.className = 'color-swatch remove-highlight';
    clear.innerHTML = '‚úï';
    clear.setAttribute('title', 'Remove Highlight');
    clear.onclick = (evt) => { 
        if (selectedVerses.size > 0) {
            removeHighlightFromSelected();
        } else {
            applyHighlightColor(verseNumber, null);
        }
        evt.stopPropagation(); 
    };
    palette.appendChild(clear);

    document.body.appendChild(palette);

    // Position the palette - mobile friendly
    const rect = containerSpan.getBoundingClientRect();
    const paletteHeight = 60; // approximate height
    const spaceBelow = window.innerHeight - rect.bottom;
    const spaceAbove = rect.top;
    
    // Position below if there's space, otherwise above
    if (spaceBelow > paletteHeight + 10) {
        palette.style.top = `${rect.bottom + window.scrollY + 8}px`;
    } else {
        palette.style.top = `${rect.top + window.scrollY - paletteHeight - 8}px`;
    }
    
    palette.style.left = `${rect.left + window.scrollX}px`;
    palette.style.position = 'absolute';

    // Close when clicking elsewhere
    setTimeout(() => {
        const clickAway = (ev) => {
            if (!palette.contains(ev.target)) {
                palette.remove();
                document.removeEventListener('click', clickAway);
                document.removeEventListener('touchstart', clickAway);
            }
        };
        document.addEventListener('click', clickAway);
        document.addEventListener('touchstart', clickAway);
    }, 0);
}
        function openHighlightPalette(e, verseNumber, containerSpan) {
            e.stopPropagation();
            // Remove any existing palette
            const existing = document.getElementById('highlight-palette');
            if (existing) existing.remove();

            const palette = document.createElement('div');
            palette.id = 'highlight-palette';
            palette.className = 'highlight-palette';
            const colors = ['#ffd700','#ff9f1c','#ff6b9d','#f6d55c','#66bb6a','#4ecdc4','#42a5f5','#95e1d3','#f38181','#c57ed6','#aa96da'];

            colors.forEach(c => {
                const sw = document.createElement('div');
                sw.className = 'color-swatch';
                sw.style.background = c;
                sw.onclick = (evt) => { 
                    if (selectedVerses.size > 0) {
                        applyHighlightToSelected(c);
                    } else {
                        applyHighlightColor(verseNumber, c);
                    }
                    evt.stopPropagation();
                };
                palette.appendChild(sw);
            });

            // Add a remove button
            const clear = document.createElement('div');
            clear.className = 'color-swatch';
            clear.style.background = 'transparent';
            clear.style.display = 'flex';
            clear.style.alignItems = 'center';
            clear.style.justifyContent = 'center';
            clear.style.fontSize = '0.85rem';
            clear.innerText = '‚úï';
            clear.onclick = (evt) => { 
                if (selectedVerses.size > 0) {
                    removeHighlightFromSelected();
                } else {
                    applyHighlightColor(verseNumber, null);
                }
                evt.stopPropagation();
            };
            palette.appendChild(clear);

            document.body.appendChild(palette);

            // position near the containerSpan
            const rect = containerSpan.getBoundingClientRect();
            palette.style.position = 'absolute';
            palette.style.left = `${rect.left + window.scrollX}px`;
            palette.style.top = `${rect.bottom + window.scrollY + 6}px`;

            // close when clicking elsewhere
            setTimeout(() => {
                const clickAway = (ev) => {
                    if (!palette.contains(ev.target)) {
                        palette.remove();
                        document.removeEventListener('click', clickAway);
                    }
                };
                document.addEventListener('click', clickAway);
            }, 0);
        }

       // Apply highlight color (null removes highlight)
function applyHighlightColor(verseNumber, color, options = {}) {
    // options: { suppressReload: boolean }
    const highlightIndex = userData.highlights.findIndex(h =>
        h.book === currentBook.id && h.chapter === currentChapter && h.verse === verseNumber
    );

    if (color === null) {
        // remove
        if (highlightIndex >= 0) {
            userData.highlights.splice(highlightIndex, 1);
            showToast('Highlight removed');
        }
    } else {
        // Get the verse text from the current session
        const verses = getChapterVerses(currentBook.title, currentChapter);
        const verseData = verses.find(v => parseInt(v.verse) === verseNumber);
        
        if (!verseData) {
            console.error('Verse not found:', verseNumber);
            return;
        }

        const highlight = {
            book: currentBook.id,
            chapter: currentChapter,
            verse: verseNumber,
            text: verseData.genZText || verseData.kjvText, // Use Gen Z text if available
            color: color,
            reference: `${currentBook.title} ${currentChapter}:${verseNumber}`
        };

        if (highlightIndex >= 0) {
            // update color
            userData.highlights[highlightIndex].color = color;
            showToast('Highlight updated! üé®');
        } else {
            userData.highlights.push(highlight);
            showToast('Verse highlighted! ‚≠ê');
        }
    }

    saveUserData();
    
    // remove palette if present
    const p = document.getElementById('highlight-palette'); 
    if (p && !options.suppressReload) p.remove();
    
    // Reload verses to show the highlight unless suppressed
    if (!options.suppressReload) {
        loadVerses(currentBook.id, currentChapter);
    }
}
        // Show highlighted verses
        function showHighlights() {
            showSection('highlights-section');
            const container = document.getElementById('highlights-container');
            const noHighlights = document.getElementById('no-highlights');
            
            if (userData.highlights.length === 0) {
                container.innerHTML = '';
                noHighlights.classList.remove('hidden');
                return;
            }
            
            noHighlights.classList.add('hidden');
            container.innerHTML = '';
            
            userData.highlights.forEach(highlight => {
                const highlightElement = document.createElement('div');
                highlightElement.className = 'card highlight-item';
                highlightElement.innerHTML = `
                    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div class=\"highlight-sample\" style=\"background:${hexToRgba(highlight.color || '#ffd700', 0.35)}; width:18px; height:18px; border-radius:4px; border:1px solid rgba(0,0,0,0.08);\"></div>
                            <div>
                                <h3 class=\"card-title\">${highlight.reference}</h3>
                                <p class=\"card-description\">${highlight.text}</p>
                            </div>
                        </div>
                        <div style=\"display:flex; gap:8px; align-items:center;\">
                            <button class=\"btn btn-secondary\" onclick=\"viewHighlightedVerse('${highlight.book}', ${highlight.chapter}, ${highlight.verse});\">View</button>
                            <button class=\"btn btn-danger\" title=\"Delete highlight\" onclick=\"removeHighlightByKey('${highlight.book}', ${highlight.chapter}, ${highlight.verse});\">‚úï</button>
                        </div>
                    </div>
                `;
                container.appendChild(highlightElement);
            });
        }

        // View a highlighted verse in Bible
        async function viewHighlightedVerse(bookId, chapter, verse) {
            // Find the book
            const book = bibleBooks.find(b => b.id === bookId);
            if (!book) {
                showToast('Book not found');
                return;
            }
            
            // Set current book and chapter
            currentBook = book;
            currentChapter = parseInt(chapter);
            
            // Show the Bible section
            showSection('bible-section');
            
            // Load the verses for this chapter
            await loadVerses(bookId, parseInt(chapter));

            // Update the bottom floating nav display and persist last read
            try {
                currentBook = book; // ensure globals are set
                currentChapter = parseInt(chapter);
                updateBibleNavDisplay();
                if (!db) await initDB();
                await dbSet('settings', { key: 'lastBibleRead', value: { bookId: book.id, chapter: currentChapter } });
            } catch (err) {
                console.error('Error updating last read after viewing highlighted verse:', err);
            }
            
            // Scroll to the specific verse
            setTimeout(() => {
                const versesInPage = document.querySelectorAll('[data-verse]');
                const targetVerse = Array.from(versesInPage).find(el => parseInt(el.dataset.verse) === parseInt(verse));
                if (targetVerse) {
                    targetVerse.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Highlight it briefly to draw attention
                    targetVerse.style.opacity = '0.7';
                    setTimeout(() => {
                        targetVerse.style.transition = 'opacity 0.3s ease';
                        targetVerse.style.opacity = '1';
                    }, 300);
                } else {
                    console.warn(`Verse ${verse} not found in DOM`);
                }
            }, 300);
        }

        function backToBooks() {
            currentView = 'books';
            currentBook = null;
            currentChapter = null;
            
            document.getElementById('chapter-selection').classList.remove('active');
            document.querySelector('.bible-books-view').style.display = 'block';
            // Show the filter/header area when returning to the books list
            const bibleFilter = document.querySelector('.bible-filter-section');
            if (bibleFilter) bibleFilter.classList.remove('hidden');
        }

        function backToChapters() {
            currentView = 'chapters';
            currentChapter = null;
            
            document.getElementById('bible-content').classList.add('hidden');
            document.getElementById('chapter-selection').classList.add('active');
            // keep filter hidden while in chapter selection (since user clicked a book)
            const bibleFilter = document.querySelector('.bible-filter-section');
            if (bibleFilter) bibleFilter.classList.add('hidden');
        }

        function backToHome() {
            showSection('home-section');
        }

        // === BIBLE STUDY MODAL ===
        function showBibleStudy() {
    try {
        console.log('[showBibleStudy] called', new Date().toISOString());

        const modal = document.getElementById('bible-study-modal');
        if (!modal) {
            console.warn('[showBibleStudy] modal element not found');
            return;
        }

        const modalHeader = document.querySelector('#bible-study-modal .modal-header h2');
        const modalBody = document.querySelector('#bible-study-modal .modal-body');

        if (modalHeader) modalHeader.textContent = 'Bible Study Topics';
        if (!modalBody) {
            console.warn('[showBibleStudy] modal body not found');
            modal.classList.add('active'); // still show modal container if present
            return;
        }

        // Clear and reset the modal body
        modalBody.innerHTML = `
        <p class="text-center mb-lg text-muted">Short and sweet notes for when you're on the go.</p>
        <div class="topics-grid" id="topics-grid"></div>
        <div id="topic-detail" class="hidden"></div>
    `;

        // Switch to the full-page bible study section instead of modal
        const section = document.getElementById('bible-study-section');
        if (!section) {
            console.warn('[showBibleStudy] bible-study-section not found, falling back to modal');
            modal.classList.add('active');
            if (typeof populateTopics === 'function') {
                try { populateTopics(); } catch (err) { console.error('[showBibleStudy] populateTopics failed', err); }
            }
            return;
        }

        // Ensure the section has the topics grid and detail container
        section.querySelector('.topics-grid')?.remove();
        section.querySelector('#topic-detail')?.remove();

        section.insertAdjacentHTML('beforeend', `
            <div class="topics-grid" id="topics-grid"></div>
            <div id="topic-detail" class="hidden"></div>
        `);

        // Navigate to the section
        showSection('bible-study-section');

        // Populate topics (reuse existing function which uses #topics-grid)
        if (typeof populateTopics === 'function') {
            try { populateTopics(); }
            catch (err) { console.error('[showBibleStudy] populateTopics failed', err); }
        } else {
            console.warn('[showBibleStudy] populateTopics is not defined');
        }
    } catch (err) {
        console.error('[showBibleStudy] unexpected error', err);
    }
}

        function hideBibleStudy() {
            // When closing the full-page study, return to Activities
            showSection('activities-section');
            try { backToTopics(); } catch (e) { /* ignore */ }
        }

        function populateTopics() {
            const topicsGrid = document.getElementById('topics-grid');
            topicsGrid.innerHTML = '';
            
            Object.entries(bibleStudyTopics).forEach(([key, topic]) => {
                const topicElement = document.createElement('button');
                topicElement.className = 'topic-btn';
                const desc = topic.summary || topic.excerpt || '';
                topicElement.innerHTML = `
                    <div class="topic-title">${topic.title}</div>
                    ${desc ? `<div class="topic-desc">${desc}</div>` : ''}
                `;
                topicElement.onclick = () => showTopicDetail(key);
                topicsGrid.appendChild(topicElement);
            });
        }

        function showTopicDetail(topicKey) {
            const topic = bibleStudyTopics[topicKey];
            const topicsGrid = document.getElementById('topics-grid');
            const topicDetail = document.getElementById('topic-detail');
            
            topicsGrid.style.display = 'none';
            topicDetail.classList.remove('hidden');
            
            topicDetail.innerHTML = `
                <button class="btn btn-secondary mb-lg" onclick="backToTopics()">‚Üê Back to Topics</button>
                <div class="card">
                    <h2 class="card-title">${topic.title}</h2>
                    
                    <h3 class="mb-md">Scripture Backing</h3>
                    ${topic.scriptures.map(verse => `<p class="mb-sm">‚Ä¢ ${verse}</p>`).join('')}
                    
                    <div class="gen-z-translation mt-lg">
                        <div class="gen-z-label">Summary</div>
                        <p>${topic.genZDeepDive}</p>
                    </div>

                    <div class="encouragementS2-item mt-lg">
                       <div class="gen-z-label">Application</div>
                    <p>${topic.application}</p>
                    </div>

                    <div class="encouragement-item mt-lg">
                        <strong>Key Thought:</strong> ${topic.thought}
                    </div>
                      <div class="gen-z-translation mt-lg">
                        <strong>Discussion Questions:</strong> ${topic.discussionQuestions}
                    </div>
                </div>
            `;
        }

        function backToTopics() {
            document.getElementById('topics-grid').style.display = 'grid';
            document.getElementById('topic-detail').classList.add('hidden');
        }

        // === PRAYER FUNCTIONALITY ===
        function startPrayer(topic) {
            const modal = document.getElementById('prayer-modal');
            const title = document.getElementById('prayer-title');
            const content = document.getElementById('prayer-content');
            
            title.textContent = prayerContent[topic].title;
            content.innerHTML = prayerContent[topic].content;
            
            modal.classList.add('active');
        }

        function hidePrayer() {
            const modal = document.getElementById('prayer-modal');
            modal.classList.remove('active');
        }

        // === BIBLE GUIDE FUNCTIONALITY ===
        function showGuideVerses(topic) {
            const guide = bibleGuide[topic];
            const modal = document.getElementById('bible-study-modal');
            const modalHeader = document.querySelector('#bible-study-modal .modal-header h2');
            const modalBody = document.querySelector('#bible-study-modal .modal-body');
            
            modalHeader.textContent = guide.title;
            modalBody.innerHTML = `
                <button class="btn btn-secondary mb-lg" onclick="hideBibleStudy()">‚Üê Back</button>
                ${guide.verses.map(verse => `
                    <div class="card mb-md">
                        <h3 class="card-title">${verse.reference}</h3>
                        <p class="card-description">${verse.text}</p>
                    </div>
                `).join('')}
            `;
            
            modal.classList.add('active');
        }

       function showProgress() {
    const modal = document.getElementById('progress-modal');
    const levelDisplay = document.getElementById('level-display');
    const streakDisplay = document.getElementById('streak-display');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    const nextLevelText = document.getElementById('next-level-text');
    
    // Calculate level based on streak
    let level = 1;
    let totalDaysForCurrentLevel = 0;
    let totalDaysForNextLevel = 7; // Level 2 needs 7 days
    
    // Find current level
    while (userData.streak >= totalDaysForNextLevel) {
        level++;
        totalDaysForCurrentLevel = totalDaysForNextLevel;
        totalDaysForNextLevel += (level * 7); // Each level needs more days
    }
    
    // Calculate progress within current level
    const daysIntoCurrentLevel = userData.streak - totalDaysForCurrentLevel;
    const daysNeededForNextLevel = totalDaysForNextLevel - totalDaysForCurrentLevel;
    const progress = Math.min(100, (daysIntoCurrentLevel / daysNeededForNextLevel) * 100);
    
    // Update displays
    levelDisplay.textContent = `Level ${level}`;
    streakDisplay.textContent = `${userData.streak} Day Streak üî•`;
    
   // Animate progress bar
setTimeout(() => {
    progressFill.style.width = `${progress}%`;
}, 100);
    
    const daysLeft = totalDaysForNextLevel - userData.streak;
    nextLevelText.textContent = `${daysLeft} more days until Level ${level + 1}`;
    
    modal.classList.add('active');
}

        function hideProgress() {
            const modal = document.getElementById('progress-modal');
            modal.classList.remove('active');
        }

       function completeChallenge() {
    console.log("Challenge completed!");
    userData.challengeCompleted = true;
    localStorage.setItem('scriptureLockUser', JSON.stringify(userData));
    
    // Update UI
    document.getElementById('challenge-btn').classList.add('hidden');
    document.getElementById('challenge-complete').classList.remove('hidden');
    
    showToast('Challenge completed! Way to go! üéâ');
}

        // === TOAST NOTIFICATIONS ===
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            toast.className = `toast toast-${type}`;
            toast.classList.add('visible');
            
            setTimeout(() => {
                toast.classList.remove('visible');
            }, 3000);
        }

        // === NAVIGATION ===
        function initializeNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            
            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    const targetSection = this.getAttribute('data-target');
                    
                    // Special handling for Bible section
                    if (targetSection === 'bible-section') {
                        restoreBiblePosition();
                    }
                    
                    showSection(targetSection);
                });
            });
        }

        function updateNavActiveState(sectionId) {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(nav => {
                if (nav.getAttribute('data-target') === sectionId) {
                    nav.classList.add('active');
                } else {
                    nav.classList.remove('active');
                }
            });
        }

    function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            // Hide all modals and overlays to prevent them from blocking clicks
            document.querySelectorAll('.modal, .bible-selector-overlay').forEach(overlay => {
                overlay.classList.remove('active');
            });
            const palette = document.getElementById('highlight-palette');
            if (palette) palette.remove();

            // Show target section defensively
            const target = document.getElementById(sectionId);
            if (!target) {
                console.warn(`showSection: element with id "${sectionId}" not found`);
                showToast('Sorry, that area is not available right now', 'error');
                return;
            }
            // Remove any 'hidden' marker so overlays (like the bible selector) can show
            if (target.classList.contains('hidden')) target.classList.remove('hidden');
            target.classList.add('active');
           // SPECIAL FIX: Show Bible header but keep your reading position
    if (sectionId === 'bible-section') {
        resetBibleView();
        
        // If you were reading a chapter, make sure it's still visible
        if (currentView === 'content' && currentBook && currentChapter) {
            // The chapter should already be visible, just make sure header shows
            const bibleFilter = document.querySelector('.bible-filter-section');
            if (bibleFilter) bibleFilter.classList.add('hidden');
        }
    }
    // If navigating to the leaderboard page, render its content
    if (sectionId === 'leaderboard-section') {
        showLeaderboardPage();
    }
    updateNavActiveState(sectionId);
}
    function restoreBiblePosition() {
    if (currentBook && currentChapter) {
        // If we were reading a chapter, make sure the view is correct
        if (currentView === 'chapters') {
            showChapters(currentBook);
        } else if (currentView === 'content') {
            showChapter(currentBook, currentChapter);
        }
    }
    // If no current book/chapter, it will just show the normal book list
} 

        function showBottomNav() {
            const bottomNav = document.getElementById('bottom-nav');
            setTimeout(() => {
                bottomNav.classList.add('visible');
            }, 1000);
        }
 // === TOUCH INTERACTIONS ===
        let touchStartY = 0;
        let touchEndY = 0;

        document.addEventListener('touchstart', e => {
            touchStartY = e.changedTouches[0].screenY;
        }, { passive: true });

        document.addEventListener('touchend', e => {
            touchEndY = e.changedTouches[0].screenY;
            handleSwipe();
        });

        function handleSwipe() {
            const swipeDistance = touchStartY - touchEndY;
            const minSwipeDistance = 50;
            
            if (Math.abs(swipeDistance) > minSwipeDistance) {
                const bottomNav = document.getElementById('bottom-nav');
                if (swipeDistance > 0) {
                    // Swiped up - show nav
                    bottomNav.classList.add('visible');
                } else {
                    // Swiped down - hide nav
                    bottomNav.classList.remove('visible');
                }
            }
        }

        // NAV behavior: removed global inactivity auto-hide per user request
        // Implement Bible-section-only scroll behavior: hide on upward swipe, show (and stick) on downward swipe or tap
        if (isTouchDevice()) {
            const bottomNav = document.getElementById('bottom-nav');
            const bibleContent = document.getElementById('bible-content');
            if (bibleContent && bottomNav) {
                let startY = 0;
                let lastDelta = 0;
                let isHiddenByScroll = false;

                bibleContent.addEventListener('touchstart', (e) => {
                    startY = e.changedTouches[0].clientY;
                    lastDelta = 0;
                }, {passive:true});

                bibleContent.addEventListener('touchmove', (e) => {
                    const y = e.changedTouches[0].clientY;
                    const delta = y - startY; // positive when swiping down, negative when swiping up
                    lastDelta = delta;
                    // If swiping up (delta < -10) hide nav
                    if (delta < -10) {
                        bottomNav.classList.remove('visible');
                        isHiddenByScroll = true;
                    }
                    // If swiping down (delta > 10) show nav and stick
                    if (delta > 10) {
                        bottomNav.classList.add('visible');
                        isHiddenByScroll = false;
                    }
                }, {passive:true});

                bibleContent.addEventListener('touchend', (e) => {
                    // Tap (very small delta) should toggle/show nav
                    if (Math.abs(lastDelta) < 6) {
                        bottomNav.classList.toggle('visible');
                        isHiddenByScroll = !bottomNav.classList.contains('visible');
                    }
                }, {passive:true});
            }
        }

        // On touch devices, hide nav when user scrolls inside the Bible reading area, like fullscreen readers
        function isTouchDevice() { return ('ontouchstart' in window) || navigator.maxTouchPoints > 0; }
        if (isTouchDevice()) {
            const bibleContent = document.getElementById('bible-content');
            if (bibleContent) {
                let scrolling = false;
                bibleContent.addEventListener('touchstart', () => {
                    // when touching bible content, show nav
                    const bottomNav = document.getElementById('bottom-nav');
                    bottomNav.classList.add('visible');
                }, {passive:true});

                bibleContent.addEventListener('touchmove', () => {
                    // user is scrolling reading content -> hide nav
                    const bottomNav = document.getElementById('bottom-nav');
                    bottomNav.classList.remove('visible');
                    scrolling = true;
                }, {passive:true});

                // on any tap inside bible content, re-show nav
                bibleContent.addEventListener('touchend', (e) => {
                    if (scrolling) {
                        // if ended a scroll, require a tap to show; do not auto-show immediately
                        scrolling = false;
                        return;
                    }
                    // tap ‚Äî show nav
                    const bottomNav = document.getElementById('bottom-nav');
                    bottomNav.classList.add('visible');
                }, {passive:true});
            }
        }

        // Close modal when clicking outside (guarded)
        const bibleStudyModalEl = document.getElementById('bible-study-modal');
        if (bibleStudyModalEl) {
            bibleStudyModalEl.addEventListener('click', function(e) {
                if (e.target === this) {
                    hideBibleStudy();
                }
            });
        }

        const progressModalEl = document.getElementById('progress-modal');
        if (progressModalEl) {
            progressModalEl.addEventListener('click', function(e) {
                if (e.target === this) {
                    hideProgress();
                }
            });
        }

        const prayerModalEl = document.getElementById('prayer-modal');
        if (prayerModalEl) {
            prayerModalEl.addEventListener('click', function(e) {
                if (e.target === this) {
                    hidePrayer();
                }
            });
        }




        // Navigation between chapters
function nextChapter() {
    if (currentBook && currentChapter) {
        const nextChapter = currentChapter + 1;
        if (nextChapter <= currentBook.chapters) {
            showChapter(currentBook, nextChapter);
        } else {
            showToast("This is the last chapter of this book");
        }
    }
}

function previousChapter() {
    if (currentBook && currentChapter) {
        const prevChapter = currentChapter - 1;
        if (prevChapter >= 1) {
            showChapter(currentBook, prevChapter);
        } else {
            showToast("This is the first chapter of this book");
        }
    }
}
function saveUsername() {
    const input = document.getElementById('username-input');
    const userName = input.value.trim() || "Friend";
    
    if (userName) {
        userData.name = userName;
        userData.streak = 1;
        userData.lastLogin = new Date().toDateString();
        saveUserData();
        
        // Update the UI after a slight delay to ensure DOM is ready
        setTimeout(() => {
            updateUI();
            showRandomGreeting();
        }, 100);
        
        // Hide modal
        document.getElementById('username-modal').classList.remove('active');
    }
}

function showRandomGreeting() {
    const greetings = [
        `Ready to build those spiritual muscles, ${userData.name}?`,
        `Did you know you can get closer to Jesus through His Word? ${userData.name}!`,
        `${userData.name}, let's dive into God's truth today!`,
        `Your daily dose of wisdom awaits, ${userData.name}!`,
        `Time to level up your faith, ${userData.name}!`,
        `${userData.name}, God's got something fresh for you today!`,
        `Let's get this bread - spiritual bread! ${userData.name}`,
        `${userData.name}, ready for your daily victory?`,
        `The Word is waiting for you, ${userData.name}!`,
        `${userData.name}, let's grow in grace together today!`
    ];
    
    const randomGreeting = greetings[Math.floor(Math.random() * greetings.length)];
    document.getElementById('greeting-text').textContent = randomGreeting;
}
function showAboutPage() {
    showSection('about-section');
}

function showSettings() {
    showSection('settings-section');
}

// The rest of your settings functions remain the same:
async function toggleDarkMode() {
    const isDarkMode = document.getElementById('dark-mode-toggle').checked;
    document.body.classList.toggle('dark-mode', isDarkMode);
    try {
        if (!db) await initDB();
        await dbSet('settings', { key: 'darkMode', value: isDarkMode });
    } catch (error) {
        console.error('Error saving dark mode:', error);
    }
    showToast(isDarkMode ? 'Dark mode enabled' : 'Dark mode disabled');
}

function changeFontSize() {
    // Deprecated: font size is now managed responsively.
    // This function left as a no-op for backward compatibility.
    console.info('changeFontSize() is deprecated. Font size is set responsively.');
}

async function toggleNotifications() {
    const enabled = document.getElementById('notifications-toggle').checked;
    
    if (enabled) {
        // Request permission if not already granted
        if (Notification.permission === 'default') {
            Notification.requestPermission().then(async permission => {
                if (permission === 'granted') {
                    try {
                        if (!db) await initDB();
                        await dbSet('settings', { key: 'notifications', value: true });
                    } catch (error) {
                        console.error('Error saving notifications setting:', error);
                    }
                    showToast('Notifications enabled');
                    scheduleNotifications();
                } else {
                    document.getElementById('notifications-toggle').checked = false;
                    showToast('Please enable notifications in browser settings', 'error');
                }
            });
        } else if (Notification.permission === 'granted') {
            try {
                if (!db) await initDB();
                await dbSet('settings', { key: 'notifications', value: true });
            } catch (error) {
                console.error('Error saving notifications setting:', error);
            }
            showToast('Notifications enabled');
            scheduleNotifications();
        } else {
            document.getElementById('notifications-toggle').checked = false;
            showToast('Please enable notifications in browser settings', 'error');
        }
    } else {
        try {
            if (!db) await initDB();
            await dbSet('settings', { key: 'notifications', value: false });
        } catch (error) {
            console.error('Error saving notifications setting:', error);
        }
        showToast('Notifications disabled');
        // Clear any scheduled notifications
        if (window.notificationIntervals) {
            window.notificationIntervals.forEach(interval => clearInterval(interval));
            window.notificationIntervals = [];
        }
    }
}
async function scheduleNotifications() {
    // Clear any existing notifications
    if (window.notificationIntervals) {
        window.notificationIntervals.forEach(interval => clearInterval(interval));
    }
    window.notificationIntervals = [];
    
    // Check if notifications are enabled and permission granted
    try {
        const notificationSettings = await dbGet('settings', 'notifications');
        const notificationsEnabled = notificationSettings === true;
        if (!notificationsEnabled || Notification.permission !== 'granted') {
            return;
        }
    } catch (error) {
        console.error('Error checking notifications setting:', error);
        return;
    }
    
    // Schedule daily verse notification (9:00 AM)
    scheduleDailyNotification(9, 0, 'Your Daily Verse üìñ', () => {
        const verse = getDailyVerse();
        return `"${verse.text}" - ${verse.reference}`;
    });
    
    // Schedule streak reminder (8:00 PM)
    scheduleDailyNotification(20, 0, 'Keep Your Streak Going! üî•', () => {
        return `You've maintained a ${userData.streak}-day streak! Don't break it now!`;
    });
    
    // Schedule progress check (2:00 PM, every 3 days)
    scheduleIntervalNotification(3, 14, 0, 'Progress Check üìä', () => {
        const nextLevel = calculateNextLevel();
        return `You're ${nextLevel.daysNeeded} days away from Level ${nextLevel.nextLevel}! Keep going!`;
    });
    
    // Schedule random encouragement (random times)
    scheduleRandomEncouragement();
}

function scheduleDailyNotification(hour, minute, title, messageCallback) {
    const now = new Date();
    const targetTime = new Date();
    targetTime.setHours(hour, minute, 0, 0);
    
    // If target time already passed today, schedule for tomorrow
    if (targetTime <= now) {
        targetTime.setDate(targetTime.getDate() + 1);
    }
    
    const timeUntilNotification = targetTime - now;
    
    const timeoutId = setTimeout(() => {
        // Show notification
        showNotification(title, messageCallback());
        
        // Schedule for next day
        const intervalId = setInterval(() => {
            showNotification(title, messageCallback());
        }, 24 * 60 * 60 * 1000); // 24 hours
        
        window.notificationIntervals.push(intervalId);
    }, timeUntilNotification);
    
    window.notificationIntervals.push(timeoutId);
}

function scheduleIntervalNotification(days, hour, minute, title, messageCallback) {
    const now = new Date();
    const targetTime = new Date();
    targetTime.setHours(hour, minute, 0, 0);
    
    // If target time already passed today, schedule for next interval
    if (targetTime <= now) {
        targetTime.setDate(targetTime.getDate() + days);
    } else {
        targetTime.setDate(targetTime.getDate() + days);
    }
    
    const timeUntilNotification = targetTime - now;
    
    const timeoutId = setTimeout(() => {
        // Show notification
        showNotification(title, messageCallback());
        
        // Schedule for next interval
        const intervalId = setInterval(() => {
            showNotification(title, messageCallback());
        }, days * 24 * 60 * 60 * 1000); // X days
        
        window.notificationIntervals.push(intervalId);
    }, timeUntilNotification);
    
    window.notificationIntervals.push(timeoutId);
}

function scheduleRandomEncouragement() {
    // Schedule random encouragement between 10AM-8PM
    const minHour = 10;
    const maxHour = 20;
    
    const scheduleRandom = () => {
        const randomHour = Math.floor(Math.random() * (maxHour - minHour + 1)) + minHour;
        const randomMinute = Math.floor(Math.random() * 60);
        
        const now = new Date();
        const targetTime = new Date();
        targetTime.setHours(randomHour, randomMinute, 0, 0);
        
        // If target time already passed today, schedule for tomorrow
        if (targetTime <= now) {
            targetTime.setDate(targetTime.getDate() + 1);
        }
        
        const timeUntilNotification = targetTime - now;
        
        const timeoutId = setTimeout(() => {
            // Show random encouragement
            const encouragements = [
                "God's got your back today! üôè",
                "Need some spiritual fuel? Open Zcriptures! ‚õΩ",
                "Your faith journey matters - keep going! üåü",
                "Take a moment with God today. He's waiting for you. üí´",
                "You're loved more than you know. Remember that today. ‚ù§Ô∏è"
            ];
            
            const randomEncouragement = encouragements[Math.floor(Math.random() * encouragements.length)];
            showNotification('Encouragement üíù', randomEncouragement);
            
            // Schedule next random encouragement for tomorrow
            scheduleRandom();
        }, timeUntilNotification);
        
        window.notificationIntervals.push(timeoutId);
    };
    
    scheduleRandom();
}

async function showNotification(title, message) {
    // Check if notifications are enabled
    try {
        if (!db) await initDB();
        const notificationsSetting = await dbGet('settings', 'notifications');
        const notificationsEnabled = notificationsSetting?.value === true;
        if (!notificationsEnabled || Notification.permission !== 'granted') {
            return;
        }

        // Use service worker to show notification
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            navigator.serviceWorker.ready.then(registration => {
                registration.showNotification(title, {
                    body: message,
                    icon: 'logo.jpg',
                    badge: 'logo.jpg'
                });
            });
        } else {
            // Fallback for when SW is not available
            const notification = new Notification(title, {
                body: message,
                icon: 'logo.jpg',
                badge: 'logo.jpg'
            });
            
            // Handle notification click
            notification.onclick = () => {
                window.focus();
                notification.close();
            };
            
            // Auto-close after 10 seconds
            setTimeout(() => {
                notification.close();
            }, 10000);
        }
    } catch (error) {
        console.error('Error checking notification setting:', error);
        return;
    }
}

function calculateNextLevel() {
    let level = 1;
    let totalDaysRequired = 0;
    
    for (let i = 1; i <= 100; i++) {
        totalDaysRequired += i * 7;
        if (userData.streak >= totalDaysRequired) {
            level = i + 1;
        } else {
            break;
        }
    }
    
    const daysNeeded = level * 7 - (userData.streak % (level * 7));
    return { nextLevel: level + 1, daysNeeded };
}

async function toggleVerseReminder() {
    const enabled = document.getElementById('verse-reminder-toggle').checked;
    try {
        if (!db) await initDB();
        await dbSet('settings', { key: 'verseReminder', value: enabled });
    } catch (error) {
        console.error('Error saving verse reminder setting:', error);
    }
    showToast(enabled ? 'Verse reminders enabled' : 'Verse reminders disabled');
}

async function resetData() {
    if (confirm('Are you sure you want to reset all data? This cannot be undone.')) {
        try {
            if (!db) await initDB();
            await dbClear('userData');
            await dbClear('notes');
            await dbClear('settings');
        } catch (error) {
            console.error('Error resetting data:', error);
        }
        showToast('Data reset. Reloading...');
        setTimeout(() => location.reload(), 1500);
    }
}

// Load saved settings
async function loadSettings() {
    try {
        if (!db) await initDB();
        
        // Dark mode
        const darkModeSetting = await dbGet('settings', 'darkMode');
        const darkMode = darkModeSetting?.value === true;
        if (document.getElementById('dark-mode-toggle')) {
            document.getElementById('dark-mode-toggle').checked = darkMode;
        }
        document.body.classList.toggle('dark-mode', darkMode);
        
        // Font size is now handled responsively; hide legacy control if present
        if (document.getElementById('font-size-select')) {
            const el = document.getElementById('font-size-select');
            el.closest && el.closest('.setting-row') ? el.closest('.setting-row').style.display = 'none' : el.style.display = 'none';
        }
        // Apply responsive font sizing
        setResponsiveFontSize();
        
        // Notifications
        const notificationsSetting = await dbGet('settings', 'notifications');
        const notifications = notificationsSetting?.value === true;
        if (document.getElementById('notifications-toggle')) {
            document.getElementById('notifications-toggle').checked = notifications;
        }
        
        // Verse reminder
        const verseReminderSetting = await dbGet('settings', 'verseReminder');
        const verseReminder = verseReminderSetting?.value === true;
        if (document.getElementById('verse-reminder-toggle')) {
            document.getElementById('verse-reminder-toggle').checked = verseReminder;
        }

        // Schedule notifications if they're enabled
        if (notifications && Notification.permission === 'granted') {
            // Small delay to ensure everything is loaded
            setTimeout(scheduleNotifications, 2000);
        }
        // Show original text toggle
        const showOriginal = userData.showOriginalText || false;
        if (document.getElementById('show-original-toggle')) {
            document.getElementById('show-original-toggle').checked = showOriginal;
        }
        updateAllDisplays();
    } catch (error) {
        console.error('Error loading settings:', error);
    }
}




async function initializeApp() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
            .then(registration => {
                console.log('Service Worker registered with scope:', registration.scope);
            })
            .catch(error => {
                console.error('Service Worker registration failed:', error);
            });
    }
    await initDB();
    await loadUserData();
    try { updateHeaderAvatarSync(); } catch(e) {}
    await initializeLeaderboard(); // Initialize leaderboard on first run
    initializeNavigation();
    showBottomNav();
    updateUI();
    setDailyVerse();
    await loadSettings(); 
    updateGamePointsDisplay();
    initializeFunFacts();
    initializeGlossary();
    await initializeBibleSection();
}

function testDailyVerseNotification() {
    showNotification('Your Daily Verse üìñ', '"For I know the plans I have for you," declares the Lord, "plans to prosper you and not to harm you, plans to give you hope and a future." - Jeremiah 29:11');
}

function testStreakNotification() {
    showNotification('Keep Your Streak Going! üî•', `You've maintained a ${userData.streak}-day streak! Don't break it now!`);
}

function testProgressNotification() {
    const nextLevel = calculateNextLevel();
    showNotification('Progress Check üìä', `You're ${nextLevel.daysNeeded} days away from Level ${nextLevel.nextLevel}! Keep going!`);
}
// Show demo info modal
function showDemoInfo() {
    const modal = document.getElementById('demo-modal');
    modal.classList.add('active');
}

// Hide demo info modal
function hideDemoInfo() {
    const modal = document.getElementById('demo-modal');
    modal.classList.remove('active');
}

// Close modal when clicking outside (guarded)
const demoModalEl = document.getElementById('demo-modal');
if (demoModalEl) {
    demoModalEl.addEventListener('click', function(e) {
        if (e.target === this) {
            hideDemoInfo();
        }
    });
}
    </script>

     <script>
        // Splash screen text animation
        function initSplashScreen() {
            const splashTexts = [
                "Read. Learn. Level Up.",
                "Forget the bread. Live the Word.",
                "Study. Apply. Glow.",
                "Study It. Live It.",
                "Scripture.The Original Textbook.",
                "Diving into God's User manual!"
            ];

            const splashElements = [
                document.getElementById('splash-text-1'),
                document.getElementById('splash-text-2'),
                document.getElementById('splash-text-3'),
                document.getElementById('splash-text-4'),
                document.getElementById('splash-text-5'),
                document.getElementById('splash-text-6')
            ];

            const loader = document.getElementById('splash-loader');
            const loaderBar = document.getElementById('loader-bar');
            const splashScreen = document.getElementById('splash-screen');

            // Set text content
            splashElements.forEach((el, index) => {
                el.textContent = splashTexts[index];
            });

            // Function to show text sequentially
            function showTextSequentially(index) {
                if (index >= splashElements.length) {
                    // All texts shown, now show loader
                    loader.classList.add('visible');
                    setTimeout(() => {
                        loaderBar.classList.add('complete');
                    }, 100);
                    
                    // Hide splash screen after loader completes
                    setTimeout(() => {
                        splashScreen.classList.add('hidden');
                    }, 2000);
                    return;
                }

                // Show current text
                splashElements[index].classList.add('active');
                
                // Wait before showing next text
                setTimeout(() => {
                    // Fade out current text
                    splashElements[index].classList.remove('active');
                    splashElements[index].classList.add('inactive');
                    
                    // Show next text after a delay
                    setTimeout(() => {
                        showTextSequentially(index + 1);
                    }, 500); // Delay between texts
                }, 2000); // Time each text is visible
            }

            // Start the animation
            setTimeout(() => {
                showTextSequentially(0);
            }, 1000);

                // Allow user to skip by clicking (guarded)
                if (splashScreen) {
                    splashScreen.addEventListener('click', function() {
                        this.classList.add('hidden');
                    });
                }
        }

        // Initialize the splash screen
        document.addEventListener('DOMContentLoaded', initSplashScreen);
        
        // Replay functionality (guarded)
        const replayBtn = document.getElementById('replay-btn');
        if (replayBtn) {
            replayBtn.addEventListener('click', function() {
            const splashScreen = document.getElementById('splash-screen');
            const loader = document.getElementById('splash-loader');
            const loaderBar = document.getElementById('loader-bar');
            const splashTexts = document.querySelectorAll('.splash-text');
            
            // Reset all elements
            splashScreen.classList.remove('hidden');
            loader.classList.remove('visible');
            loaderBar.classList.remove('complete');
            splashTexts.forEach(text => {
                text.classList.remove('active', 'inactive');
            });
            
            // Reinitialize after a brief delay
            setTimeout(initSplashScreen, 300);
    });
    }



// === USER PROFILE MODAL ===
async function showUserProfile() {
    console.log("Profile clicked!");
    
    // Update the profile info
    const profileName = document.getElementById('profile-name');
    const profileStreak = document.getElementById('profile-streak');
    const profileHighlights = document.getElementById('profile-highlights');
    const profileAvatar = document.getElementById('profile-avatar');
    
    if (profileName) profileName.textContent = userData.name || 'Friend';
    if (profileStreak) profileStreak.textContent = userData.streak || 0;
    if (profileHighlights) profileHighlights.textContent = userData.highlights ? userData.highlights.length : 0;
    
    // Update avatar with user's custom image or initials (no bounce animation)
    if (profileAvatar) {
        if (userData && userData.avatar && userData.avatar.dataURL) {
            profileAvatar.innerHTML = `<img src="${userData.avatar.dataURL}" alt="${userData.name}" style="width:100%; height:100%; object-fit:cover; border-radius:50%; display:block; animation: none;">`;
        } else {
            profileAvatar.innerHTML = (userData.name || 'F').charAt(0).toUpperCase();
            profileAvatar.style.animation = 'none';
        }
    }

    // Sync community rank from leaderboard
    try {
        const lbData = await getLeaderboardFromDB();
        if (lbData && Array.isArray(lbData)) {
            const sortedList = [...lbData].sort((a, b) => (b.score || 0) - (a.score || 0));
            const userName = userData.name || 'Friend';
            const userIndex = sortedList.findIndex(u => u.name === userName);
            const userRank = userIndex >= 0 ? (userIndex + 1).toString() : '‚Äî';
            const profileRankEl = document.getElementById('profile-rank');
            if (profileRankEl) profileRankEl.textContent = userRank;
        }
    } catch (e) { console.warn('Rank sync failed', e); }

    // Ensure profile data (avatar, level, bio, etc.) are up-to-date
    try { updateProfileData(); } catch (e) { console.warn('updateProfileData failed', e); }

    // Render bio (sanitized) into view mode
    const bioEl = document.getElementById('profile-bio');
    const ta = document.getElementById('profile-bio-textarea');
    const actions = document.getElementById('profile-bio-actions');
    if (bioEl) bioEl.innerHTML = (userData && userData.bio) ? userData.bio.replace(/\n/g, '<br>') : 'You don\'t have a bio yet. Add one!';
    if (ta) ta.style.display = 'none';
    if (actions) actions.style.display = 'none';
    
    // Show the modal
    const modal = document.getElementById('user-profile-modal');
    if (modal) {
        modal.classList.add('active');
    } else {
        console.error("Profile modal not found!");
    }
}

function hideUserProfile() {
    const modal = document.getElementById('user-profile-modal');
    if (modal) {
        modal.classList.remove('active');
    }
}

function updateProfileData() {
    // SAFELY update basic info
    const pName = document.getElementById('profile-name'); if (pName) pName.textContent = userData.name || 'Friend';
    const pStreak = document.getElementById('profile-streak'); if (pStreak) pStreak.textContent = userData.streak || 0;
    const pHighlights = document.getElementById('profile-highlights'); if (pHighlights) pHighlights.textContent = userData.highlights ? userData.highlights.length : 0;

    // Calculate total days since first login (guarded)
    const totalDays = calculateTotalDays();
    const pDays = document.getElementById('profile-days'); if (pDays) pDays.textContent = totalDays;

    // Calculate completed challenges (guarded)
    const completedChallenges = calculateCompletedChallenges();
    const pChallenges = document.getElementById('profile-challenges'); if (pChallenges) pChallenges.textContent = completedChallenges;

    // Update faith level (guarded)
    const levelInfo = calculateFaithLevel();
    const pLevel = document.getElementById('profile-level'); if (pLevel) pLevel.textContent = `Level ${levelInfo.level}`;
    const pLevelFill = document.getElementById('profile-level-fill'); if (pLevelFill) pLevelFill.style.width = `${Math.max(0, Math.min(100, levelInfo.progress))}%`;
    const pNext = document.getElementById('profile-next-level'); if (pNext) pNext.textContent = levelInfo.nextLevelText;

    // Update profile title based on level (guarded)
    try { updateProfileTitle(levelInfo.level); } catch(e) { /* ignore */ }

    // Update avatar (guarded)
    try { updateProfileAvatar(); } catch(e) { console.warn('updateProfileAvatar failed', e); }

    // Ensure header avatar reflects current state
    try { updateHeaderAvatarSync(); } catch(e) { /* ignore */ }

    // Update achievements (guarded)
    try { updateAchievements(); } catch(e) { /* ignore */ }
}

function calculateTotalDays() {
    if (!userData.lastLogin) return 0;
    
    const firstLogin = new Date(userData.lastLogin);
    const today = new Date();
    const diffTime = Math.abs(today - firstLogin);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return diffDays;
}

function calculateCompletedChallenges() {
    // For now, return streak count as approximation
    // You can enhance this by tracking challenges separately
    return Math.floor(userData.streak / 2);
}

function calculateFaithLevel() {
    const streak = (userData && typeof userData.streak !== 'undefined') ? Number(userData.streak) : 0;
    let level = 1;
    let totalDaysForLevel = 7;
    let daysUsed = 0;
    
    // Each level requires more days than the previous
    while (streak >= totalDaysForLevel) {
        daysUsed += totalDaysForLevel;
        level++;
        totalDaysForLevel = level * 7; // Level 2 needs 14 days, Level 3 needs 21, etc.
    }
    
    const currentLevelProgress = streak - daysUsed;
    const daysNeededForCurrentLevel = totalDaysForLevel;
    const progress = (currentLevelProgress / daysNeededForCurrentLevel) * 100;
    const daysUntilNext = daysNeededForCurrentLevel - currentLevelProgress;
    
    return {
        level: level,
        progress: Math.max(0, progress),
        nextLevelText: `${daysUntilNext} more days until Level ${level + 1}`
    };
}

function updateProfileTitle(level) {
    const titles = [
        "Scripture Newbie",        // Level 1
        "Bible Explorer",          // Level 2  
        "Word Seeker",             // Level 3
        "Faith Walker",            // Level 4
        "Scripture Scholar",       // Level 5
        "Verse Warrior",           // Level 6
        "Bible Beast",             // Level 7
        "Scripture Champion",      // Level 8
        "Holy Hustler",            // Level 9
        "Divine Legend",           // Level 10
        "Scripture Master",        // Level 11
        "Grace Guardian",          // Level 12
        "Truth Torch",             // Level 13
        "Psalm Pilot",             // Level 14
        "Gospel Guardian"          // Level 15+
    ];
    
    const titleIndex = Math.min(level - 1, titles.length - 1);
    const titleEl = document.getElementById('profile-title');
    if (titleEl) titleEl.textContent = titles[titleIndex];
}

// === LEADERBOARD (Offline) ===
// List of available avatar images from leaderboard_pics folder (exact filenames)
const availableAvatars = [
    'player1.jpeg',
    'player2.jpeg',
    'player3.jpeg',
    'player4.jpeg',
    'player5.jpeg',
    'player6.jpeg',
    'player7.jpeg',
    'player8.jpg',
    'player9.jpeg',
    'player10.jpeg',
    'player11.jpg',
    'player12.jpg',
    'player13.jpeg',
    'player14.jpeg'
];
function getRandomAvatar() {
    return availableAvatars[Math.floor(Math.random() * availableAvatars.length)];
}

// Expose avatar pool to other functions that expect window.availableAvatars
window.availableAvatars = availableAvatars;

// Build a default fake leaderboard used when IndexedDB is empty
function buildFakeLeaderboard(count = 12) {
    const sampleNames = [
        'Ava','Liam','Noah','Olivia','Emma','Mason','Sophia','Lucas','Mia','Ethan','Amelia','James','Isabella','Benjamin','Charlotte'
    ];
    const list = [];
    for (let i = 0; i < count; i++) {
        const name = sampleNames[i % sampleNames.length] + (i >= sampleNames.length ? ' ' + (Math.floor(i / sampleNames.length) + 1) : '');
        const score = 400 + Math.floor(Math.random() * 2000); // keep scores reasonable
        const user = { id: `fake-${i+1}`, name: name, score: score };
        // normalize avatar shape
        // avatar will be assigned in batch to ensure uniqueness
        list.push(user);
    }
    // sort descending
    list.sort((a,b) => (b.score||0) - (a.score||0));
    // assign unique avatars from pool
    assignUniqueAvatars(list);
    return list;
}

// Assign unique avatars to a list of users. Avatars come from availableAvatars and are prefixed with folder path.
function assignUniqueAvatars(users) {
    if (!Array.isArray(users) || users.length === 0) return users;
    const pool = Array.isArray(window.availableAvatars) ? [...window.availableAvatars] : [];
    // If pool is smaller than users, allow reuse by repeating the pool, but prefer uniqueness when possible
    if (pool.length === 0) return users;

    // shuffle pool
    for (let i = pool.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [pool[i], pool[j]] = [pool[j], pool[i]];
    }

    for (let i = 0; i < users.length; i++) {
        const pick = pool[i % pool.length];
        const path = (pick.startsWith('http') || pick.startsWith('data:') || pick.startsWith('/') || pick.startsWith('leaderboard_pics/') || pick.startsWith('./leaderboard_pics/')) ? pick : ('./leaderboard_pics/' + pick);
        users[i].avatar = { url: encodeURI(path) };
    }
    return users;
}

function assignAvatarToUser(user) {
    if (!user.avatar) {
        // normalize to object shape { url: '...' } so rendering code can rely on avatar.url
        let pick = getRandomAvatar();
        if (pick && !(pick.startsWith('http') || pick.startsWith('data:') || pick.startsWith('/') || pick.startsWith('leaderboard_pics/'))) {
            pick = './leaderboard_pics/' + pick;
        }
        user.avatar = { url: encodeURI(pick) };
    } else if (typeof user.avatar === 'string') {
        // convert legacy string avatar into object and normalize path
        let pick = user.avatar || '';
        if (pick && !(pick.startsWith('http') || pick.startsWith('data:') || pick.startsWith('/') || pick.startsWith('leaderboard_pics/') || pick.startsWith('./leaderboard_pics/'))) {
            pick = './leaderboard_pics/' + pick;
        }
        user.avatar = { url: encodeURI(pick) };
    }
    return user;
}

// Generate a simple SVG avatar with initials as a data URL
function generateInitialsAvatar(name, size = 96) {
    const initials = (name || 'U').toString().trim().split(' ').map(s => s.charAt(0).toUpperCase()).slice(0,2).join('') || 'U';
    const bg = '#e6dfd0';
    const fg = '#6b6b6b';
    const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}'><rect width='100%' height='100%' fill='${bg}' rx='12' ry='12'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='${Math.floor(size/2.5)}' fill='${fg}' font-family='Inter, Arial, sans-serif'>${initials}</text></svg>`;
    return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
}

// Attach onerror fallbacks to avatar <img> elements inside a container
function attachAvatarFallbacks(root) {
    try {
        const container = root || document;
        const imgs = container.querySelectorAll('img');
        imgs.forEach(img => {
            if (img.__avatarFallbackAttached) return;
            img.__avatarFallbackAttached = true;
            img.addEventListener('error', function () {
                try {
                    const name = img.alt || img.getAttribute('data-name') || '';
                    img.src = generateInitialsAvatar(name, Math.max(img.width || 64, 64));
                    img.style.objectFit = 'cover';
                } catch (e) { /* swallow */ }
            });
            // If image already failed to load earlier, ensure fallback
            if (!img.complete || img.naturalWidth === 0) {
                // trigger error fallback if src looks invalid
                setTimeout(() => {
                    if (!img.complete || img.naturalWidth === 0) {
                        const evt = new Event('error');
                        img.dispatchEvent(evt);
                    }
                }, 50);
            }
        });
    } catch (e) { /* swallow */ }
}

function computeUserScoreFromUserData() {
    // Derive a simple score from userData (streaks, highlights, challenges)
    const user = userData || { name: 'YOU', streak: 0, highlights: [], challengesCompleted: 0 };
    const streakPoints = (user.streak || 0) * 10; // 10 points per streak day
    const highlightsPoints = (user.highlights ? user.highlights.length : 0) * 5; // 5 points per highlight
    const challengesPoints = (user.challengesCompleted || 0) * 30; // 30 points per challenge
    const gamePoints = user.gamePoints || 0;
    const base = 500; // baseline
    return base + streakPoints + highlightsPoints + challengesPoints + gamePoints;
}

function randomizeTopFakeScores(list) {
    // Slightly tweak top fake users to make leaderboard feel alive
    list.forEach((u, idx) => {
        if (idx < 5) {
            // top 5 get a small random bump or drop
            u.score = Math.max(300, u.score + Math.floor(Math.random() * 60) - 30);
        }
    });
}

// Initialize leaderboard in IndexedDB on first run
async function initializeLeaderboard() {
    try {
        const today = new Date().toDateString();
        const existingLb = await dbGet('leaderboard', 'scores');
        
        // Always initialize or reset daily
        if (!existingLb) {
            const fakeUsers = buildFakeLeaderboard();
            randomizeTopFakeScores(fakeUsers);
            // assign unique avatars to fake users before saving so they persist
            assignUniqueAvatars(fakeUsers);
            await dbSet('leaderboard', { id: 'scores', users: fakeUsers, lastUpdated: new Date().toISOString() });
            console.log('‚úÖ Leaderboard initialized in IndexedDB');
        } else {
            // Check if it's a new day
            const lastDate = new Date(existingLb.lastUpdated || new Date()).toDateString();
            if (lastDate !== today) {
                console.log('üîÑ Daily leaderboard reset triggered');
                const fakeUsers = buildFakeLeaderboard();
                randomizeTopFakeScores(fakeUsers);
                assignUniqueAvatars(fakeUsers);
                await dbSet('leaderboard', { id: 'scores', users: fakeUsers, lastUpdated: new Date().toISOString() });
            }
        }
    } catch (error) {
        console.error('Error initializing leaderboard:', error);
    }
}

// Update leaderboard scores to make it competitive
async function updateLeaderboardScores() {
    try {
        const lbData = await dbGet('leaderboard', 'scores');
        if (!lbData || !lbData.users) return;
        
        // Randomly update some fake users' scores to make leaderboard feel alive
        const users = lbData.users;
        users.forEach((u, idx) => {
            if (Math.random() < 0.3) { // 30% chance to update
                const oldScore = u.score;
                u.score = Math.max(300, u.score + Math.floor(Math.random() * 100) - 40);
                if (Math.abs(u.score - oldScore) > 5) {
                    u.lastScoreChange = Math.floor((u.score - oldScore) / Math.abs(u.score - oldScore)); // 1 or -1
                }
            }
        });
        
        // Re-sort by score
        users.sort((a, b) => b.score - a.score);
        
        await dbSet('leaderboard', { id: 'scores', users: users, lastUpdated: new Date().toISOString() });
    } catch (error) {
        console.error('Error updating leaderboard:', error);
    }
}

// Get current leaderboard from IndexedDB (with daily rotation)
async function getLeaderboardFromDB() {
    try {
        const lbData = await dbGet('leaderboard', 'scores');
        const today = new Date().toDateString();
        
        // If leaderboard exists but is from a different day, reset and randomize
        if (lbData && lbData.lastUpdated) {
            const lastDate = new Date(lbData.lastUpdated).toDateString();
            if (lastDate !== today) {
                // It's a new day - shuffle and reset
                console.log('üîÑ New day detected - shuffling leaderboard');
                const fresh = buildFakeLeaderboard();
                randomizeTopFakeScores(fresh);
                await dbSet('leaderboard', { id: 'scores', users: fresh, lastUpdated: new Date().toISOString() });
                return fresh;
            }
        }
        return lbData ? lbData.users : buildFakeLeaderboard();
    } catch (error) {
        console.error('Error getting leaderboard:', error);
        return buildFakeLeaderboard();
    }
}

async function showLeaderboard() {
    try {
        const lbData = await getLeaderboardFromDB();
        const userName = userData ? userData.name : 'Friend';
        const userScore = computeUserScoreFromUserData();
        
        // Calculate user rank from leaderboard
        let userRank = '‚Äî';
        if (lbData && Array.isArray(lbData)) {
            const sortedList = [...lbData].sort((a, b) => (b.score || 0) - (a.score || 0));
            const userIndex = sortedList.findIndex(u => u.name === userName);
            userRank = userIndex >= 0 ? (userIndex + 1).toString() : '‚Äî';
        }
        
        // Update profile rank to match leaderboard
        const profileRankEl = document.getElementById('profile-rank');
        if (profileRankEl) profileRankEl.textContent = userRank;
        
        const leaderboardRankEl = document.getElementById('leaderboard-user-rank');
        if (leaderboardRankEl) leaderboardRankEl.textContent = userRank;
        
        // Show leaderboard modal
        const modal = document.getElementById('leaderboard-modal');
        if (modal) {
            modal.classList.add('active');
        }
        
        // Render leaderboard
        const list = lbData && Array.isArray(lbData) ? lbData : buildFakeLeaderboard();
        const prevSnapshot = list.slice(0, 5); // Store top 5 for animation
        renderLeaderboard(list, prevSnapshot, userName);
        
    } catch (error) {
        console.error('Error showing leaderboard:', error);
    }
}

function hideLeaderboard() {
    const modal = document.getElementById('leaderboard-modal');
    modal.classList.remove('active');
}

function renderLeaderboard(list, prevSnapshot, userName) {
    // new layout: podium for top 3 + scrollable list for the rest
    window._assignedAvatars = window._assignedAvatars || {};

    const getAvatarSrc = (u) => {
        if (!u) return '';
        if (u.avatar) {
            if (typeof u.avatar === 'string') {
                const s = u.avatar.trim();
                if (/\.(jpe?g|png|gif|webp|svg)$/i.test(s) || s.startsWith('http') || s.startsWith('data:') || s.startsWith('leaderboard_pics/') || s.startsWith('/')) {
                    const p = (s.startsWith('http') || s.startsWith('data:') || s.startsWith('leaderboard_pics/') || s.startsWith('/')) ? s : ('leaderboard_pics/' + s);
                    return encodeURI(p);
                }
            }
            if (u.avatar.dataURL) return u.avatar.dataURL;
            if (u.avatar.url) return u.avatar.url;
        }
        if (window.userData && (u.name === window.userData.name)) {
            if (window.userData.avatar && window.userData.avatar.dataURL) return window.userData.avatar.dataURL;
            if (window.userData.avatar && window.userData.avatar.url) return window.userData.avatar.url;
        }
        if (window._assignedAvatars[u.name]) return window._assignedAvatars[u.name];
        const pool = (window.availableAvatars && window.availableAvatars.length) ? window.availableAvatars : [];
        if (pool.length) {
            const pick = pool[Math.floor(Math.random() * pool.length)];
            let path = pick;
            if (!(pick.startsWith('http') || pick.startsWith('data:') || pick.startsWith('leaderboard_pics/') || pick.startsWith('/'))) path = 'leaderboard_pics/' + pick;
            const src = encodeURI(path);
            window._assignedAvatars[u.name] = src;
            return src;
        }
        const initials = (u.name || 'U').charAt(0).toUpperCase();
        const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='80' height='80'><rect width='100%' height='100%' fill='%23efefef'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='36' fill='%23777' font-family='Arial, sans-serif'>${initials}</text></svg>`;
        return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
    };

    // Ensure we have a sorted copy
    const sorted = Array.isArray(list) ? [...list].sort((a,b)=> (b.score||0)-(a.score||0)) : [];
    const top3 = sorted.slice(0,3);
    const rest = sorted.slice(3);

    const podiumHtml = top3.map((u, i) => {
        const rank = i + 1;
        const avatar = getAvatarSrc(u);
        const size = rank === 2 ? 68 : (rank === 1 ? 92 : 64);
        const crown = rank === 1 ? '<div style="position:absolute; top:-18px; left:50%; transform:translateX(-50%); font-size:1.2rem;">üëë</div>' : '';
        return `
            <div style="flex:1; text-align:center; position:relative;">
                ${crown}
                <div style="width:${size}px; height:${size}px; margin:0 auto 8px; border-radius:50%; overflow:hidden; border:4px solid rgba(255,255,255,0.08); background:var(--surface); display:flex; align-items:center; justify-content:center;">
                    <img src="${avatar}" alt="${u.name||''}" style="width:100%; height:100%; object-fit:cover; display:block;">
                </div>
                <div style="font-weight:800; font-size:${rank===1?'1.15rem':'0.95rem'};">${u.name}</div>
                <div style="color:var(--text-muted); font-size:0.9rem; margin-top:4px;">${u.score} pts</div>
            </div>
        `;
    }).join('');

    const listRows = rest.map((u, idx) => {
        const rank = idx + 4; // since rest starts at 4
        const avatar = getAvatarSrc(u);
        let delta = '';
        if (prevSnapshot) {
            const prev = (prevSnapshot || []).find(p => p.name === u.name);
            if (prev && typeof prev.rank !== 'undefined') {
                const movement = (prev.rank - rank);
                if (movement > 0) delta = `‚¨ÜÔ∏è ${movement}`;
                else if (movement < 0) delta = `‚¨áÔ∏è ${Math.abs(movement)}`;
                else delta = '‚Äî';
            }
        }
        const isYou = u.name === userName || (window.userData && u.name === window.userData.name);
        return `
            <div class="card" style="display:flex; align-items:center; gap:12px; padding:12px; margin-bottom:8px;">
                <div style="width:40px; text-align:center; font-weight:700;">${rank}</div>
                <div style="width:44px; height:44px; border-radius:50%; overflow:hidden; background:var(--surface); flex-shrink:0;">
                    <img src="${avatar}" alt="${u.name||''}" style="width:100%; height:100%; object-fit:cover; display:block;">
                </div>
                <div style="flex:1;">
                    <div style="font-weight:700;">${u.name}${isYou? ' (You)': ''}</div>
                    <div style="font-size:0.85rem; color:var(--text-muted);">${u.score} pts ${delta? ' ‚Ä¢ ' + delta : ''}</div>
                </div>
                <div style="font-weight:800;">${u.score}</div>
            </div>
        `;
    }).join('');

    return `
        <div>
            <div style="display:flex; gap:16px; align-items:flex-end; margin-bottom:18px;">
                ${podiumHtml}
            </div>
            <div style="margin-top:8px;">${listRows}</div>
            <div style="margin-top:8px; font-size:0.875rem; color:var(--text-muted); text-align: center;">Leaderboard updates daily and is generated locally.</div>
        </div>
    `;
}

// Persist assigned avatars into IndexedDB so fake users keep their avatars between sessions
async function persistAssignedAvatarsToDB() {
    try {
        const lb = await dbGet('leaderboard','scores');
        if (!lb || !Array.isArray(lb.users)) return;
        lb.users.forEach(u => {
            if (!u.avatar || !(u.avatar.dataURL || u.avatar.url)) {
                u.avatar = u.avatar || {};
                if (window._assignedAvatars && window._assignedAvatars[u.name]) {
                    u.avatar.url = window._assignedAvatars[u.name];
                }
            }
        });
        await dbSet('leaderboard', { id: 'scores', users: lb.users, lastUpdated: new Date().toISOString() });
        console.log('Persisted assigned avatars to leaderboard DB.');
    } catch (e) {
        console.error('Failed to persist avatars', e);
    }
}

// Render a compact profile card to be shown above the leaderboard
function renderLeaderboardProfile(userName, userScore) {
    // read additional user info from userData
    const user = window.userData || {};
    const streak = user.streak || 0;
    const highlights = (user.highlights && user.highlights.length) || 0;
    const joined = user.joined || user.dateJoined || 'Unknown';
    const levelInfo = calculateFaithLevel ? calculateFaithLevel() : { level: (user.level || 1), progress: 0, nextLevelText: '' };

    return `
        <div class="card lb-profile-card" style="cursor:pointer; margin-bottom:12px;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <div style="width:52px; height:52px; border-radius:50%; background:var(--surface); display:flex; align-items:center; justify-content:center; font-size:1.5rem; overflow:hidden;">
                        ${ (user && user.avatar && (user.avatar.dataURL || user.avatar.url)) ? ('<button class="btn btn-icon" style="padding:0; border:0; background:transparent; cursor:pointer; display:block; width:100%; height:100%;" onclick="showUserProfile()" aria-label="Open profile">' +
                            '<img src="' + (user.avatar.dataURL || user.avatar.url) + '" alt="' + (userName||'Profile') + '" style="width:100%; height:100%; object-fit:cover; display:block;">' +
                        '</button>') : ('<button class="btn btn-icon" style="padding:0; border:0; background:transparent; cursor:pointer; display:block; width:100%; height:100%; font-size:1.25rem;" onclick="showUserProfile()" aria-label="Open profile">' + ((userName||'U').charAt(0)) + '</button>') }
                    </div>
                    <div>
                        <div style="font-weight:700;">${userName || 'You'}</div>
                        <div style="font-size:0.85rem; color:var(--text-muted);">Level ${levelInfo.level} ‚Ä¢ ${userScore} pts</div>
                    </div>
                </div>
                <div style="font-size:0.9rem; color:var(--text-muted);">Tap to expand ‚ñæ</div>
            </div>
            <div class="lb-profile-details hidden" style="margin-top:12px;">
                <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:8px;">
                    <div style="text-align:center;"><div style="font-weight:700; color:var(--accent-gold);">${streak}</div><div style="font-size:0.8rem; color:var(--text-secondary);">Streak</div></div>
                    <div style="text-align:center;"><div style="font-weight:700; color:var(--accent-gold);">${highlights}</div><div style="font-size:0.8rem; color:var(--text-secondary);">Highlights</div></div>
                    <div style="text-align:center;"><div style="font-weight:700; color:var(--accent-gold);">${levelInfo.level}</div><div style="font-size:0.8rem; color:var(--text-secondary);">Level</div></div>
                </div>
                <div style="margin-top:12px; font-size:0.9rem; color:var(--text-secondary);">Rank and other details are shown in the leaderboard below.</div>
            </div>
        </div>
    `;
}


    function resetBibleView() {
    const bibleFilter = document.querySelector('.bible-filter-section');
    if (bibleFilter) bibleFilter.classList.remove('hidden');
    
}
function showLeaderboardPage() {
    const topSlot = document.getElementById('leaderboard-page-top');
    const container = document.getElementById('leaderboard-page-container');

    // Build leaderboard data
    getLeaderboardFromDB().then(async (list) => {
        // Update leaderboard scores to keep it competitive
        await updateLeaderboardScores();
        list = await getLeaderboardFromDB();

        const userScore = computeUserScoreFromUserData();
        const userName = (userData && userData.name) ? userData.name : 'YOU';

        // Remove user from list if already there, then add current score
        list = list.filter(u => u.name !== userName);
        // Prepare current user entry and ensure avatar shape
        const currentUser = { name: userName, score: userScore };
        if (window.userData && window.userData.avatar) {
            currentUser.avatar = window.userData.avatar;
        }
        // If the user has no custom avatar, do not assign a random one.
        // The rendering logic will fall back to showing initials.
        list.push(currentUser);
        list.sort((a, b) => b.score - a.score);

        // compute previous snapshot for movement indicator
        dbGet('leaderboard', 'previous').then(prevData => {
            const prev = prevData ? prevData.snapshot : null;
            
            // render profile card (now as a page-level card)
            if (topSlot) {
                topSlot.innerHTML = renderLeaderboardProfile(userName, userScore);
            }

            // render leaderboard list inside the page container
            if (container) {
                container.innerHTML = renderLeaderboard(list, prev, userName);
                // attach image fallback handlers so missing files show initials instead of broken icons
                try { attachAvatarFallbacks(container); attachAvatarFallbacks(topSlot); } catch(e) { /* ignore */ }
            }

            // Persist assigned avatars for fake users so they remain across sessions
            try { persistAssignedAvatarsToDB().catch(()=>{}); } catch(e) { /* ignore */ }

            // Attach expand toggle for the page-level profile card
            const profileCard = document.querySelector('#leaderboard-page-top .lb-profile-card');
            if (profileCard) {
                profileCard.addEventListener('click', function () {
                    profileCard.classList.toggle('expanded');
                    const details = profileCard.querySelector('.lb-profile-details');
                    if (details) details.classList.toggle('hidden');
                });
            }
        }).catch(error => {
            console.error('Error getting previous leaderboard:', error);
            if (topSlot) {
                topSlot.innerHTML = renderLeaderboardProfile(userName, userScore);
            }
            if (container) {
                container.innerHTML = renderLeaderboard(list, null, userName);
                try { attachAvatarFallbacks(container); attachAvatarFallbacks(topSlot); } catch(e) { /* ignore */ }
            }
        });
    }).catch(error => {
        console.error('Error loading leaderboard:', error);
    });
}
// Bible Quiz Questions
const bibleQuizQuestions = [
    {
        question: "How many days did God take to create the world?",
        options: ["6 days", "7 days", "1 day", "40 days"],
        correct: 0,
        reference: "Genesis 1:31-2:2"
    },
    {
        question: "Who was thrown into a lions' den but survived because God protected him?",
        options: ["David", "Daniel", "Samuel", "Joseph"],
        correct: 1,
        reference: "Daniel 6:16-23"
    },
    {
        question: "What was the name of the giant that David defeated?",
        options: ["Goliath", "Herod", "Pharaoh", "Saul"],
        correct: 0,
        reference: "1 Samuel 17:49-50"
    },
    {
        question: "How many books are in the New Testament?",
        options: ["27", "39", "66", "12"],
        correct: 0,
        reference: "Complete Bible"
    },
    {
        question: "Who denied Jesus three times before the rooster crowed?",
        options: ["Peter", "John", "Judas", "Thomas"],
        correct: 0,
        reference: "Matthew 26:69-75"
    },
    {
        question: "What is the last book of the Bible?",
        options: ["Revelation", "Jude", "Malachi", "Acts"],
        correct: 0,
        reference: "Revelation 22:21"
    },
    
    {
        question: "Who was the prophet that confronted King Ahab and the prophets of Baal on Mount Carmel?",
        options: ["Elisha", "Moses", "Elijah", "Isaiah"],
        correct: 2,
        reference: "1 Kings 18:20-40"
    },
    {
        question: "Which Old Testament prophet saw a vision of a valley full of dry bones?",
        options: ["Ezekiel", "Daniel", "Isaiah", "Jeremiah"],
        correct: 0,
        reference: "Ezekiel 37:1-10"
    },
    {
        question: "Which king of Judah was struck with leprosy for unlawfully burning incense in the temple?",
        options: ["Uzziah", "Hezekiah", "Ahaz", "Manasseh"],
        correct: 0,
        reference: "2 Chronicles 26:16-21"
    },
    {
        question: "Who was the left-handed judge that killed King Eglon of Moab?",
        options: ["Ehud", "Shamgar", "Gideon", "Jephthah"],
        correct: 0,
        reference: "Judges 3:15-22"
    },
    {
        question: "What prophet married a prostitute as a sign of Israel‚Äôs unfaithfulness to God?",
        options: ["Hosea", "Ezekiel", "Amos", "Joel"],
        correct: 0,
        reference: "Hosea 1:2-3"
    },
    {
        question: "Who hid 100 prophets in caves to protect them from Jezebel?",
        options: ["Obadiah", "Elijah", "Jehu", "Elisha"],
        correct: 0,
        reference: "1 Kings 18:3-4"
    },
    {
        question: "Which prophet had a vision of a flying scroll?",
        options: ["Zechariah", "Habakkuk", "Malachi", "Micah"],
        correct: 0,
        reference: "Zechariah 5:1-2"
    },
    {
        question: "Who was the high priest when Samuel was a boy serving in the temple?",
        options: ["Eli", "Aaron", "Phinehas", "Abijah"],
        correct: 0,
        reference: "1 Samuel 1:9"
    },
    {
        question: "What was the name of the Roman governor who replaced Felix and heard Paul‚Äôs case?",
        options: ["Pilate", "Festus", "Herod", "Agrippa"],
        correct: 1,
        reference: "Acts 24:27"
    },
    {
        question: "Who was the scribe that helped Ezra teach the Law to the people?",
        options: ["Nehemiah", "Baruch", "Zerubbabel", "Ezra himself"],
        correct: 3,
        reference: "Nehemiah 8:1-3"
    },
    {
        question: "What city did Paul escape from by being lowered in a basket through the wall?",
        options: ["Damascus", "Antioch", "Corinth", "Philippi"],
        correct: 0,
        reference: "Acts 9:25"
    },
    {
        question: "Who was the prophet that said, 'The heart is deceitful above all things'?",
        options: ["Isaiah", "Jeremiah", "Ezekiel", "Solomon"],
        correct: 1,
        reference: "Jeremiah 17:9"
    },
    {
        question: "Which apostle was exiled to the island of Patmos?",
        options: ["Peter", "Paul", "John", "James"],
        correct: 2,
        reference: "Revelation 1:9"
    },
    {
        question: "What was the name of Abraham‚Äôs second wife after Sarah died?",
        options: ["Keturah", "Hagar", "Rebekah", "Milcah"],
        correct: 0,
        reference: "Genesis 25:1"
    },
    {
        question: "Who was the only female judge of Israel?",
        options: ["Deborah", "Jael", "Miriam", "Ruth"],
        correct: 0,
        reference: "Judges 4:4"
    },
    {
        question: "Which prophet saw the Lord high and exalted, seated on a throne, with seraphim around Him?",
        options: ["Isaiah", "Ezekiel", "Jeremiah", "Daniel"],
        correct: 0,
        reference: "Isaiah 6:1-3"
    },
    {
        question: "Which apostle‚Äôs shadow healed the sick as he walked by?",
        options: ["Peter", "Paul", "John", "Philip"],
        correct: 0,
        reference: "Acts 5:15"
    },
    {
        question: "Who was the prophet during the time of King Hezekiah when Sennacherib attacked Judah?",
        options: ["Isaiah", "Jeremiah", "Micah", "Amos"],
        correct: 0,
        reference: "2 Kings 19:1-7"
    },
    {
        question: "What did the writing on Belshazzar‚Äôs wall say?",
        options: ["MENE, MENE, TEKEL, PARSIN", "ELOI, ELOI, LAMA SABACHTHANI", "HOLY, HOLY, HOLY", "GLORY TO GOD IN THE HIGHEST"],
        correct: 0,
        reference: "Daniel 5:25"
    },
    {
        question: "Which prophet said that Bethlehem would be the birthplace of the Messiah?",
        options: ["Micah", "Hosea", "Amos", "Zechariah"],
        correct: 0,
        reference: "Micah 5:2"
    },
    {
        question: "Which king of Israel asked for wisdom instead of wealth or power?",
        options: ["Solomon", "David", "Saul", "Hezekiah"],
        correct: 0,
        reference: "1 Kings 3:9-12"
    },
    {
        question: "Which New Testament book quotes a pagan poet saying, 'In him we live and move and have our being'?",
        options: ["Acts", "Romans", "1 Corinthians", "Galatians"],
        correct: 0,
        reference: "Acts 17:28"
    },
    {
        question: "Who fell asleep during Paul‚Äôs sermon and fell out of a window?",
        options: ["Eutychus", "Ananias", "Tychicus", "Apollos"],
        correct: 0,
        reference: "Acts 20:9"
    },
    {
        question: "What king saw four men walking in a fiery furnace?",
        options: ["Nebuchadnezzar", "Belshazzar", "Darius", "Cyrus"],
        correct: 0,
        reference: "Daniel 3:24-25"
    },
    {
        question: "Which tribe of Israel served as priests and had no land inheritance?",
        options: ["Levi", "Judah", "Benjamin", "Simeon"],
        correct: 0,
        reference: "Numbers 18:20-24"
    },
    {
        question: "Who was the cupbearer to King Artaxerxes?",
        options: ["Nehemiah", "Ezra", "Daniel", "Mordecai"],
        correct: 0,
        reference: "Nehemiah 1:11"
    },
    {
        question: "Which prophet was told to eat a scroll that tasted as sweet as honey?",
        options: ["Ezekiel", "Jeremiah", "Isaiah", "Daniel"],
        correct: 0,
        reference: "Ezekiel 3:1-3"
    },
    {
        question: "Who was struck dead for lying about the price of land they sold?",
        options: ["Ananias and Sapphira", "Simon and Helena", "Demas and Phoebe", "Felix and Drusilla"],
        correct: 0,
        reference: "Acts 5:1-10"
    },
    {
        question: "Which Old Testament character said, 'Though he slay me, yet will I trust in him'?",
        options: ["Job", "David", "Abraham", "Jeremiah"],
        correct: 0,
        reference: "Job 13:15"
    },
    {
        question: "What is the shortest verse in the Bible?",
        options: ["Jesus wept.", "Pray continually.", "Rejoice always.", "Fear God."],
        correct: 0,
        reference: "John 11:35"
    },
    {
        question: "Who was Jesus' mother?",
        options: ["Mary", "Elizabeth", "Martha", "Sarah"],
        correct: 0,
        reference: "Matthew 1:18"
    },
    {
        question: "What did Jesus turn water into at the wedding in Cana?",
        options: ["Wine", "Juice", "Oil", "Milk"],
        correct: 0,
        reference: "John 2:1-11"
    },
    {
        question: "How many disciples did Jesus have?",
        options: ["12", "7", "40", "3"],
        correct: 0,
        reference: "Matthew 10:1-4"
    },
    {
        question: "Who wrote most of the New Testament letters?",
        options: ["Paul", "Peter", "John", "James"],
        correct: 0,
        reference: "Various New Testament Books"
    }
];

// Quiz Game Variables
let currentQuizSession = [];;
let quizScore = 0;
let quizTimeLeft = 60;
let quizTimer = null;
let quizAnswers = [];

// Show Bible Quiz Modal
function startBibleQuiz() {
    const modal = document.getElementById('bible-quiz-modal');
    showQuizStartScreen();
    modal.classList.add('active');
}

// Hide Bible Quiz Modal
function hideBibleQuiz() {
    const modal = document.getElementById('bible-quiz-modal');
    modal.classList.remove('active');
    resetQuizGame();
}
// Get random questions from the pool
function getRandomQuestions(count) {
    // Create a copy of all questions
    const allQuestions = [...bibleQuizQuestions];
    const selectedQuestions = [];
    
    // Randomly pick questions
    for (let i = 0; i < count && allQuestions.length > 0; i++) {
        const randomIndex = Math.floor(Math.random() * allQuestions.length);
        selectedQuestions.push(allQuestions[randomIndex]);
        allQuestions.splice(randomIndex, 1); // Remove so we don't pick same question twice
    }
    
    return selectedQuestions;
}

// Show Start Screen
function showQuizStartScreen() {
    document.getElementById('quiz-start-screen').classList.remove('hidden');
    document.getElementById('quiz-game-screen').classList.add('hidden');
    document.getElementById('quiz-results-screen').classList.add('hidden');
}

// Start the Quiz Game
function startQuizGame() {
    // Reset game state
    currentQuizQuestion = 0;
    quizScore = 0;
    quizTimeLeft = 60;
    quizAnswers = [];
      currentQuizSession = getRandomQuestions(10);
    
    // Show game screen
    document.getElementById('quiz-start-screen').classList.add('hidden');
    document.getElementById('quiz-game-screen').classList.remove('hidden');
    document.getElementById('quiz-results-screen').classList.add('hidden');
    
    // Start timer
    startQuizTimer();
    
    // Load first question
    loadQuizQuestion();
}

// Quiz Timer
function startQuizTimer() {
    clearInterval(quizTimer);
    quizTimer = setInterval(() => {
        quizTimeLeft--;
        document.getElementById('quiz-timer').textContent = quizTimeLeft;
        
        if (quizTimeLeft <= 0) {
            endQuizGame();
        }
    }, 1000);
}

// Load Quiz Question
function loadQuizQuestion() {
    // Use the random questions from currentQuizSession
    const question = currentQuizSession[currentQuizQuestion];
    document.getElementById('quiz-current').textContent = currentQuizQuestion + 1;
    document.getElementById('quiz-question').textContent = question.question;
    
    const optionsContainer = document.getElementById('quiz-options');
    optionsContainer.innerHTML = '';
    
    question.options.forEach((option, index) => {
        const button = document.createElement('button');
        button.className = 'btn btn-secondary';
        button.style.textAlign = 'left';
        button.style.justifyContent = 'flex-start';
        button.innerHTML = `
            <span style="font-weight: 700; margin-right: 10px;">${String.fromCharCode(65 + index)}.</span>
            ${option}
        `;
        button.onclick = () => selectQuizAnswer(index);
        optionsContainer.appendChild(button);
    });
    
    // Clear feedback
    document.getElementById('quiz-feedback').classList.add('hidden');
}

// Select Answer
function selectQuizAnswer(selectedIndex) {
    // Use the random questions from currentQuizSession
    const question = currentQuizSession[currentQuizQuestion];
    const feedback = document.getElementById('quiz-feedback');
    const isCorrect = selectedIndex === question.correct;
    
    // Record answer
    quizAnswers.push({
        question: question.question,
        selected: selectedIndex,
        correct: question.correct,
        isCorrect: isCorrect
    });
    
    if (isCorrect) {
        quizScore += 10;
        feedback.innerHTML = `
            <div style="color: var(--accent-sage); font-weight: 700;">
                ‚úÖ Correct! +10 points
            </div>
            <div style="font-size: 0.9rem; margin-top: 5px;">
                Reference: ${question.reference}
            </div>
        `;
    } else {
        feedback.innerHTML = `
            <div style="color: #c98986; font-weight: 700;">
                ‚ùå Incorrect. The correct answer was: ${question.options[question.correct]}
            </div>
            <div style="font-size: 0.9rem; margin-top: 5px;">
                Reference: ${question.reference}
            </div>
        `;
    }
    
    feedback.classList.remove('hidden');
    
    // Move to next question after delay
    setTimeout(() => {
        currentQuizQuestion++;
        // Check against the random session length (should be 10)
        if (currentQuizQuestion < currentQuizSession.length) {
            loadQuizQuestion();
        } else {
            endQuizGame();
        }
    }, 2000);
}
// End Quiz Game
function endQuizGame() {
    clearInterval(quizTimer);
    
    // Calculate bonus points (1 point per second remaining)
    const timeBonus = Math.max(0, quizTimeLeft);
    const totalPoints = quizScore + timeBonus;
    
    // Update results screen
    document.getElementById('quiz-final-score').textContent = quizScore;
    document.getElementById('quiz-correct-answers').textContent = quizAnswers.filter(a => a.isCorrect).length;
    document.getElementById('quiz-time-bonus').textContent = timeBonus;
    document.getElementById('quiz-total-points').textContent = totalPoints;
    
    // Show results screen
    document.getElementById('quiz-game-screen').classList.add('hidden');
    document.getElementById('quiz-results-screen').classList.remove('hidden');
    
    // Add points to leaderboard
    addGamePoints(totalPoints, 'quiz');
}

// Restart Quiz
function restartBibleQuiz() {
    resetQuizGame();
    startQuizGame();
}

// Reset Quiz Game
function resetQuizGame() {
    clearInterval(quizTimer);
    currentQuizQuestion = 0;
    quizScore = 0;
    quizTimeLeft = 60;
    quizAnswers = [];
}

// Complete achievement system
const ACHIEVEMENTS = [
    {
        id: 'first_day',
        title: 'First Steps',
        description: 'Open Zcriptures for the first time',
        crest: 'üå±',
        reward: '+10 XP',
        condition: () => true
    },
    {
        id: 'week_warrior',
        title: 'Week Warrior',
        description: 'Maintain a 7-day streak',
        crest: 'üî•',
        reward: '+50 XP',
        condition: () => userData.streak >= 7
    },
    {
        id: 'monthly_master',
        title: 'Monthly Master',
        description: 'Maintain a 30-day streak',
        crest: 'üìÖ',
        reward: '+150 XP',
        condition: () => userData.streak >= 30
    },
    {
        id: 'highlight_hero',
        title: 'Highlight Hero',
        description: 'Highlight 10 verses',
        crest: '‚≠ê',
        reward: '+30 XP',
        condition: () => userData.highlights && userData.highlights.length >= 10
    },
    {
        id: 'verse_collector',
        title: 'Verse Collector',
        description: 'Highlight 50 verses',
        crest: 'üåü',
        reward: '+100 XP',
        condition: () => userData.highlights && userData.highlights.length >= 50
    },
    {
        id: 'challenge_champion',
        title: 'Challenge Champion',
        description: 'Complete 10 daily challenges',
        crest: 'üèÜ',
        reward: '+75 XP',
        condition: () => calculateCompletedChallenges() >= 10
    },
    {
        id: 'scripture_scholar',
        title: 'Scripture Scholar',
        description: 'Reach Faith Level 5',
        crest: 'üìö',
        reward: '+200 XP',
        condition: () => calculateFaithLevel().level >= 5
    },
    {
        id: 'centurion',
        title: 'Centurion',
        description: 'Maintain a 100-day streak',
        crest: 'üíØ',
        reward: '+500 XP',
        condition: () => userData.streak >= 100
    },
    {
        id: 'prayer_warrior',
        title: 'Prayer Warrior',
        description: 'Use prayer section 20 times',
        crest: 'üôè',
        reward: '+60 XP',
        condition: () => userData.prayerCount >= 20
    },
    {
        id: 'bible_explorer',
        title: 'Bible Explorer',
        description: 'Read chapters from 10 different books',
        crest: 'üó∫Ô∏è',
        reward: '+80 XP',
        condition: () => userData.booksRead >= 10
    },
    {
        id: 'sharing_saint',
        title: 'Sharing Saint',
        description: 'Share 5 verses or chapters',
        crest: 'üì§',
        reward: '+40 XP',
        condition: () => userData.sharesCount >= 5
    },
    {
        id: 'level_legend',
        title: 'Level Legend',
        description: 'Reach Faith Level 10',
        crest: 'üëë',
        reward: '+1000 XP',
        condition: () => calculateFaithLevel().level >= 10
    },
    {
        id: 'consistency_king',
        title: 'Consistency King',
        description: 'No missed days in 60 days',
        crest: '‚ö°',
        reward: '+300 XP',
        condition: () => userData.streak >= 60
    },
    {
        id: 'motivation_master',
        title: 'Motivation Master',
        description: 'Visit motivation section 50 times',
        crest: 'üí™',
        reward: '+70 XP',
        condition: () => userData.motivationVisits >= 50
    },
    {
        id: 'history_buff',
        title: 'History Buff',
        description: 'Explore all history sections',
        crest: 'üìú',
        reward: '+90 XP',
        condition: () => userData.historyVisits >= 4
    },
    {
        id: 'study_scholar',
        title: 'Study Scholar',
        description: 'Complete 20 Bible study topics',
        crest: 'üîç',
        reward: '+120 XP',
        condition: () => userData.studyTopics >= 20
    },
    {
        id: 'faithful_friend',
        title: 'Faithful Friend',
        description: 'Use app for 365 days total',
        crest: '‚ù§Ô∏è',
        reward: '+1500 XP',
        condition: () => calculateTotalDays() >= 365
    },
    {
        id: 'diamond_devotee',
        title: 'Diamond Devotee',
        description: 'Reach Faith Level 15',
        crest: 'üíé',
        reward: '+2000 XP',
        condition: () => calculateFaithLevel().level >= 15
    },
    {
        id: 'ultimate_believer',
        title: 'Ultimate Believer',
        description: 'Complete all other achievements',
        crest: 'üèÖ',
        reward: '+5000 XP',
        condition: () => {
            const earned = ACHIEVEMENTS.filter(a => a.id !== 'ultimate_believer' && a.condition()).length;
            return earned >= ACHIEVEMENTS.length - 1;
        }
    }
];

function updateAchievements() {
    const container = document.getElementById('achievements-container');
    const earnedAchievements = ACHIEVEMENTS.filter(achievement => achievement.condition());
    
    // Show first 3 earned achievements in profile
    const displayAchievements = earnedAchievements.slice(0, 3);
    
    if (displayAchievements.length === 0) {
        container.innerHTML = '<span class="achievement-badge">üå± Getting Started</span>';
    } else {
        container.innerHTML = displayAchievements.map(achievement => 
            `<span class="achievement-badge" title="${achievement.description}">${achievement.crest} ${achievement.title}</span>`
        ).join('');
    }
    
    // Update achievement count
    const countElement = document.getElementById('achievement-count');
    if (countElement) {
        countElement.textContent = `(${earnedAchievements.length}/${ACHIEVEMENTS.length})`;
    }
}

function showAchievementsPage() {
    populateFullAchievements();
    document.getElementById('achievements-modal').classList.add('active');
}

function hideAchievementsPage() {
    document.getElementById('achievements-modal').classList.remove('active');
}

function populateFullAchievements() {
    const grid = document.getElementById('full-achievements-grid');
    const earnedCount = ACHIEVEMENTS.filter(a => a.condition()).length;
    const totalCount = ACHIEVEMENTS.length;
    const percentage = Math.round((earnedCount / totalCount) * 100);
    
    // Update stats
    document.getElementById('total-achievements-earned').textContent = earnedCount;
    document.getElementById('total-achievements-possible').textContent = totalCount;
    document.getElementById('achievement-percentage').textContent = `${percentage}%`;
    document.getElementById('achievement-progress-fill').style.width = `${percentage}%`;
    
    // Populate grid
    grid.innerHTML = ACHIEVEMENTS.map(achievement => {
        const earned = achievement.condition();
        return `
            <div class="achievement-card ${earned ? 'earned' : 'locked'}">
                <div class="achievement-crest">${achievement.crest}</div>
                <div class="achievement-title">${achievement.title}</div>
                <div class="achievement-description">${achievement.description}</div>
                <div class="achievement-reward">${earned ? 'EARNED!' : achievement.reward}</div>
            </div>
        `;
    }).join('');
}

// Close modal when clicking outside (guarded)
const achievementsModalEl = document.getElementById('achievements-modal');
if (achievementsModalEl) {
    achievementsModalEl.addEventListener('click', function(e) {
        if (e.target === this) {
            hideAchievementsPage();
        }
    });
} else {
    console.warn('achievements-modal element not found; click-to-close handler not attached');
}
function updateProfileAvatar() {
    const avatar = document.getElementById('profile-avatar');
    const name = userData.name || 'Friend';
    
    // Use first letter of name as avatar
    // If user has custom avatar stored (dataURL), show it; otherwise show initial
    if (userData && userData.avatar && userData.avatar.dataURL) {
        avatar.innerHTML = '';
        const img = document.createElement('img');
        img.src = userData.avatar.dataURL;
        img.alt = userData.name || 'Profile';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        avatar.appendChild(img);
        // update header avatar
        const hImg = document.getElementById('header-avatar-img');
        const hFallback = document.getElementById('header-avatar-fallback');
        if (hImg) { hImg.src = userData.avatar.dataURL; hImg.style.display = 'block'; }
        if (hFallback) hFallback.style.display = 'none';
    } else {
        avatar.textContent = name.charAt(0).toUpperCase();
        const hImg = document.getElementById('header-avatar-img');
        const hFallback = document.getElementById('header-avatar-fallback');
        if (hImg) { hImg.src = ''; hImg.style.display = 'none'; }
        if (hFallback) { hFallback.style.display = 'block'; hFallback.textContent = (name||'F').charAt(0).toUpperCase(); }
    }
}

// Sync header avatar image/fallback with userData
function updateHeaderAvatarSync() {
    const hImg = document.getElementById('header-avatar-img');
    const hFallback = document.getElementById('header-avatar-fallback');
    const avatarBtn = document.getElementById('header-avatar-btn');
    if (!hImg || !hFallback || !avatarBtn) return;

    if (userData && userData.avatar && userData.avatar.dataURL) {
        hImg.src = userData.avatar.dataURL;
        hImg.style.display = 'block';
        hImg.style.objectFit = 'cover';
        hImg.style.borderRadius = '50%';
        hFallback.style.display = 'none';
    } else {
        hImg.src = '';
        hImg.style.display = 'none';
        hFallback.style.display = 'block';
        hFallback.style.color = 'var(--text-primary)';
        hFallback.textContent = (userData.name || 'F').charAt(0).toUpperCase();
    }
}

// Open hidden file input to pick avatar
function openAvatarPicker() {
    const input = document.getElementById('avatar-file-input');
    if (!input) return;
    input.value = '';
    input.click();
}

// Handle file input change
document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('avatar-file-input');
    if (!input) return;
    input.addEventListener('change', async function(e) {
        const file = e.target.files && e.target.files[0];
        if (!file) return;

        // Quick size limit: 1.5MB recommended for performance
        if (file.size > 1.5 * 1024 * 1024) {
            showToast('Image too large. Please choose an image under 1.5MB', 'error');
            return;
        }

        // Read as data URL
        const reader = new FileReader();
        reader.onload = async function(evt) {
            const dataURL = evt.target.result;

            // Save into userData.avatar
            userData.avatar = { dataURL: dataURL, name: file.name, updated: new Date().toISOString() };
            await saveUserData();
            updateProfileAvatar();
            showToast('Profile picture updated');
        };
        reader.readAsDataURL(file);
    });
});

// Remove avatar
async function removeAvatar() {
    if (!userData || !userData.avatar) {
        showToast('No custom avatar to remove');
        return;
    }
    if (!confirm('Remove your custom profile picture?')) return;
    delete userData.avatar;
    await saveUserData();
    updateProfileAvatar();
    showToast('Profile picture removed');
}

// BIO editing helpers
function toggleEditBio() {
    const bio = document.getElementById('profile-bio');
    const ta = document.getElementById('profile-bio-textarea');
    const actions = document.getElementById('profile-bio-actions');
    if (!bio || !ta || !actions) return;

    if (ta.style.display === 'none' || ta.style.display === '') {
        // enter edit mode
        ta.value = userData.bio || '';
        ta.style.display = 'block';
        actions.style.display = 'flex';
        bio.style.display = 'none';
    } else {
        // already editing ‚Äî cancel
        ta.style.display = 'none';
        actions.style.display = 'none';
        bio.style.display = 'block';
    }
}

function cancelEditBio() {
    const ta = document.getElementById('profile-bio-textarea');
    const actions = document.getElementById('profile-bio-actions');
    const bio = document.getElementById('profile-bio');
    if (!ta || !actions || !bio) return;
    ta.style.display = 'none';
    actions.style.display = 'none';
    bio.style.display = 'block';
}

async function saveBio() {
    const ta = document.getElementById('profile-bio-textarea');
    const bio = document.getElementById('profile-bio');
    if (!ta || !bio) return;
    let text = ta.value || '';

    // Simple sanitize: escape < and > to prevent HTML injection. This keeps it plain text.
    text = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');

    userData.bio = text;
    await saveUserData();

    // Update display (render sanitized text)
    bio.innerHTML = text ? text.replace(/\n/g, '<br>') : 'You don\'t have a bio yet. Add one!';
    cancelEditBio();
    showToast('Bio saved');
}

// Responsive font sizing: choose a comfortable root font-size based on viewport width.
function setResponsiveFontSize() {
    try {
        const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
        // Further tuned sizes to keep UI elements from becoming cramped.
        // 320px -> 12px; 360px -> 13px; 412px -> 14px; tablet -> 15px; desktop -> 15.5-16px
        let base = 14; // default
        if (vw < 340) base = 12;
        else if (vw < 370) base = 13;
        else if (vw < 430) base = 14;
        else if (vw < 800) base = 15;
        else if (vw < 1200) base = 15.5;
        else base = 16;

        // Apply root font-size and expose variables for component spacing
        document.documentElement.style.fontSize = base + 'px';
        document.documentElement.style.setProperty('--responsive-font-size', base + 'px');

        // Compute card spacing variables (use rem-based values so they scale with root font-size)
        let cardPadding = '0.6rem';
        let cardMinHeight = (base / 16 * 3) + 'rem'; // ~3rem at 16px, scales down
        let cardLineHeight = '1.35';

        if (base <= 12) {
            cardPadding = '0.45rem';
            cardMinHeight = '2.6rem';
            cardLineHeight = '1.28';
        } else if (base === 13) {
            cardPadding = '0.5rem';
            cardMinHeight = '2.85rem';
            cardLineHeight = '1.3';
        } else if (base === 14) {
            cardPadding = '0.6rem';
            cardMinHeight = '3rem';
            cardLineHeight = '1.33';
        } else if (base >= 15) {
            cardPadding = '0.7rem';
            cardMinHeight = '3.4rem';
            cardLineHeight = '1.38';
        }

        document.documentElement.style.setProperty('--card-padding', cardPadding);
        document.documentElement.style.setProperty('--card-min-height', cardMinHeight);
        document.documentElement.style.setProperty('--card-line-height', cardLineHeight);

        // Inject or update a global style block that ensures cards and activity items get breathing room
        const STYLE_ID = 'responsive-overrides';
        let styleEl = document.getElementById(STYLE_ID);
        const css = `
            /* Responsive overrides injected by script */
            .card, .activity-card, .topic-btn, .lb-profile-card, .book-item, .daily-verse {
                padding: var(--card-padding) !important;
                min-height: var(--card-min-height) !important;
                line-height: var(--card-line-height) !important;
                font-size: calc(var(--responsive-font-size) * 0.95) !important;
            }
            .card .card-title { font-size: calc(var(--responsive-font-size) * 1.05) !important; }
            .card .card-description { font-size: calc(var(--responsive-font-size) * 0.95) !important; }
            .topic-btn { display: block; width: 100%; box-sizing: border-box; }
        `;

        if (!styleEl) {
            styleEl = document.createElement('style');
            styleEl.id = STYLE_ID;
            styleEl.appendChild(document.createTextNode(css));
            document.head.appendChild(styleEl);
        } else {
            // Update existing content
            styleEl.textContent = css;
        }
    } catch (error) {
        console.error('Error setting responsive font size:', error);
    }
}

// Keep font responsive on resize/orientation change
window.addEventListener('resize', () => {
    // Throttle using rAF to avoid layout thrash on continuous resize
    if (window._fontResizeRaf) cancelAnimationFrame(window._fontResizeRaf);
    window._fontResizeRaf = requestAnimationFrame(() => setResponsiveFontSize());
});

function showBibleStoriesModal() {
    // Render into full-page Gen Z Stories section and navigate to it
    const section = document.getElementById('genz-stories-section');
    if (!section) {
        console.error('Gen Z stories section not found, falling back to modal');
        return;
    }

    const list = section.querySelector('#genz-stories-list');
    if (!list) return;

    list.innerHTML = `
        <div class="stories-grid">
            <button class="story-btn" data-story="adam" data-chapter="0">
                <div class="story-title">Adam &amp; Eve</div>
                <div class="story-excerpt">Genesis 3 ‚Ä¢ 3 parts</div>
            </button>

            <button class="story-btn" data-story="noah" data-chapter="0">
                <div class="story-title">Noah's Ark</div>
                <div class="story-excerpt">Genesis 6‚Äì9 ‚Ä¢ 5 parts</div>
            </button>

            <button class="story-btn" data-story="david" data-chapter="0">
                <div class="story-title">David and Goliath</div>
                <div class="story-excerpt">1 Samuel 17 ‚Ä¢ 5 parts</div>
            </button>

            <button class="story-btn" data-story="daniel" data-chapter="0">
                <div class="story-title">Daniel in the Lion's Den</div>
                <div class="story-excerpt">Daniel 6 ‚Ä¢ 4 parts</div>
            </button>

            <button class="story-btn" data-story="samaritan" data-chapter="0">
                <div class="story-title">The Good Samaritan</div>
                <div class="story-excerpt">Luke 10:25‚Äì37 ‚Ä¢ 4 parts</div>
            </button>

            <button class="story-btn" data-story="david_life" data-chapter="0">
                <div class="story-title">The Life of David</div>
                <div class="story-excerpt">1 Samuel 16 ‚Äì 2 Samuel 24 ‚Ä¢ 20 parts</div>
            </button>

            <button class="story-btn" data-story="jonah" data-chapter="0">
                <div class="story-title">Jonah and the Big Fish</div>
                <div class="story-excerpt">Jonah 1‚Äì4 ‚Ä¢ 4 parts</div>
            </button>

            <button class="story-btn" data-story="paul" data-chapter="0">
                <div class="story-title">Paul the Apostle</div>
                <div class="story-excerpt">Acts 7‚Äì28 ‚Ä¢ 6 parts</div>
            </button>

            <button class="story-btn" data-story="elijah_baal" data-chapter="0">
                <div class="story-title">Elijah vs the Prophets of Baal</div>
                <div class="story-excerpt">1 Kings 18:16‚Äì40 ‚Ä¢ 3 parts</div>
            </button>
        </div>
    `;

    // Navigate to the section
    showSection('genz-stories-section');

    // Event delegation on the story list in the section
    list.addEventListener('click', function handler(e) {
        const storyBtn = e.target.closest('.story-btn');
        if (storyBtn) {
            e.preventDefault();
            const story = storyBtn.getAttribute('data-story');
            const chapter = parseInt(storyBtn.getAttribute('data-chapter'));
            readStoryChapter(story, chapter);
        }
    }, { once: false });
}


function readStoryChapter(storyKey, chapterIndex) {
    const story = stories[storyKey];
    const chapter = story.chapters[chapterIndex];

    // Render into the Gen Z Stories section
    const section = document.getElementById('genz-stories-section');
    const list = section.querySelector('#genz-stories-list');
    if (!list) return;

    list.innerHTML = `
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <h3 class="card-title" style="margin: 0;">${chapter.heading}</h3>
                    <p class="text-muted" style="margin-top: 4px; font-size: 0.85rem;">Part ${chapter.num} of ${story.totalChapters}</p>
                </div>
            </div>
            <div style="color: var(--text-secondary); line-height: 1.8; margin-bottom: 30px;">${chapter.content}</div>
            <div class="navigation-buttons">
                <div class="button-row">
                    ${chapterIndex > 0 ? `<button class="btn btn-secondary" onclick="readStoryChapter('${storyKey}', ${chapterIndex - 1})">‚Üê Previous</button>` : `<button class="btn btn-secondary" disabled style="opacity: 0.4; cursor: not-allowed;">‚Üê Previous</button>`}
                    <button class="btn btn-secondary" onclick="showBibleStoriesModal()">All Stories</button>
                </div>
                <div class="button-row">
                    ${chapterIndex < story.totalChapters - 1 ? `<button class="btn btn-secondary" onclick="readStoryChapter('${storyKey}', ${chapterIndex + 1})">Next ‚Üí</button>` : `<button class="btn btn-secondary" disabled style="opacity: 0.4; cursor: not-allowed;">Next ‚Üí</button>`}
                </div>
            </div>
        </div>
    `;

    // Navigate to the stories section
    showSection('genz-stories-section');
}

// Verse Match Game Data - Expanded to 20+ pairs
const verseMatchPairs = [
    {
        original: "For I know the plans I have for you, declares the Lord, plans to prosper you and not to harm you, plans to give you hope and a future.",
        genZ: "God's got your whole life planned out - major Ws only, no Ls in sight. He's plotting nothing but success and good vibes for your future.",
        reference: "Jeremiah 29:11"
    },
    {
        original: "The Lord is close to the brokenhearted and saves those who are crushed in spirit.",
        genZ: "God is right there with you when you're hurting and saves you when you feel completely broken.",
        reference: "Psalm 34:18"
    },
    {
        original: "I can do all this through him who gives me strength.",
        genZ: "I can handle literally anything with Jesus backing me up - unlimited power supply unlocked.",
        reference: "Philippians 4:13"
    },
    {
        original: "Do not be anxious about anything, but in every situation, by prayer and petition, with thanksgiving, present your requests to God.",
        genZ: "Stop stressing about everything. Just slide into God's DMs with your requests and stay grateful.",
        reference: "Philippians 4:6"
    },
    {
        original: "Trust in the Lord with all your heart and lean not on your own understanding.",
        genZ: "Trust God with your whole heart - don't rely on your own brain cells to figure everything out.",
        reference: "Proverbs 3:5"
    },
    {
        original: "The Lord is my shepherd, I lack nothing.",
        genZ: "God's got me covered - I'm not missing a single thing I actually need.",
        reference: "Psalm 23:1"
    },
    {
        original: "Be strong and courageous. Do not be afraid or terrified because of them, for the Lord your God goes with you.",
        genZ: "Be strong and brave. Don't let anyone scare you because God's literally your plus-one everywhere.",
        reference: "Deuteronomy 31:6"
    },
    {
        original: "But those who hope in the Lord will renew their strength. They will soar on wings like eagles.",
        genZ: "Wait on God and get that unlimited battery life. You'll be soaring like you got wings.",
        reference: "Isaiah 40:31"
    },
    {
        original: "Love is patient, love is kind. It does not envy, it does not boast, it is not proud.",
        genZ: "Real love is patient AF, kind energy, no toxic jealousy, doesn't flex weird, stays humble.",
        reference: "1 Corinthians 13:4"
    },
    {
        original: "Do not let any unwholesome talk come out of your mouths, but only what is helpful for building others up.",
        genZ: "Watch your mouth - only say stuff that builds people up, not tears them down.",
        reference: "Ephesians 4:29"
    }
];

// Verse Match Game Variables
let matchGameActive = false;
let matchStreak = 0;
let shuffledPairs = [];
let currentPairIndex = 0;

// Get random options for multiple choice
function getRandomOptions(correctGenZ) {
    // Get 3 random wrong answers
    const wrongOptions = verseMatchPairs
        .filter(pair => pair.genZ !== correctGenZ)
        .sort(() => Math.random() - 0.5)
        .slice(0, 3)
        .map(pair => pair.genZ);
    
    // Combine with correct answer and shuffle
    const allOptions = [...wrongOptions, correctGenZ];
    return shuffleArray(allOptions);
}

// Show Verse Match Modal
function startVerseMatch() {
    console.log('üéÆ Starting Verse Match...');
    const modal = document.getElementById('verse-match-modal');
    if (!modal) {
        console.error('‚ùå Verse Match modal not found!');
        showToast('Game loading error. Please refresh page.', 'error');
        return;
    }
    showMatchStartScreen();
    modal.classList.add('active');
}

// Hide Verse Match Modal
function hideVerseMatch() {
    const modal = document.getElementById('verse-match-modal');
    if (modal) modal.classList.remove('active');
    resetMatchGame();
}

// Show Start Screen
function showMatchStartScreen() {
    const startScreen = document.getElementById('match-start-screen');
    const gameScreen = document.getElementById('match-game-screen');
    const resultsScreen = document.getElementById('match-results-screen');
    
    if (startScreen) startScreen.classList.remove('hidden');
    if (gameScreen) gameScreen.classList.add('hidden');
    if (resultsScreen) resultsScreen.classList.add('hidden');
}

// Start the Game
function startMatchGame() {
    console.log('üöÄ Starting Verse Match Game...');
    
    matchStreak = 0;
    matchGameActive = true;
    
    // Shuffle all pairs and start fresh
    shuffledPairs = shuffleArray([...verseMatchPairs]);
    currentPairIndex = 0;
    
    const startScreen = document.getElementById('match-start-screen');
    const gameScreen = document.getElementById('match-game-screen');
    const resultsScreen = document.getElementById('match-results-screen');
    const feedbackEl = document.getElementById('match-feedback');
    
    if (startScreen) startScreen.classList.add('hidden');
    if (gameScreen) gameScreen.classList.remove('hidden');
    if (resultsScreen) resultsScreen.classList.add('hidden');
    if (feedbackEl) feedbackEl.classList.add('hidden');
    
    loadNextMatch();
}

// Load next match
function loadNextMatch() {
    console.log('üìñ Loading next match...');
    
    // If we've gone through all pairs, reshuffle
    if (currentPairIndex >= shuffledPairs.length) {
        console.log('üîÑ Reshuffling pairs...');
        shuffledPairs = shuffleArray([...verseMatchPairs]);
        currentPairIndex = 0;
    }
    
    const currentPair = shuffledPairs[currentPairIndex];
    console.log('üìù Current pair:', currentPair);
    
    if (!currentPair) {
        console.error('‚ùå No current pair found!');
        return;
    }
    
    const options = getRandomOptions(currentPair.genZ);
    console.log('‚úÖ Options generated:', options.length);
    
    // Update UI
    const scoreEl = document.getElementById('match-score');
    const originalVerseEl = document.getElementById('original-verse');
    const optionsContainer = document.getElementById('match-options');
    
    if (scoreEl) {
        scoreEl.textContent = matchStreak;
        console.log('üî• Score updated to:', matchStreak);
    }
    
    if (originalVerseEl) {
        originalVerseEl.textContent = `"${currentPair.original}"`;
        console.log('üìú Original verse set');
    }
    
    if (optionsContainer) {
        optionsContainer.innerHTML = ''; // Clear first
        
        options.forEach((option, index) => {
            const button = document.createElement('button');
            button.className = 'btn btn-secondary match-option';
            button.style.textAlign = 'left';
            button.style.justifyContent = 'flex-start';
            button.style.whiteSpace = 'normal';
            button.style.height = 'auto';
            button.style.minHeight = '60px';
            button.style.padding = '12px';
            button.style.marginBottom = '8px';
            button.textContent = option;
            
            button.onclick = () => {
                console.log('üñ±Ô∏è Option clicked:', index);
                selectMatchOption(index, option);
            };
            
            optionsContainer.appendChild(button);
        });
        console.log('üéØ Options buttons created:', options.length);
    }
    
    // Store current correct answer for checking
    window.currentCorrectGenZ = currentPair.genZ;
    window.currentReference = currentPair.reference;
    
    console.log('‚úÖ Match loaded successfully!');
}

// Select an option
function selectMatchOption(optionIndex, selectedGenZ) {
    console.log('üéØ Option selected:', optionIndex);
    
    if (!matchGameActive) {
        console.log('‚ùå Game not active!');
        return;
    }
    
    const isCorrect = selectedGenZ === window.currentCorrectGenZ;
    const feedback = document.getElementById('match-feedback');
    const options = document.querySelectorAll('.match-option');
    
    matchGameActive = false;
    
    // Highlight selected option
    if (options[optionIndex]) {
        options[optionIndex].classList.add(isCorrect ? 'btn-primary' : 'btn-danger');
        options[optionIndex].classList.remove('btn-secondary');
    }
    
    if (isCorrect) {
        matchStreak++;
        if (feedback) {
            feedback.innerHTML = `
                <div style="color: var(--accent-sage); font-weight: 700; font-size: 1.2rem;">
                    ‚úÖ Correct! +1 to streak üî•
                </div>
                <div style="font-size: 0.9rem; margin-top: 5px;">
                    Reference: ${window.currentReference}
                </div>
            `;
            feedback.style.background = 'rgba(102, 187, 106, 0.2)';
            feedback.classList.remove('hidden');
        }
        
        // Move to next pair after delay
        setTimeout(() => {
            currentPairIndex++;
            matchGameActive = true;
            loadNextMatch();
            if (feedback) feedback.classList.add('hidden');
        }, 1500);
        
    } else {
        // Wrong answer - game over
        if (feedback) {
            feedback.innerHTML = `
                <div style="color: #c98986; font-weight: 700; font-size: 1.2rem;">
                    ‚ùå Wrong!
                </div>
                <div style="font-size: 0.9rem; margin-top: 5px;">
                    The correct match was: "${window.currentCorrectGenZ}"
                </div>
                <div style="font-size: 0.9rem; margin-top: 5px;">
                    Reference: ${window.currentReference}
                </div>
            `;
            feedback.style.background = 'rgba(201, 137, 134, 0.2)';
            feedback.classList.remove('hidden');
        }
        
        setTimeout(() => {
            endMatchGame();
        }, 2500);
    }
}

// End the game
function endMatchGame() {
    matchGameActive = false;
    
    const pointsEarned = matchStreak * 10; // 10 points per correct match
    const isNewRecord = matchStreak > (userData.matchHighScore || 0);
    
    if (isNewRecord && matchStreak > 0) {
        userData.matchHighScore = matchStreak;
        saveUserData();
    }
    
    addGamePoints(pointsEarned, 'match');
    
    // Update results screen
    const finalScoreEl = document.getElementById('match-final-score');
    const streakCountEl = document.getElementById('match-streak-count');
    const newRecordEl = document.getElementById('match-new-record');
    
    if (finalScoreEl) finalScoreEl.textContent = pointsEarned;
    if (streakCountEl) streakCountEl.textContent = matchStreak;
    
    if (isNewRecord && matchStreak > 0) {
        if (newRecordEl) newRecordEl.classList.remove('hidden');
    } else {
        if (newRecordEl) newRecordEl.classList.add('hidden');
    }
    
    document.getElementById('match-game-screen').classList.add('hidden');
    document.getElementById('match-results-screen').classList.remove('hidden');
}

// Restart game
function restartMatchGame() {
    resetMatchGame();
    startMatchGame();
}

// Reset game state
function resetMatchGame() {
    matchGameActive = false;
    matchStreak = 0;
    shuffledPairs = [];
    currentPairIndex = 0;
}

// Bible Riddles Data - "Who Am I?" format
const bibleRiddles = [
    {
        question: "I was thrown into a lions' den but survived because God protected me. Who am I?",
        clues: [
            "I was a prophet in Babylon",
            "I prayed three times a day facing Jerusalem", 
            "I interpreted dreams for kings",
            "My enemies tricked the king into making a law against prayer"
        ],
        answer: "Daniel",
        reference: "Daniel 6:16-23"
    },
    {
        question: "I defeated a giant with just a sling and five stones. Who am I?",
        clues: [
            "I was the youngest of eight brothers",
            "I was a shepherd before becoming king",
            "I wrote many songs and poems",
            "I became king of Israel after Saul"
        ],
        answer: "David",
        reference: "1 Samuel 17:49-50"
    },
    {
        question: "I built a huge boat to save my family and animals from a flood. Who am I?",
        clues: [
            "I lived to be 950 years old",
            "God told me to build an ark",
            "I had three sons: Shem, Ham, and Japheth",
            "I sent out a dove to find dry land"
        ],
        answer: "Noah", 
        reference: "Genesis 6:9-22"
    },
    {
        question: "I was swallowed by a big fish after running away from God's command. Who am I?",
        clues: [
            "God told me to preach to Nineveh",
            "I tried to sail to Tarshish instead",
            "I spent three days in the fish's belly",
            "The people of Nineveh repented after my preaching"
        ],
        answer: "Jonah",
        reference: "Jonah 1:17"
    },
    {
        question: "I led the Israelites out of Egypt and through the Red Sea. Who am I?",
        clues: [
            "I was hidden in a basket in the Nile as a baby",
            "I talked to God through a burning bush",
            "I received the Ten Commandments on Mount Sinai",
            "I wrote the first five books of the Bible"
        ],
        answer: "Moses",
        reference: "Exodus 14:21-22"
    },
    {
        question: "I was a strong man whose strength was in my long hair. Who am I?",
        clues: [
            "I fought Philistines with a donkey's jawbone",
            "I told Delilah the secret of my strength",
            "My hair was cut while I was sleeping",
            "I pushed down the pillars of a temple"
        ],
        answer: "Samson",
        reference: "Judges 16:28-30"
    },
    {
        question: "I was sold into slavery by my brothers but became a ruler in Egypt. Who am I?",
        clues: [
            "I had a coat of many colors",
            "I interpreted dreams in prison",
            "I saved Egypt from famine",
            "I forgave my brothers when they came for food"
        ],
        answer: "Joseph",
        reference: "Genesis 41:41-43"
    },
    {
        question: "I was the first woman, created from Adam's rib. Who am I?",
        clues: [
            "I lived in the Garden of Eden",
            "I was tempted by a serpent",
            "I ate fruit from the forbidden tree",
            "I was the mother of all living"
        ],
        answer: "Eve",
        reference: "Genesis 2:21-22"
    },
    {
        question: "I was an apostle who denied Jesus three times before the rooster crowed. Who am I?",
        clues: [
            "I was a fisherman with my brother Andrew",
            "Jesus called me 'the Rock'",
            "I walked on water with Jesus",
            "I was the first to preach at Pentecost"
        ],
        answer: "Peter",
        reference: "Matthew 26:69-75"
    },
    {
        question: "I was a queen who saved my people from destruction. Who am I?",
        clues: [
            "I was chosen to be queen in a beauty contest",
            "My cousin Mordecai raised me",
            "I revealed Haman's plot to the king",
            "My bravery saved the Jewish people"
        ],
        answer: "Esther",
        reference: "Esther 4:14-16"
    }
];

// Bible Riddles Game Variables
let currentRiddle = null;
let riddleScore = 0;
let riddlesSolved = 0;
let currentClueIndex = 0;
let usedRiddles = [];
let riddleGameActive = false;

// Show Bible Riddles Modal
function startBibleRiddles() {
    const modal = document.getElementById('bible-riddles-modal');
    if (!modal) {
        console.error('Bible Riddles modal not found!');
        showToast('Game loading error. Please refresh page.', 'error');
        return;
    }
    showRiddlesStartScreen();
    modal.classList.add('active');
}

// Hide Bible Riddles Modal  
function hideBibleRiddles() {
    const modal = document.getElementById('bible-riddles-modal');
    if (modal) modal.classList.remove('active');
    resetRiddlesGame();
}

// Show Start Screen
function showRiddlesStartScreen() {
    const startScreen = document.getElementById('riddles-start-screen');
    const gameScreen = document.getElementById('riddles-game-screen');
    const resultsScreen = document.getElementById('riddles-results-screen');
    
    if (startScreen) startScreen.classList.remove('hidden');
    if (gameScreen) gameScreen.classList.add('hidden');
    if (resultsScreen) resultsScreen.classList.add('hidden');
}

// Get a random unused riddle
function getRandomRiddle() {
    // If all riddles have been used, reset the used list
    if (usedRiddles.length >= bibleRiddles.length) {
        usedRiddles = [];
    }
    
    // Get available riddles (not used yet)
    const availableRiddles = bibleRiddles.filter((_, index) => !usedRiddles.includes(index));
    
    if (availableRiddles.length === 0) {
        // Fallback: just pick any random riddle
        const randomIndex = Math.floor(Math.random() * bibleRiddles.length);
        return bibleRiddles[randomIndex];
    }
    
    // Pick a random riddle from available ones
    const randomIndex = Math.floor(Math.random() * availableRiddles.length);
    const riddle = availableRiddles[randomIndex];
    const originalIndex = bibleRiddles.indexOf(riddle);
    
    // Mark as used
    usedRiddles.push(originalIndex);
    
    return riddle;
}

// Start the Riddles Game
function startRiddlesGame() {
    console.log('üé≠ Starting Bible Riddles Game...');
    
    riddleScore = 0;
    riddlesSolved = 0;
    riddleGameActive = true;
    
    const startScreen = document.getElementById('riddles-start-screen');
    const gameScreen = document.getElementById('riddles-game-screen');
    const resultsScreen = document.getElementById('riddles-results-screen');
    
    if (startScreen) startScreen.classList.add('hidden');
    if (gameScreen) gameScreen.classList.remove('hidden');
    if (resultsScreen) resultsScreen.classList.add('hidden');
    
    loadNextRiddle();
}

// Load next riddle
function loadNextRiddle() {
    console.log('üîç Loading next riddle...');
    
    currentRiddle = getRandomRiddle();
    currentClueIndex = 0;
    
    if (!currentRiddle) {
        console.error('‚ùå No riddle found!');
        return;
    }
    
    // Update UI
    const scoreEl = document.getElementById('riddles-score');
    const solvedEl = document.getElementById('riddles-solved-count');
    const questionEl = document.getElementById('riddle-question');
    const cluesEl = document.getElementById('riddle-clues');
    const submitBtn = document.getElementById('riddle-submit-btn');
    const answerInput = document.getElementById('riddle-answer-input');
    const clueBtn = document.getElementById('riddle-clue-btn');
    const skipBtn = document.getElementById('riddle-skip-btn');
    
    if (scoreEl) scoreEl.textContent = riddleScore;
    if (solvedEl) solvedEl.textContent = riddlesSolved;
    if (questionEl) questionEl.textContent = currentRiddle.question;
    if (cluesEl) cluesEl.innerHTML = '<div class="clue-placeholder">Click "Get Clue" for hints...</div>';
    if (answerInput) answerInput.value = '';
    if (submitBtn) submitBtn.disabled = false;
    if (clueBtn) {
        clueBtn.disabled = false;
        clueBtn.textContent = 'Get Clue (0/' + currentRiddle.clues.length + ' used)';
    }
    if (skipBtn) skipBtn.disabled = false;
    
    // Clear any previous feedback
    const feedbackEl = document.getElementById('riddle-feedback');
    if (feedbackEl) {
        feedbackEl.classList.add('hidden');
        feedbackEl.innerHTML = '';
    }
    
    console.log('‚úÖ Riddle loaded:', currentRiddle.answer);
}

// Show next clue
function showNextClue() {
    if (!currentRiddle || currentClueIndex >= currentRiddle.clues.length) {
        return;
    }
    
    const clue = currentRiddle.clues[currentClueIndex];
    const cluesEl = document.getElementById('riddle-clues');
    const clueBtn = document.getElementById('riddle-clue-btn');
    
    if (cluesEl) {
        const clueElement = document.createElement('div');
        clueElement.className = 'clue-item';
        clueElement.textContent = `üí° ${clue}`;
        cluesEl.appendChild(clueElement);
    }
    
    currentClueIndex++;
    
    // Update clue button
    if (clueBtn) {
        if (currentClueIndex >= currentRiddle.clues.length) {
            clueBtn.disabled = true;
            clueBtn.textContent = 'No more clues';
        } else {
            clueBtn.textContent = `Get Clue (${currentClueIndex}/${currentRiddle.clues.length} used)`;
        }
    }
    
    // Deduct points for using clues
    riddleScore = Math.max(0, riddleScore - 2); // -2 points per clue
    updateRiddlesScore();
}

// Submit answer
function submitRiddleAnswer() {
    if (!currentRiddle || !riddleGameActive) return;
    
    const answerInput = document.getElementById('riddle-answer-input');
    const feedbackEl = document.getElementById('riddle-feedback');
    const submitBtn = document.getElementById('riddle-submit-btn');
    const clueBtn = document.getElementById('riddle-clue-btn');
    const skipBtn = document.getElementById('riddle-skip-btn');
    
    if (!answerInput) return;
    
    const userAnswer = answerInput.value.trim().toLowerCase();
    const correctAnswer = currentRiddle.answer.toLowerCase();
    
    // Disable buttons while checking
    if (submitBtn) submitBtn.disabled = true;
    if (clueBtn) clueBtn.disabled = true;
    if (skipBtn) skipBtn.disabled = true;
    
    if (userAnswer === correctAnswer) {
        // Correct answer!
        const basePoints = 10;
        const cluePenalty = currentClueIndex * 2; // -2 points per clue used
        const pointsEarned = Math.max(1, basePoints - cluePenalty); // At least 1 point
        
        riddleScore += pointsEarned;
        riddlesSolved++;
        
        if (feedbackEl) {
            feedbackEl.innerHTML = `
                <div style="color: var(--accent-sage); font-weight: 700; font-size: 1.2rem;">
                    ‚úÖ Correct! +${pointsEarned} points
                </div>
                <div style="font-size: 0.9rem; margin-top: 5px;">
                    Reference: ${currentRiddle.reference}
                </div>
                <div style="font-size: 0.9rem; margin-top: 5px;">
                    ${currentClueIndex > 0 ? `(${currentClueIndex} clues used: -${cluePenalty} points)` : 'Perfect! No clues needed!'}
                </div>
            `;
            feedbackEl.style.background = 'rgba(102, 187, 106, 0.2)';
            feedbackEl.classList.remove('hidden');
        }
        
        // Move to next riddle after delay
        setTimeout(() => {
            loadNextRiddle();
        }, 3000);
        
    } else {
        // Wrong answer
        if (feedbackEl) {
            feedbackEl.innerHTML = `
                <div style="color: #c98986; font-weight: 700; font-size: 1.2rem;">
                    ‚ùå Not quite!
                </div>
                <div style="font-size: 0.9rem; margin-top: 5px;">
                    The answer was: <strong>${currentRiddle.answer}</strong>
                </div>
                <div style="font-size: 0.9rem; margin-top: 5px;">
                    Reference: ${currentRiddle.reference}
                </div>
            `;
            feedbackEl.style.background = 'rgba(201, 137, 134, 0.2)';
            feedbackEl.classList.remove('hidden');
        }
        
        // End game after delay
        setTimeout(() => {
            endRiddlesGame();
        }, 3000);
    }
    
    updateRiddlesScore();
}

// Skip current riddle
function skipRiddle() {
    if (!currentRiddle || !riddleGameActive) return;
    
    const feedbackEl = document.getElementById('riddle-feedback');
    
    if (feedbackEl) {
        feedbackEl.innerHTML = `
            <div style="color: var(--text-muted); font-weight: 700; font-size: 1.2rem;">
                ‚è≠Ô∏è Skipped!
            </div>
            <div style="font-size: 0.9rem; margin-top: 5px;">
                The answer was: <strong>${currentRiddle.answer}</strong>
            </div>
            <div style="font-size: 0.9rem; margin-top: 5px;">
                Reference: ${currentRiddle.reference}
            </div>
        `;
        feedbackEl.style.background = 'rgba(128, 128, 128, 0.2)';
        feedbackEl.classList.remove('hidden');
    }
    
    // Small penalty for skipping
    riddleScore = Math.max(0, riddleScore - 3);
    updateRiddlesScore();
    
    // Move to next riddle after delay
    setTimeout(() => {
        loadNextRiddle();
    }, 2000);
}

// Update score display
function updateRiddlesScore() {
    const scoreEl = document.getElementById('riddles-score');
    const solvedEl = document.getElementById('riddles-solved-count');
    
    if (scoreEl) scoreEl.textContent = riddleScore;
    if (solvedEl) solvedEl.textContent = riddlesSolved;
}

// End the game
function endRiddlesGame() {
    riddleGameActive = false;
    
    const pointsEarned = riddleScore;
    const riddlesCount = riddlesSolved;
    
    // Update user data
    userData.riddlesSolved = (userData.riddlesSolved || 0) + riddlesCount;
    addGamePoints(pointsEarned, 'riddles');
    
    // Update results screen
    const finalScoreEl = document.getElementById('riddles-final-score');
    const solvedCountEl = document.getElementById('riddles-total-solved');
    const pointsEarnedEl = document.getElementById('riddles-points-earned');
    
    if (finalScoreEl) finalScoreEl.textContent = riddleScore;
    if (solvedCountEl) solvedCountEl.textContent = riddlesSolved;
    if (pointsEarnedEl) pointsEarnedEl.textContent = pointsEarned;
    
    document.getElementById('riddles-game-screen').classList.add('hidden');
    document.getElementById('riddles-results-screen').classList.remove('hidden');
}

// Restart game
function restartRiddlesGame() {
    resetRiddlesGame();
    startRiddlesGame();
}

// Reset game state
function resetRiddlesGame() {
    currentRiddle = null;
    riddleScore = 0;
    riddlesSolved = 0;
    currentClueIndex = 0;
    usedRiddles = [];
    riddleGameActive = false;
}

// Handle Enter key in answer input
function handleRiddleKeyPress(event) {
    if (event.key === 'Enter') {
        submitRiddleAnswer();
    }
}
    </script>
    <script>
    (function(){
        // Notes app - local, no external deps
        let notes = [];
        let currentNoteId = null;
        let autosaveTimer = null;

        // Elements
        const notesGridEl = document.getElementById('notes-grid');
        const editorEl = document.getElementById('note-editor');
        const titleEl = document.getElementById('note-title');
        const contentEl = document.getElementById('note-content');
        const newBtn = document.getElementById('notes-new-btn');
        const closeBtn = document.getElementById('notes-close-btn');
        const deleteBtn = document.getElementById('notes-delete-btn');
        const addVerseBtn = document.getElementById('add-verse-btn');
        const verseInput = document.getElementById('verse-input-field');
        const verseChips = document.getElementById('verse-chips');
        const autosaveIndicator = document.getElementById('notes-autosave');
    const highlightBtn = document.getElementById('notes-highlight-btn');
    const exitBtn = document.getElementById('notes-exit-x');
    const highlightSwatches = Array.from(document.querySelectorAll('.highlight-swatch'));

        // Basic utility
        async function saveToStorage(){
            try {
                if (!db) await initDB();
                for (const note of notes) {
                    await dbSet('notes', note);
                }
                console.log('‚úÖ Notes saved to IndexedDB');
            } catch (error) {
                console.error('Error saving notes:', error);
            }
        }

        async function loadFromStorage(){
            try{
                if (!db) await initDB();
                const tx = db.transaction('notes', 'readonly');
                const store = tx.objectStore('notes');
                return new Promise((resolve) => {
                    const request = store.getAll();
                    request.onsuccess = () => {
                        notes = request.result || [];
                        resolve();
                    };
                    request.onerror = () => {
                        console.error('Error loading notes:', request.error);
                        notes = [];
                        resolve();
                    };
                });
            }catch(e){ 
                console.error('Error loading from IndexedDB:', e);
                notes = []; 
            }
        }

        function formatDate(iso){
            try{ const d = new Date(iso); return d.toLocaleString(); }catch(e){ return iso; }
        }

        function renderNotesGrid(){
            if(!notesGridEl) return;
            if(notes.length === 0){
                notesGridEl.innerHTML = `<div class="card text-center"> <h3 class="card-title">No notes yet</h3><p class="card-description">Create your first note.</p></div>`;
                return;
            }

            notesGridEl.innerHTML = notes.map(n => `
                <div class="card note-card" data-id="${n.id}">
                    <div class="note-title">${escapeHtml(n.title || 'Untitled')}</div>
                    <div class="note-date">${formatDate(n.date)}</div>
                    <div class="note-excerpt">${n.contentHtml ? n.contentHtml : escapeHtml((n.contentText||'')).slice(0,300)}</div>
                    <div class="note-tags">${(n.verses||[]).map(v => `<div class="note-tag">${escapeHtml(v)}</div>`).join('')}</div>
                </div>
            `).join('');

            // attach click
            document.querySelectorAll('.note-card').forEach(el=>{
                el.addEventListener('click', ()=>{
                    const id = el.getAttribute('data-id');
                    openEditor(id);
                });
            });
        }

        function escapeHtml(str){
            if(!str) return '';
            return str.replace(/[&<>"']/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]; });
        }

        function newNote(){
            const id = 'note-' + Date.now() + '-' + Math.random().toString(36).slice(2,8);
            const n = { id, title:'', contentText:'', contentHtml:'', verses:[], date:new Date().toISOString() };
            notes.unshift(n);
            saveToStorage();
            renderNotesGrid();
            openEditor(id);
        }

        function openEditor(id){
            currentNoteId = id;
            const n = notes.find(x=>x.id===id);
            if(!n) return;
            titleEl.value = n.title || '';
            contentEl.innerHTML = n.contentHtml || escapeHtml(n.contentText || '');
            renderVerseChips(n.verses||[]);
            editorEl.classList.add('active');
            editorEl.setAttribute('aria-hidden','false');
            autosaveIndicator.textContent = 'Saved';
        }

        function closeEditor(){
            editorEl.classList.remove('active');
            editorEl.setAttribute('aria-hidden','true');
            currentNoteId = null;
        }

        function deleteCurrentNote(){
            if(!currentNoteId) return;
            if(!confirm('Delete this note?')) return;
            notes = notes.filter(n=>n.id !== currentNoteId);
            saveToStorage();
            renderNotesGrid();
            closeEditor();
        }

        function renderVerseChips(list){
            verseChips.innerHTML = list.map(v => `<div class="verse-chip">${escapeHtml(v)} <button data-verse="${escapeHtml(v)}" style="border:none;background:transparent;margin-left:6px;cursor:pointer;color:var(--text-muted)">‚úï</button></div>`).join('');
            // attach remove handlers
            verseChips.querySelectorAll('button[data-verse]').forEach(btn=>{
                btn.addEventListener('click', (e)=>{
                    const v = btn.getAttribute('data-verse');
                    const note = notes.find(n=>n.id===currentNoteId);
                    if(!note) return;
                    note.verses = (note.verses||[]).filter(x=>x!==v);
                    note.date = new Date().toISOString();
                    saveToStorage();
                    renderVerseChips(note.verses||[]);
                    renderNotesGrid();
                });
            });
        }

        function addVerseToCurrent(v){
            if(!v) return;
            const note = notes.find(n=>n.id===currentNoteId);
            if(!note) return alert('No note open');
            note.verses = note.verses || [];
            if(note.verses.length >= 3) return alert('You can attach up to 3 verses');
            // simple normalization
            v = v.trim();
            if(!v) return;
            if(note.verses.includes(v)) return;
            note.verses.push(v);
            note.date = new Date().toISOString();
            saveToStorage();
            renderVerseChips(note.verses);
            renderNotesGrid();
        }

        // Autosave with debounce
        function scheduleAutosave(){
            autosaveIndicator.textContent = 'Saving...';
            if(autosaveTimer) clearTimeout(autosaveTimer);
            autosaveTimer = setTimeout(()=>{
                if(!currentNoteId) { autosaveIndicator.textContent='Saved'; return; }
                const note = notes.find(n=>n.id===currentNoteId);
                if(!note) return;
                note.title = titleEl.value.trim() || 'Untitled';
                note.contentText = contentEl.innerText || '';
                note.contentHtml = contentEl.innerHTML || '';
                note.date = new Date().toISOString();
                saveToStorage();
                autosaveIndicator.textContent = 'Saved';
                renderNotesGrid();
            }, 700);
        }

        // Basic formatting commands
        document.querySelectorAll('.editor-toolbar button[data-cmd]').forEach(btn=>{
            btn.addEventListener('click', ()=>{
                const cmd = btn.getAttribute('data-cmd');
                if(cmd==='bold') document.execCommand('bold');
                if(cmd==='italic') document.execCommand('italic');
                scheduleAutosave();
                contentEl.focus();
            });
        });

        // Helper: safely wrap a Range's contents in an element
        function safeWrapRange(range, className){
            try{
                const wrapper = document.createElement('span');
                wrapper.className = className;
                // extract the selected contents and append into the wrapper
                const extracted = range.extractContents();
                wrapper.appendChild(extracted);
                // insert the wrapper node where the range was
                range.insertNode(wrapper);
                // normalize to merge text nodes
                wrapper.normalize();
                return wrapper;
            }catch(e){
                console.warn('safeWrapRange failed', e);
                return null;
            }
        }

        // Attach handlers to each solid color swatch
        highlightSwatches.forEach(btn => {
            btn.addEventListener('click', ()=>{
                const color = btn.getAttribute('data-color') || '#f6d55c';
                const sel = window.getSelection();
                if(!sel || sel.isCollapsed) return alert('Select text to highlight');
                const range = sel.getRangeAt(0);
                if(!contentEl.contains(range.commonAncestorContainer)) return alert('Select text inside the note content');
                const wrapped = safeWrapRange(range, 'note-highlight');
                if(wrapped){
                    wrapped.style.background = color;
                    // ensure there's a caret after the wrapped node
                    const after = document.createTextNode('');
                    wrapped.parentNode.insertBefore(after, wrapped.nextSibling);
                    const newRange = document.createRange();
                    newRange.setStartAfter(after);
                    newRange.collapse(true);
                    sel.removeAllRanges();
                    sel.addRange(newRange);
                }
                scheduleAutosave();
                contentEl.focus();
            });
        });

        // events
    newBtn && newBtn.addEventListener('click', newNote);
    closeBtn && closeBtn.addEventListener('click', closeEditor);
    exitBtn && exitBtn.addEventListener('click', closeEditor);
    // New close editor button below verse controls
    const closeEditorBtn = document.getElementById('notes-close-editor-btn');
    closeEditorBtn && closeEditorBtn.addEventListener('click', ()=>{
        // ensure current note is autosaved before closing
        scheduleAutosave();
        closeEditor();
    });
        deleteBtn && deleteBtn.addEventListener('click', deleteCurrentNote);
        addVerseBtn && addVerseBtn.addEventListener('click', ()=>{
            const v = verseInput.value.trim();
            if(!v) return;
            addVerseToCurrent(v);
            verseInput.value = '';
        });

        // enter key in verse input
        verseInput && verseInput.addEventListener('keypress', (e)=>{ if(e.key === 'Enter'){ addVerseBtn.click(); e.preventDefault(); } });

        // listen for typing in editor
        contentEl && contentEl.addEventListener('input', scheduleAutosave);
        titleEl && titleEl.addEventListener('input', scheduleAutosave);

        // open last note if exists
        function init(){
            loadFromStorage();
            renderNotesGrid();
            // if there is at least one note, show none; user can open
        }

        // expose for debugging
        window.notesApp = { newNote, openEditor, closeEditor, renderNotesGrid };

        init();
    })();

 

// Fun Facts Game Variables
let discoveredFacts = [];
let currentFact = null;

// Show Fun Facts Modal
function showFunFacts() {
    // Render fun facts into the full page section and navigate there
    const section = document.getElementById('fun-facts-section');
    if (!section) {
        console.error('Fun Facts section not found, falling back to modal');
        const modal = document.getElementById('fun-facts-modal');
        if (!modal) return;
        loadDiscoveredFacts(); showRandomFact(); modal.classList.add('active');
        return;
    }

    // Initialize and display
    loadDiscoveredFacts();
    showRandomFact();
    showSection('fun-facts-section');
}

// Hide Fun Facts Modal
function hideFunFacts() {
    // Return to activities page
    showSection('activities-section');
}

// Open glossary as a full-page section (replaces glossary modal UX)
function showGlossary() {
    const section = document.getElementById('glossary-section');
    if (!section) {
        // fallback to modal if section not present
        const modal = document.getElementById('glossary-modal');
        if (modal) modal.classList.add('active');
        return;
    }

    showSection('glossary-section');

    // Attempt to trigger existing glossary population functions (loaded from glossary_functions.js)
    if (typeof filterGlossaryByLetter === 'function') {
        try { filterGlossaryByLetter('all'); } catch (e) { console.error('filterGlossaryByLetter failed', e); }
    } else if (typeof searchGlossary === 'function') {
        try { searchGlossary(); } catch (e) { console.error('searchGlossary failed', e); }
    } else {
        console.warn('No glossary population function found (filterGlossaryByLetter/searchGlossary)');
    }
}


async function loadDiscoveredFacts() {
    try {
        if (!db) await initDB();
        const saved = await dbGet('discoveredFacts', 'all');
        discoveredFacts = saved?.list || [];
    } catch (e) {
        console.error('Error loading discovered facts:', e);
        discoveredFacts = [];
    }
    updateFunFactsCount();
}

// Save discovered facts to IndexedDB
async function saveDiscoveredFacts() {
    try {
        if (!db) await initDB();
        await dbSet('discoveredFacts', { id: 'all', list: discoveredFacts });
    } catch (e) {
        console.error('Failed to save discovered facts:', e);
    }
}

// Get a random fact that hasn't been discovered recently
function getRandomFact() {
    // If all facts have been discovered, just pick any random one
    if (discoveredFacts.length >= bibleFunFacts.length) {
        const randomIndex = Math.floor(Math.random() * bibleFunFacts.length);
        return bibleFunFacts[randomIndex];
    }
    
    // Get facts that haven't been discovered yet
    const availableFacts = bibleFunFacts.filter(fact => 
        !discoveredFacts.includes(fact.title)
    );
    
    if (availableFacts.length === 0) {
        // Fallback: pick any random fact
        const randomIndex = Math.floor(Math.random() * bibleFunFacts.length);
        return bibleFunFacts[randomIndex];
    }
    
    // Pick a random fact from available ones
    const randomIndex = Math.floor(Math.random() * availableFacts.length);
    return availableFacts[randomIndex];
}

// Show a random fact
function showRandomFact() {
    currentFact = getRandomFact();
    
    if (!currentFact) {
        console.error('No fact found!');
        return;
    }
    
    // Update UI
    const emojiEl = document.getElementById('fact-emoji');
    const titleEl = document.getElementById('fun-fact-title');
    const contentEl = document.getElementById('fun-fact-content');
    const referenceEl = document.getElementById('fun-fact-reference');
    
    if (emojiEl) emojiEl.textContent = currentFact.emoji;
    if (titleEl) titleEl.textContent = currentFact.title;
    if (contentEl) contentEl.textContent = currentFact.content;
    if (referenceEl) referenceEl.textContent = currentFact.reference;

    // Update history
    updateFactsHistory();
}

// Update the facts count display
function updateFunFactsCount() {
    const countEl = document.getElementById('fun-facts-count');
    if (countEl) {
        countEl.textContent = discoveredFacts.length;
        
        // Show/hide history based on whether we have discovered facts
        const historyEl = document.getElementById('fun-facts-history');
        if (historyEl) {
            if (discoveredFacts.length > 0) {
                historyEl.classList.remove('hidden');
            } else {
                historyEl.classList.add('hidden');
            }
        }
    }
}

// Update facts history list
function updateFactsHistory() {
    const historyList = document.getElementById('facts-history-list');
    if (!historyList) return;
    
    // Show last 5 discovered facts
    const recentFacts = [...discoveredFacts].reverse().slice(0, 5);
    
    if (recentFacts.length === 0) {
        historyList.innerHTML = '<div class="text-muted">No facts discovered yet!</div>';
        return;
    }
    
    historyList.innerHTML = recentFacts.map(factTitle => {
        const fact = bibleFunFacts.find(f => f.title === factTitle);
        if (!fact) return '';
        
        return `
            <div class="fact-history-item">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.2rem;">${fact.emoji}</span>
                    <div>
                        <div style="font-weight: 600;">${fact.title}</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">${fact.category}</div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Initialize fun facts when app loads
function initializeFunFacts() {
    loadDiscoveredFacts();
}

// --- ORIGINAL WORDS (daily) ---
async function loadOriginalWordsData() {
    try {
        const res = await fetch('original_words.json');
        if (!res.ok) throw new Error('Failed to load original_words.json');
        const json = await res.json();
        return json.biblicalWords || {};
    } catch (err) {
        console.error('Error loading original words data:', err);
        return {};
    }
}

function flattenOriginalWords(bibWords) {
    const out = [];
    if (!bibWords) return out;
    Object.keys(bibWords).forEach(lang => {
        const arr = bibWords[lang] || [];
        arr.forEach(item => out.push(Object.assign({}, item, { language: lang })));
    });
    return out;
}

function getDayIndex(total) {
    const days = Math.floor(Date.now() / 86400000); // days since epoch
    return total ? (days % total) : 0;
}

async function initializeOriginalWords() {
    try {
        const bibWords = await loadOriginalWordsData();
        const all = flattenOriginalWords(bibWords);
        window._originalWordsAll = all;
        const daily = all.length ? all[getDayIndex(all.length)] : null;
        showOriginalWord(daily);

        // Refresh at midnight and thereafter every 24h
        const now = new Date();
        const msUntilMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1) - now;
        setTimeout(() => {
            const next = all.length ? all[getDayIndex(all.length)] : null;
            showOriginalWord(next);
            setInterval(() => {
                const today = all.length ? all[getDayIndex(all.length)] : null;
                showOriginalWord(today);
            }, 24 * 60 * 60 * 1000);
        }, msUntilMidnight + 2000);

        // Manual refresh to the next entry (wraps)
        const refreshBtn = document.getElementById('original-word-refresh');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                if (!all.length) return;
                const idx = getDayIndex(all.length);
                const next = all[(idx + 1) % all.length];
                showOriginalWord(next);
            });
        }
    } catch (err) {
        console.error('Failed to initialize Original Words:', err);
    }
}

function showOriginalWord(wordObj) {
    const langEl = document.getElementById('original-word-language');
    const wordEl = document.getElementById('original-word-word');
    const translitEl = document.getElementById('original-word-translit');
    const meaningEl = document.getElementById('original-word-meaning');
    const refEl = document.getElementById('original-word-ref');

    if (!wordObj) {
        if (langEl) langEl.textContent = 'Original Words';
        if (wordEl) wordEl.textContent = '‚Äî';
        if (translitEl) translitEl.textContent = '';
        if (meaningEl) meaningEl.textContent = 'No data available.';
        if (refEl) refEl.textContent = '';
        return;
    }

    if (langEl) langEl.textContent = (wordObj.language || '').charAt(0).toUpperCase() + (wordObj.language || '').slice(1);
    if (wordEl) {
        wordEl.textContent = wordObj.word || '';
        // set direction for languages like Hebrew
        wordEl.dir = (wordObj.language === 'hebrew') ? 'rtl' : 'auto';
    }
    if (translitEl) translitEl.textContent = wordObj.transliteration || '';
    if (meaningEl) meaningEl.textContent = wordObj.meaning || '';
    if (refEl) refEl.textContent = wordObj.primaryReference || '';
}


// Initialize Bible section with John 1 by default
// Initialize Bible section with John 1 by default
async function initializeBibleSection() {
    console.log('üöÄ Initializing Bible section...');
    
    // Wait for preloading to complete
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // Try to load last read position from IndexedDB
    try {
        if (!db) await initDB();
        const lastRead = await dbGet('settings', 'lastBibleRead');
        if (lastRead) {
            const { bookId, chapter } = lastRead.value;
            const book = bibleBooks.find(b => b.id === bookId);
            if (book && chapter <= book.chapters) {
                console.log(`üìñ Loading last read: ${book.title} ${chapter}`);
                await loadChapterDirectly(book, chapter);
                return;
            }
        }
    } catch (e) {
        console.log('No valid last read position found');
    }
    
    // Default to John 1 (first time only)
    const defaultBook = bibleBooks.find(b => b.id === 'john');
    if (defaultBook) {
        console.log(`üìñ Loading default: John 1`);
        
        // Ensure chapter 1 of John is available (lazy-load only chapter 1)
        if (!bibleChapterCache.kjv['John'] || !bibleChapterCache.kjv['John'][1]) {
            console.log('üîÑ Preloading John chapter 1...');
            const johnChapter = await loadBibleChapter('John', 1).catch(() => null);
            if (!johnChapter) {
                console.error('‚ùå Failed to load John chapter 1');
                return;
            }
            console.log('‚úÖ John chapter 1 loaded successfully');
        }
        
        await loadChapterDirectly(defaultBook, 1);
    } else {
        console.error('‚ùå John book not found in bibleBooks');
    }
}

// Load a chapter directly
async function loadChapterDirectly(book, chapter) {
    currentBook = book;
    currentChapter = chapter;
    
    // Always show bible content
    document.getElementById('bible-content').classList.remove('hidden');
    
    // Update navigation button
    updateBibleNavDisplay();
    document.getElementById('bible-nav-button').classList.remove('hidden');
    
    // Load the verses - make sure it's async
    await loadVerses(book.id, chapter);
    
    // Save as last read position to IndexedDB
    try {
        if (!db) await initDB();
        await dbSet('settings', {
            key: 'lastBibleRead',
            value: { bookId: book.id, chapter: chapter }
        });
    } catch (error) {
        console.error('Error saving last Bible read position:', error);
    }
}



// Update the navigation button display
function updateBibleNavDisplay() {
    const display = document.getElementById('current-chapter-display');
    if (display && currentBook) {
        display.textContent = `${currentBook.title} ${currentChapter}`;
    }
}

// Toggle the book/chapter selector
function toggleBibleSelector() {
    const overlay = document.getElementById('bible-selector-overlay');
    const btn = document.querySelector('.bible-nav-btn');
    
    if (overlay.classList.contains('active')) {
        closeBibleSelector();
        btn.classList.remove('open');
    } else {
        openBibleSelector();
        btn.classList.add('open');
    }
}

function openBibleSelector() {
    const overlay = document.getElementById('bible-selector-overlay');
    overlay.classList.remove('hidden');
    overlay.classList.add('active');
    populateSelectorBooks();
}

function closeBibleSelector() {
    const overlay = document.getElementById('bible-selector-overlay');
    const btn = document.querySelector('.bible-nav-btn');
    overlay.classList.remove('active');
    btn.classList.remove('open');
    
    // Small delay before hiding completely
    setTimeout(() => {
        overlay.classList.add('hidden');
    }, 300);
}

function backToBookSelection() {
    const chaptersGrid = document.getElementById('selector-chapters-grid');
    const booksList = document.getElementById('selector-books-list');
    chaptersGrid.style.display = 'none';
    booksList.style.display = 'grid';
}

// Populate books in selector
function populateSelectorBooks() {
    const container = document.getElementById('selector-books-list');
    const chaptersGrid = document.getElementById('selector-chapters-grid');
    const title = document.getElementById('selector-title');
    
    title.textContent = 'Select Book';
    container.classList.remove('hidden');
    chaptersGrid.classList.add('hidden');
    
    container.innerHTML = bibleBooks.map(book => `
        <div class="selector-book-item" onclick="showSelectorChapters('${book.id}')">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 1.5rem;">${book.emoji}</span>
                <div>
                    <div style="font-weight: 700;">${book.title}</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">${book.chapters} chapters ‚Ä¢ ${book.description}</div>
                </div>
            </div>
        </div>
    `).join('');
}

// Show chapters for selected book in selector
function showSelectorChapters(bookId) {
    const book = bibleBooks.find(b => b.id === bookId);
    if (!book) return;
    
    const container = document.getElementById('selector-books-list');
    const chaptersGrid = document.getElementById('selector-chapters-grid');
    const title = document.getElementById('selector-title');
    
    title.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <button onclick="populateSelectorBooks()" style="background: transparent; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-secondary); padding: 5px;">‚Üê</button>
            <span>${book.title} - Select Chapter</span>
        </div>
    `;
    
    container.classList.add('hidden');
    chaptersGrid.classList.remove('hidden');
    
    let chaptersHTML = '';
    for (let i = 1; i <= book.chapters; i++) {
        chaptersHTML += `
            <button class="selector-chapter-btn" onclick="selectChapterInSelector('${book.id}', ${i})">
                ${i}
            </button>
        `;
    }
    
    chaptersGrid.innerHTML = chaptersHTML;
}

// Select chapter from selector
function selectChapterInSelector(bookId, chapterNum) {
    const book = bibleBooks.find(b => b.id === bookId);
    if (!book) return;
    
    // Load the selected chapter
    loadChapterDirectly(book, chapterNum);
    
    // Close the selector
    closeBibleSelector();
}

// Update the book grid to use the new system
function populateBibleBooks() {
    const booksGrid = document.getElementById('books-grid');
    if (!booksGrid) return;

    booksGrid.innerHTML = '';
    
    bibleBooks.forEach(book => {
        const bookElement = document.createElement('div');
        bookElement.className = 'book-item card';
        if (book.testament) bookElement.setAttribute('data-testament', book.testament);
        bookElement.onclick = () => loadChapterDirectly(book, 1); // Start at chapter 1
        
        bookElement.innerHTML = `
            <div class="book-title">${book.emoji} ${book.title}</div>
            <div class="book-meta">${book.chapters} chapters</div>
            <div class="book-description">${book.description}</div>
        `;
        
        booksGrid.appendChild(bookElement);
    });
}







    </script>

    <!-- Achievements modal: created/ensured by script below if missing -->
    <div id="achievements-modal" class="modal" style="display:none;" aria-hidden="true">
        <div class="modal-content" style="max-width:560px;">
            <div class="modal-header">
                <h2>Achievements üèÖ</h2>
                <button class="close-btn" data-action="close-achievements">√ó</button>
            </div>
            <div class="modal-body" id="achievements-modal-body">
                <p class="card-description">No achievements yet ‚Äî play games or complete challenges to earn badges and climb the leaderboard!</p>
            </div>
        </div>
    </div>

    <script>
    /* ==== Security helpers and achievement/leaderboard system ==== */
    (function(){
        'use strict';

        // Basic HTML escaping for outputs (defensive, prevents XSS via text insertion)
        function escapeHtml(str){
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // Sanitize a user-provided input string: remove script tags and escape html
        function sanitizeInputValue(s){
            if (s === null || s === undefined) return '';
            // Remove any script tags (even if someone tries to obfuscate)
            s = String(s).replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, '');
            // Strip on* attributes patterns (defensive) ‚Äî applied where innerHTML could be used later
            s = s.replace(/on\w+\s*=\s*['\"][^'\"]*['\"]/gi, '');
            // Escape remaining HTML
            return escapeHtml(s);
        }

        // Safely set textual content (never uses innerHTML)
        function safeSetText(el, text){
            if (!el) return;
            el.textContent = sanitizeInputValue(text);
        }

        // Sanitize form submissions: sanitize all text-like inputs before any script handles them
        document.addEventListener('submit', function(e){
            try{
                var form = e.target;
                if (!form || !form.elements) return;
                Array.from(form.elements).forEach(function(el){
                    if (!el) return;
                    var tag = el.tagName && el.tagName.toLowerCase();
                    var type = el.type && el.type.toLowerCase();
                    if (tag === 'input' && (type === 'text' || type === 'search' || type === 'email' || type === 'tel' || type === 'url' || type === 'password')){
                        el.value = sanitizeInputValue(el.value);
                    } else if (tag === 'textarea'){
                        el.value = sanitizeInputValue(el.value);
                    }
                });
            }catch(err){ console.warn('Sanitizer (submit) error', err); }
        }, true);

        // Intercept paste into inputs and contenteditable to strip HTML
        document.addEventListener('paste', function(e){
            try{
                var target = e.target;
                if (!target) return;
                var tag = target.tagName && target.tagName.toLowerCase();
                if (tag === 'input' || tag === 'textarea' || target.isContentEditable){
                    e.preventDefault();
                    var text = (e.clipboardData || window.clipboardData).getData('text') || '';
                    var sanitized = sanitizeInputValue(text);
                    // Insert text at cursor
                    if (document.queryCommandSupported('insertText')){
                        document.execCommand('insertText', false, sanitized);
                    } else {
                        // fallback
                        var start = target.selectionStart || 0;
                        var end = target.selectionEnd || 0;
                        var val = target.value || '';
                        target.value = val.slice(0, start) + sanitized + val.slice(end);
                    }
                }
            }catch(err){ /* swallow */ }
        }, true);

        // Create or ensure achievements modal exists and attach click-to-close safely
        function ensureAchievementsModal(){
            var modal = document.getElementById('achievements-modal');
            if (!modal){
                console.info('achievements-modal element not found; creating one now');
                modal = document.createElement('div');
                modal.id = 'achievements-modal';
                modal.className = 'modal';
                modal.style.display = 'none';
                modal.innerHTML = '<div class="modal-content" style="max-width:560px;"><div class="modal-header"><h2>Achievements üèÖ</h2><button class="close-btn" data-action="close-achievements">√ó</button></div><div class="modal-body" id="achievements-modal-body"><p class="card-description">No achievements yet.</p></div></div>';
                document.body.appendChild(modal);
            }

            // Attach a safe click-to-close handler if not already attached
            if (!modal._achievementsHandlerAttached){
                modal._achievementsHandlerAttached = true;
                modal.addEventListener('click', function(ev){
                    // close when clicking the overlay (but not when clicking inside modal-content)
                    var content = modal.querySelector('.modal-content');
                    if (!content) return;
                    if (!content.contains(ev.target) || ev.target.getAttribute && ev.target.getAttribute('data-action') === 'close-achievements'){
                        try{ modal.style.display = 'none'; modal.setAttribute('aria-hidden','true'); }catch(e){}
                    }
                });
            }
            return modal;
        }

        // Leaderboard storage helpers
        function getLeaderboardData(){
            try{
                var raw = localStorage.getItem('leaderboardData');
                if (!raw) return sampleLeaderboard();
                var data = JSON.parse(raw);
                if (!Array.isArray(data)) return sampleLeaderboard();
                return data;
            }catch(err){ return sampleLeaderboard(); }
        }

        function saveLeaderboardData(data){
            try{ localStorage.setItem('leaderboardData', JSON.stringify(data)); }catch(err){ console.warn('Could not save leaderboard', err); }
        }

        function sampleLeaderboard(){
            return [
                {id:'user-2', name:'Alice', points:120},
                {id:'user-3', name:'Bob', points:80},
                {id:'user-1', name:'Friend', points:0}
            ];
        }

        // Render leaderboard and update user rank placeholders
        function updateLeaderboardUI(){
            try{
                var data = getLeaderboardData();
                // sort descending
                data.sort(function(a,b){ return (b.points||0) - (a.points||0); });

                var container = document.getElementById('leaderboard-page-container');
                if (container){
                    container.innerHTML = data.map(function(u, i){
                        return '<div class="card" style="display:flex; justify-content:space-between; align-items:center; padding:10px; margin-bottom:8px;">'
                            + '<div><div style="font-weight:700;">' + escapeHtml(u.name) + '</div><div style="font-size:0.85rem;color:var(--text-muted);">#' + (i+1) + '</div></div>'
                            + '<div style="font-weight:800;color:var(--accent-gold)">' + (u.points||0) + '</div></div>';
                    }).join('');
                }

                // Update top profile placeholders
                var currentUserId = localStorage.getItem('currentUserId') || 'user-1';
                var idx = data.findIndex(function(x){ return x.id === currentUserId; });
                var user = data.find(function(x){ return x.id === currentUserId; }) || {id:currentUserId, name:'Friend', points:0};
                var rankText = (idx >= 0) ? (idx + 1) : '‚Äî';
                var elRank = document.getElementById('leaderboard-user-rank'); if (elRank) elRank.textContent = rankText;
                var elPoints = document.getElementById('leaderboard-user-points'); if (elPoints) elPoints.textContent = user.points || 0;
                var elName = document.getElementById('leaderboard-user-name'); if (elName) elName.textContent = user.name || 'Friend';
                var elProfileRank = document.getElementById('profile-rank'); if (elProfileRank) elProfileRank.textContent = rankText;
                var elPointsDisplay = document.getElementById('user-points-display'); if (elPointsDisplay) elPointsDisplay.textContent = user.points || 0;
            }catch(err){ console.warn('updateLeaderboardUI error', err); }
        }

        // Adds points to a user and returns updated info {id, points, rank}
        function addLeaderboardPoints(userId, points){
            try{
                if (!userId) userId = localStorage.getItem('currentUserId') || 'user-1';
                var data = getLeaderboardData();
                var u = data.find(function(x){ return x.id === userId; });
                if (!u){ u = { id: userId, name: 'Player', points: 0 }; data.push(u); }
                u.points = (u.points || 0) + Number(points || 0);
                // sort and persist
                data.sort(function(a,b){ return (b.points||0) - (a.points||0); });
                saveLeaderboardData(data);
                updateLeaderboardUI();
                var rank = data.findIndex(function(x){ return x.id === userId; }) + 1;
                return { id: u.id, points: u.points, rank: rank };
            }catch(err){ console.warn('addLeaderboardPoints error', err); return null; }
        }

        // Expose to global scope for other scripts to call when games award points
        window.zc = window.zc || {};
        window.zc.addLeaderboardPoints = addLeaderboardPoints;
        window.zc.updateLeaderboardUI = updateLeaderboardUI;
        window.zc.sanitizeInputValue = sanitizeInputValue;
        window.zc.safeSetText = safeSetText;

        // Ensure achievements modal and attach handler
        document.addEventListener('DOMContentLoaded', function(){
            try{
                ensureAchievementsModal();
                updateLeaderboardUI();
                console.info('Achievements and leaderboard systems initialized');
            }catch(err){ console.warn('Initialization error', err); }
        });

        // Quick debug helper: if console previously reported missing handler, now attach and report
        if (!document.getElementById('achievements-modal')){
            console.warn('script: achievements-modal element not found; creating and attaching handler now');
            // created on DOMContentLoaded via ensureAchievementsModal
        } else {
            ensureAchievementsModal();
        }

    })();
    </script>

</body>
</html>